"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6862],{177:function(e,t,i){i.d(t,{A_:function(){return O},D5:function(){return rc},DX:function(){return eG},G9:function(){return rm},Hn:function(){return re},ID:function(){return w},KU:function(){return ri},Mq:function(){return R},Pk:function(){return ib},Po:function(){return e5},QR:function(){return rP},Qj:function(){return eq},Rf:function(){return iO},Ux:function(){return Q},W_:function(){return e4},X5:function(){return t5},YG:function(){return F},Yc:function(){return t8},dK:function(){return eL},dM:function(){return rr},e6:function(){return to},iE:function(){return tp},jH:function(){return tY},jP:function(){return iD},pG:function(){return eI},qZ:function(){return eW},r7:function(){return J},tn:function(){return eZ},uz:function(){return ie},vt:function(){return rA},xO:function(){return k},yj:function(){return rn},zz:function(){return rp}});var r=i(2171),n=i(1214),s=i(6627),o=i(7632),a=i(6499),l=i(8133),h=i(4519),u=i(2354),d=i(7288),c=i(2416),f=i(4364),m=i(9300),g=i(1561);let p=new WeakMap,_=!1;function w({view:e,element:t,text:i,isDirectHost:n=!0,keepOnFocus:s=!1}){let o=e.document;function a(i){p.get(o).set(t,{text:i,isDirectHost:n,keepOnFocus:s,hostElement:n?t:null}),e.change(e=>b(o,e))}p.has(o)||(p.set(o,new Map),o.registerPostFixer(e=>b(o,e)),o.on("change:isComposing",()=>{e.change(e=>b(o,e))},{priority:"high"})),t.is("editableElement")&&t.on("change:placeholder",(e,t,i)=>{a(i)}),t.placeholder?a(t.placeholder):i&&a(i),i&&(_||(0,r.KE)("enableplaceholder-deprecated-text-option"),_=!0)}function b(e,t){let i=p.get(e),r=[],n=!1;for(let[e,s]of i)s.isDirectHost&&(r.push(e),y(t,e,s)&&(n=!0));for(let[e,s]of i){if(s.isDirectHost)continue;let i=function(e){if(e.childCount){let t=e.getChild(0);if(t.is("element")&&!t.is("uiElement")&&!t.is("attributeElement"))return t}return null}(e);!(!i||r.includes(i))&&(s.hostElement=i,y(t,e,s)&&(n=!0))}return n}function y(e,t,i){let{text:r,isDirectHost:n,hostElement:s}=i,o=!1;return(s.getAttribute("data-placeholder")!==r&&(e.setAttribute("data-placeholder",r,s),o=!0),(n||1==t.childCount)&&function(e,t){if(!e.isAttached()||Array.from(e.getChildren()).some(e=>!e.is("uiElement")))return!1;let i=e.document,r=i.selection.anchor;return(!i.isComposing||!r||r.parent!==e)&&(!!t||!i.isFocused||!!r&&r.parent!==e)}(s,i.keepOnFocus))?!s.hasClass("ck-placeholder")&&(e.addClass("ck-placeholder",s),1)&&(o=!0):s.hasClass("ck-placeholder")&&(e.removeClass("ck-placeholder",s),1)&&(o=!0),o}let v=class{is(){throw Error("is() method is abstract")}},P=class extends(0,r.ln)(v){document;parent;constructor(e){super(),this.document=e,this.parent=null}get index(){let e;if(!this.parent)return null;if(-1==(e=this.parent.getChildIndex(this)))throw new r.Bb("view-node-not-found-in-parent",this);return e}get nextSibling(){let e=this.index;return null!==e&&this.parent.getChild(e+1)||null}get previousSibling(){let e=this.index;return null!==e&&this.parent.getChild(e-1)||null}get root(){let e=this;for(;e.parent;)e=e.parent;return e}isAttached(){return this.root.is("rootElement")}getPath(){let e=[],t=this;for(;t.parent;)e.unshift(t.index),t=t.parent;return e}getAncestors(e={}){let t=[],i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}getCommonAncestor(e,t={}){let i=this.getAncestors(t),r=e.getAncestors(t),n=0;for(;i[n]==r[n]&&i[n];)n++;return 0===n?null:i[n-1]}isBefore(e){if(this==e||this.root!==e.root)return!1;let t=this.getPath(),i=e.getPath(),n=(0,r.Rt)(t,i);switch(n){case"prefix":return!0;case"extension":return!1;default:return t[n]<i[n]}}isAfter(e){return this!=e&&this.root===e.root&&!this.isBefore(e)}_remove(){this.parent._removeChildren(this.index)}_fireChange(e,t){this.fire(`change:${e}`,t),this.parent&&this.parent._fireChange(e,t)}toJSON(){let e=(0,n.Z)(this);return delete e.parent,e}};P.prototype.is=function(e){return"node"===e||"view:node"===e};let A=class e extends P{_textData;constructor(e,t){super(e),this._textData=t}get data(){return this._textData}get _data(){return this.data}set _data(e){this._fireChange("text",this),this._textData=e}isSimilar(t){return t instanceof e&&(this===t||this.data===t.data)}_clone(){return new e(this.document,this.data)}};A.prototype.is=function(e){return"$text"===e||"view:$text"===e||"text"===e||"view:text"===e||"node"===e||"view:node"===e};let C=class extends v{textNode;data;offsetInText;constructor(e,t,i){if(super(),this.textNode=e,t<0||t>e.data.length)throw new r.Bb("view-textproxy-wrong-offsetintext",this);if(i<0||t+i>e.data.length)throw new r.Bb("view-textproxy-wrong-length",this);this.data=e.data.substring(t,t+i),this.offsetInText=t}get offsetSize(){return this.data.length}get isPartial(){return this.data.length!==this.textNode.data.length}get parent(){return this.textNode.parent}get root(){return this.textNode.root}get document(){return this.textNode.document}getAncestors(e={}){let t=[],i=e.includeSelf?this.textNode:this.parent;for(;null!==i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}};C.prototype.is=function(e){return"$textProxy"===e||"view:$textProxy"===e||"textProxy"===e||"view:textProxy"===e};class k{_patterns=[];constructor(...e){this.add(...e)}add(...e){for(let t of e)("string"==typeof t||t instanceof RegExp)&&(t={name:t}),this._patterns.push(t)}match(...e){for(let t of e)for(let e of this._patterns){let i=S(t,e);if(i)return{element:t,pattern:e,match:i}}return null}matchAll(...e){let t=[];for(let i of e)for(let e of this._patterns){let r=S(i,e);r&&t.push({element:i,pattern:e,match:r})}return t.length>0?t:null}getElementName(){if(1!==this._patterns.length)return null;let e=this._patterns[0],t=e.name;return"function"==typeof e||!t||t instanceof RegExp?null:t}}function S(e,t){var i,n;if("function"==typeof t)return t(e);let o={};return t.name&&(o.name=(i=t.name,n=e.name,i instanceof RegExp?!!n.match(i):i===n),!o.name)||t.attributes&&(o.attributes=function(e,t){let i=new Set(t.getAttributeKeys());return(0,s.Z)(e)?(void 0!==e.style&&(0,r.KE)("matcher-pattern-deprecated-attributes-style-key",e),void 0!==e.class&&(0,r.KE)("matcher-pattern-deprecated-attributes-class-key",e)):(i.delete("style"),i.delete("class")),E(e,i,e=>t.getAttribute(e))}(t.attributes,e),!o.attributes)||t.classes&&(o.classes=E(t.classes,e.getClassNames(),()=>{}),!o.classes)||t.styles&&(o.styles=E(t.styles,e.getStyleNames(!0),t=>e.getStyle(t)),!o.styles)?null:o}function E(e,t,i){let n=Array.isArray(e)?e.map(e=>(0,s.Z)(e)?((void 0===e.key||void 0===e.value)&&(0,r.KE)("matcher-pattern-missing-key-or-value",e),[e.key,e.value]):[e,!0]):(0,s.Z)(e)?Object.entries(e):[[e,!0]],o=Array.from(t),a=[];if(n.forEach(([e,t])=>{o.forEach(r=>{(!0===e||e===r||e instanceof RegExp&&r.match(e))&&function(e,t,i){if(!0===e)return!0;let r=i(t);return e===r||e instanceof RegExp&&!!String(r).match(e)}(t,r,i)&&a.push(r)})}),n.length&&!(a.length<n.length))return a}class R{_styles;_styleProcessor;constructor(e){this._styles={},this._styleProcessor=e}get isEmpty(){return!Object.entries(this._styles).length}get size(){return this.isEmpty?0:this.getStyleNames().length}setTo(e){for(let[t,i]of(this.clear(),function(e){let t=null,i=0,r=0,n=null,s=new Map;if(""===e)return s;";"!=e.charAt(e.length-1)&&(e+=";");for(let o=0;o<e.length;o++){let a=e.charAt(o);if(null===t)switch(a){case":":n||(n=e.substr(i,o-i),r=o+1);break;case'"':case"'":t=a;break;case";":{let t=e.substr(r,o-r);n&&s.set(n.trim(),t.trim()),n=null,i=o+1}}else a===t&&(t=null)}return s}(e)))this._styleProcessor.toNormalizedForm(t,i,this._styles)}has(e){return!this.isEmpty&&Array.isArray(this._styleProcessor.getReducedForm(e,this._styles).find(([t])=>t===e))}set(e,t){if((0,o.Z)(e))for(let[t,i]of Object.entries(e))this._styleProcessor.toNormalizedForm(t,i,this._styles);else this._styleProcessor.toNormalizedForm(e,t,this._styles)}remove(e){let t=T(e);(0,a.Z)(this._styles,t),delete this._styles[e],this._cleanEmptyObjectsOnPath(t)}getNormalized(e){return this._styleProcessor.getNormalized(e,this._styles)}toString(){return this.isEmpty?"":this.getStylesEntries().map(e=>e.join(":")).sort().join(";")+";"}getAsString(e){if(this.isEmpty)return;if(this._styles[e]&&!(0,o.Z)(this._styles[e]))return this._styles[e];let t=this._styleProcessor.getReducedForm(e,this._styles).find(([t])=>t===e);if(Array.isArray(t))return t[1]}getStyleNames(e=!1){return this.isEmpty?[]:e?this._styleProcessor.getStyleNames(this._styles):this.getStylesEntries().map(([e])=>e)}clear(){this._styles={}}getStylesEntries(){let e=[];for(let t of Object.keys(this._styles))e.push(...this._styleProcessor.getReducedForm(t,this._styles));return e}_cleanEmptyObjectsOnPath(e){let t=e.split(".");if(!(t.length>1))return;let i=t.splice(0,t.length-1).join("."),r=(0,l.Z)(this._styles,i);r&&(Object.keys(r).length||this.remove(i))}}class O{_normalizers;_extractors;_reducers;_consumables;constructor(){this._normalizers=new Map,this._extractors=new Map,this._reducers=new Map,this._consumables=new Map}toNormalizedForm(e,t,i){if((0,o.Z)(t)){x(i,T(e),t);return}if(this._normalizers.has(e)){let{path:r,value:n}=this._normalizers.get(e)(t);x(i,r,n)}else x(i,e,t)}getNormalized(e,t){if(!e)return(0,h.Z)({},t);if(void 0!==t[e])return t[e];if(this._extractors.has(e)){let i=this._extractors.get(e);if("string"==typeof i)return(0,l.Z)(t,i);let r=i(e,t);if(r)return r}return(0,l.Z)(t,T(e))}getReducedForm(e,t){let i=this.getNormalized(e,t);return void 0===i?[]:this._reducers.has(e)?this._reducers.get(e)(i):[[e,i]]}getStyleNames(e){let t=new Set;for(let i of this._consumables.keys()){let r=this.getNormalized(i,e);r&&("object"!=typeof r||Object.keys(r).length)&&t.add(i)}for(let i of Object.keys(e))t.add(i);return Array.from(t)}getRelatedStyles(e){return this._consumables.get(e)||[]}setNormalizer(e,t){this._normalizers.set(e,t)}setExtractor(e,t){this._extractors.set(e,t)}setReducer(e,t){this._reducers.set(e,t)}setStyleRelation(e,t){for(let i of(this._mapStyleNames(e,t),t))this._mapStyleNames(i,[e])}_mapStyleNames(e,t){this._consumables.has(e)||this._consumables.set(e,[]),this._consumables.get(e).push(...t)}}function T(e){return e.replace("-",".")}function x(e,t,i){let r=i;(0,o.Z)(i)&&(r=(0,h.Z)({},(0,l.Z)(e,t),i)),(0,u.Z)(e,t,r)}let M=class e extends P{name;_unsafeAttributesToRender=[];_attrs;_children;_classes;_styles;_customProperties=new Map;constructor(e,t,i,n){if(super(e),this.name=t,this._attrs=function(e){let t=(0,r.qL)(e);for(let[e,i]of t)null===i?t.delete(e):"string"!=typeof i&&t.set(e,String(i));return t}(i),this._children=[],n&&this._insertChild(0,n),this._classes=new Set,this._attrs.has("class")){let e=this._attrs.get("class");N(this._classes,e),this._attrs.delete("class")}this._styles=new R(this.document.stylesProcessor),this._attrs.has("style")&&(this._styles.setTo(this._attrs.get("style")),this._attrs.delete("style"))}get childCount(){return this._children.length}get isEmpty(){return 0===this._children.length}getChild(e){return this._children[e]}getChildIndex(e){return this._children.indexOf(e)}getChildren(){return this._children[Symbol.iterator]()}*getAttributeKeys(){this._classes.size>0&&(yield"class"),this._styles.isEmpty||(yield"style"),yield*this._attrs.keys()}*getAttributes(){yield*this._attrs.entries(),this._classes.size>0&&(yield["class",this.getAttribute("class")]),this._styles.isEmpty||(yield["style",this.getAttribute("style")])}getAttribute(e){if("class"==e)return this._classes.size>0?[...this._classes].join(" "):void 0;if("style"==e){let e=this._styles.toString();return""==e?void 0:e}return this._attrs.get(e)}hasAttribute(e){return"class"==e?this._classes.size>0:"style"==e?!this._styles.isEmpty:this._attrs.has(e)}isSimilar(t){if(!(t instanceof e))return!1;if(this===t)return!0;if(this.name!=t.name||this._attrs.size!==t._attrs.size||this._classes.size!==t._classes.size||this._styles.size!==t._styles.size)return!1;for(let[e,i]of this._attrs)if(!t._attrs.has(e)||t._attrs.get(e)!==i)return!1;for(let e of this._classes)if(!t._classes.has(e))return!1;for(let e of this._styles.getStyleNames())if(!t._styles.has(e)||t._styles.getAsString(e)!==this._styles.getAsString(e))return!1;return!0}hasClass(...e){for(let t of e)if(!this._classes.has(t))return!1;return!0}getClassNames(){return this._classes.keys()}getStyle(e){return this._styles.getAsString(e)}getNormalizedStyle(e){return this._styles.getNormalized(e)}getStyleNames(e){return this._styles.getStyleNames(e)}hasStyle(...e){for(let t of e)if(!this._styles.has(t))return!1;return!0}findAncestor(...e){let t=new k(...e),i=this.parent;for(;i&&!i.is("documentFragment");){if(t.match(i))return i;i=i.parent}return null}getCustomProperty(e){return this._customProperties.get(e)}*getCustomProperties(){yield*this._customProperties.entries()}getIdentity(){let e=Array.from(this._classes).sort().join(","),t=this._styles.toString(),i=Array.from(this._attrs).map(e=>`${e[0]}="${e[1]}"`).sort().join(" ");return this.name+(""==e?"":` class="${e}"`)+(t?` style="${t}"`:"")+(""==i?"":` ${i}`)}shouldRenderUnsafeAttribute(e){return this._unsafeAttributesToRender.includes(e)}_clone(e=!1){let t=[];if(e)for(let i of this.getChildren())t.push(i._clone(e));let i=new this.constructor(this.document,this.name,this._attrs,t);return i._classes=new Set(this._classes),i._styles.set(this._styles.getNormalized()),i._customProperties=new Map(this._customProperties),i.getFillerOffset=this.getFillerOffset,i._unsafeAttributesToRender=this._unsafeAttributesToRender,i}_appendChild(e){return this._insertChild(this.childCount,e)}_insertChild(e,t){var i,n;this._fireChange("children",this);let s=0;for(let o of(i=this.document,"string"==typeof(n=t)?[new A(i,n)]:((0,r.TW)(n)||(n=[n]),Array.from(n).map(e=>"string"==typeof e?new A(i,e):e instanceof C?new A(i,e.data):e))))null!==o.parent&&o._remove(),o.parent=this,o.document=this.document,this._children.splice(e,0,o),e++,s++;return s}_removeChildren(e,t=1){this._fireChange("children",this);for(let i=e;i<e+t;i++)this._children[i].parent=null;return this._children.splice(e,t)}_setAttribute(e,t){let i=String(t);this._fireChange("attributes",this),"class"==e?N(this._classes,i):"style"==e?this._styles.setTo(i):this._attrs.set(e,i)}_removeAttribute(e){return(this._fireChange("attributes",this),"class"==e)?this._classes.size>0&&(this._classes.clear(),!0):"style"==e?!this._styles.isEmpty&&(this._styles.clear(),!0):this._attrs.delete(e)}_addClass(e){for(let t of(this._fireChange("attributes",this),(0,r.qo)(e)))this._classes.add(t)}_removeClass(e){for(let t of(this._fireChange("attributes",this),(0,r.qo)(e)))this._classes.delete(t)}_setStyle(e,t){this._fireChange("attributes",this),"string"!=typeof e?this._styles.set(e):this._styles.set(e,t)}_removeStyle(e){for(let t of(this._fireChange("attributes",this),(0,r.qo)(e)))this._styles.remove(t)}_setCustomProperty(e,t){this._customProperties.set(e,t)}_removeCustomProperty(e){return this._customProperties.delete(e)}};function N(e,t){let i=t.split(/\s+/);e.clear(),i.forEach(t=>e.add(t))}M.prototype.is=function(e,t){return t?t===this.name&&("element"===e||"view:element"===e):"element"===e||"view:element"===e||"node"===e||"view:node"===e};class B extends M{constructor(e,t,i,r){super(e,t,i,r),this.getFillerOffset=F}}function F(){let e=[...this.getChildren()],t=e[this.childCount-1];if(t&&t.is("element","br"))return this.childCount;for(let t of e)if(!t.is("uiElement"))return null;return this.childCount}B.prototype.is=function(e,t){return t?t===this.name&&("containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class I extends(0,r.Re)(B){constructor(e,t,i,r){super(e,t,i,r),this.set("isReadOnly",!1),this.set("isFocused",!1),this.set("placeholder",void 0),this.bind("isReadOnly").to(e),this.bind("isFocused").to(e,"isFocused",t=>t&&e.selection.editableElement==this),this.listenTo(e.selection,"change",()=>{this.isFocused=e.isFocused&&e.selection.editableElement==this})}destroy(){this.stopListening()}}I.prototype.is=function(e,t){return t?t===this.name&&("editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};let D=Symbol("rootName");class V extends I{constructor(e,t){super(e,t),this.rootName="main"}get rootName(){return this.getCustomProperty(D)}set rootName(e){this._setCustomProperty(D,e)}set _name(e){this.name=e}}V.prototype.is=function(e,t){return t?t===this.name&&("rootElement"===e||"view:rootElement"===e||"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"rootElement"===e||"view:rootElement"===e||"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};let $=class{direction;boundaries;singleCharacters;shallow;ignoreElementEnd;_position;_boundaryStartParent;_boundaryEndParent;constructor(e={}){if(!e.boundaries&&!e.startPosition)throw new r.Bb("view-tree-walker-no-start-position",null);if(e.direction&&"forward"!=e.direction&&"backward"!=e.direction)throw new r.Bb("view-tree-walker-unknown-direction",e.startPosition,{direction:e.direction});this.boundaries=e.boundaries||null,e.startPosition?this._position=q._createAt(e.startPosition):this._position=q._createAt(e.boundaries["backward"==e.direction?"end":"start"]),this.direction=e.direction||"forward",this.singleCharacters=!!e.singleCharacters,this.shallow=!!e.shallow,this.ignoreElementEnd=!!e.ignoreElementEnd,this._boundaryStartParent=this.boundaries?this.boundaries.start.parent:null,this._boundaryEndParent=this.boundaries?this.boundaries.end.parent:null}[Symbol.iterator](){return this}get position(){return this._position}skip(e){let t,i;do i=this.position,t=this.next();while(!t.done&&e(t.value));t.done||(this._position=i)}next(){return"forward"==this.direction?this._next():this._previous()}_next(){let e,t=this.position.clone(),i=this.position,r=t.parent;if(null===r.parent&&t.offset===r.childCount||r===this._boundaryEndParent&&t.offset==this.boundaries.end.offset)return{done:!0,value:void 0};if(r instanceof A){if(t.isAtEnd)return this._position=q._createAfter(r),this._next();e=r.data[t.offset]}else e=r.getChild(t.offset);if(e instanceof M){if(this.shallow){if(this.boundaries&&this.boundaries.end.isBefore(t))return{done:!0,value:void 0};t.offset++}else t=new q(e,0);return this._position=t,this._formatReturnValue("elementStart",e,i,t,1)}if(e instanceof A){let r;if(this.singleCharacters)return t=new q(e,0),this._position=t,this._next();let n=e.data.length;return e==this._boundaryEndParent?(r=new C(e,0,n=this.boundaries.end.offset),t=q._createAfter(r)):(r=new C(e,0,e.data.length),t.offset++),this._position=t,this._formatReturnValue("text",r,i,t,n)}if("string"==typeof e){let e;e=this.singleCharacters?1:(r===this._boundaryEndParent?this.boundaries.end.offset:r.data.length)-t.offset;let n=new C(r,t.offset,e);return t.offset+=e,this._position=t,this._formatReturnValue("text",n,i,t,e)}return(t=q._createAfter(r),this._position=t,this.ignoreElementEnd)?this._next():this._formatReturnValue("elementEnd",r,i,t)}_previous(){let e,t=this.position.clone(),i=this.position,r=t.parent;if(null===r.parent&&0===t.offset||r==this._boundaryStartParent&&t.offset==this.boundaries.start.offset)return{done:!0,value:void 0};if(r instanceof A){if(t.isAtStart)return this._position=q._createBefore(r),this._previous();e=r.data[t.offset-1]}else e=r.getChild(t.offset-1);if(e instanceof M)return this.shallow?(t.offset--,this._position=t,this._formatReturnValue("elementStart",e,i,t,1)):(t=new q(e,e.childCount),this._position=t,this.ignoreElementEnd)?this._previous():this._formatReturnValue("elementEnd",e,i,t);if(e instanceof A){let r;if(this.singleCharacters)return t=new q(e,e.data.length),this._position=t,this._previous();let n=e.data.length;if(e==this._boundaryStartParent){let i=this.boundaries.start.offset;n=(r=new C(e,i,e.data.length-i)).data.length,t=q._createBefore(r)}else r=new C(e,0,e.data.length),t.offset--;return this._position=t,this._formatReturnValue("text",r,i,t,n)}if("string"==typeof e){let e;if(this.singleCharacters)e=1;else{let i=r===this._boundaryStartParent?this.boundaries.start.offset:0;e=t.offset-i}t.offset-=e;let n=new C(r,t.offset,e);return this._position=t,this._formatReturnValue("text",n,i,t,e)}return t=q._createBefore(r),this._position=t,this._formatReturnValue("elementStart",r,i,t,1)}_formatReturnValue(e,t,i,r,n){return t instanceof C&&(t.offsetInText+t.data.length==t.textNode.data.length&&("forward"!=this.direction||this.boundaries&&this.boundaries.end.isEqual(this.position)?i=q._createAfter(t.textNode):(r=q._createAfter(t.textNode),this._position=r)),0===t.offsetInText&&("backward"!=this.direction||this.boundaries&&this.boundaries.start.isEqual(this.position)?i=q._createBefore(t.textNode):(r=q._createBefore(t.textNode),this._position=r))),{done:!1,value:{type:e,item:t,previousPosition:i,nextPosition:r,length:n}}}},q=class e extends v{parent;offset;constructor(e,t){super(),this.parent=e,this.offset=t}get nodeAfter(){return this.parent.is("$text")?null:this.parent.getChild(this.offset)||null}get nodeBefore(){return this.parent.is("$text")?null:this.parent.getChild(this.offset-1)||null}get isAtStart(){return 0===this.offset}get isAtEnd(){let e=this.parent.is("$text")?this.parent.data.length:this.parent.childCount;return this.offset===e}get root(){return this.parent.root}get editableElement(){let e=this.parent;for(;!(e instanceof I);){if(!e.parent)return null;e=e.parent}return e}getShiftedBy(t){let i=e._createAt(this),r=i.offset+t;return i.offset=r<0?0:r,i}getLastMatchingPosition(e,t={}){t.startPosition=this;let i=new $(t);return i.skip(e),i.position}getAncestors(){return this.parent.is("documentFragment")?[this.parent]:this.parent.getAncestors({includeSelf:!0})}getCommonAncestor(e){let t=this.getAncestors(),i=e.getAncestors(),r=0;for(;t[r]==i[r]&&t[r];)r++;return 0===r?null:t[r-1]}isEqual(e){return this.parent==e.parent&&this.offset==e.offset}isBefore(e){return"before"==this.compareWith(e)}isAfter(e){return"after"==this.compareWith(e)}compareWith(e){if(this.root!==e.root)return"different";if(this.isEqual(e))return"same";let t=this.parent.is("node")?this.parent.getPath():[],i=e.parent.is("node")?e.parent.getPath():[];t.push(this.offset),i.push(e.offset);let n=(0,r.Rt)(t,i);switch(n){case"prefix":return"before";case"extension":return"after";default:return t[n]<i[n]?"before":"after"}}getWalker(e={}){return e.startPosition=this,new $(e)}clone(){return new e(this.parent,this.offset)}static _createAt(t,i){if(t instanceof e)return new this(t.parent,t.offset);if("end"==i)i=t.is("$text")?t.data.length:t.childCount;else if("before"==i)return this._createBefore(t);else if("after"==i)return this._createAfter(t);else if(0!==i&&!i)throw new r.Bb("view-createpositionat-offset-required",t);return new e(t,i)}static _createAfter(t){if(t.is("$textProxy"))return new e(t.textNode,t.offsetInText+t.data.length);if(!t.parent)throw new r.Bb("view-position-after-root",t,{root:t});return new e(t.parent,t.index+1)}static _createBefore(t){if(t.is("$textProxy"))return new e(t.textNode,t.offsetInText);if(!t.parent)throw new r.Bb("view-position-before-root",t,{root:t});return new e(t.parent,t.index)}};q.prototype.is=function(e){return"position"===e||"view:position"===e};let L=class e extends v{start;end;constructor(e,t=null){super(),this.start=e.clone(),this.end=t?t.clone():e.clone()}*[Symbol.iterator](){yield*new $({boundaries:this,ignoreElementEnd:!0})}get isCollapsed(){return this.start.isEqual(this.end)}get isFlat(){return this.start.parent===this.end.parent}get root(){return this.start.root}getEnlarged(){let t=this.start.getLastMatchingPosition(W,{direction:"backward"}),i=this.end.getLastMatchingPosition(W);return t.parent.is("$text")&&t.isAtStart&&(t=q._createBefore(t.parent)),i.parent.is("$text")&&i.isAtEnd&&(i=q._createAfter(i.parent)),new e(t,i)}getTrimmed(){let t=this.start.getLastMatchingPosition(W);if(t.isAfter(this.end)||t.isEqual(this.end))return new e(t,t);let i=this.end.getLastMatchingPosition(W,{direction:"backward"}),r=t.nodeAfter,n=i.nodeBefore;return r&&r.is("$text")&&(t=new q(r,0)),n&&n.is("$text")&&(i=new q(n,n.data.length)),new e(t,i)}isEqual(e){return this==e||this.start.isEqual(e.start)&&this.end.isEqual(e.end)}containsPosition(e){return e.isAfter(this.start)&&e.isBefore(this.end)}containsRange(e,t=!1){e.isCollapsed&&(t=!1);let i=this.containsPosition(e.start)||t&&this.start.isEqual(e.start),r=this.containsPosition(e.end)||t&&this.end.isEqual(e.end);return i&&r}getDifference(t){let i=[];return this.isIntersecting(t)?(this.containsPosition(t.start)&&i.push(new e(this.start,t.start)),this.containsPosition(t.end)&&i.push(new e(t.end,this.end))):i.push(this.clone()),i}getIntersection(t){if(this.isIntersecting(t)){let i=this.start,r=this.end;return this.containsPosition(t.start)&&(i=t.start),this.containsPosition(t.end)&&(r=t.end),new e(i,r)}return null}getWalker(e={}){return e.boundaries=this,new $(e)}getCommonAncestor(){return this.start.getCommonAncestor(this.end)}getContainedElement(){if(this.isCollapsed)return null;let e=this.start.nodeAfter,t=this.end.nodeBefore;return(this.start.parent.is("$text")&&this.start.isAtEnd&&this.start.parent.nextSibling&&(e=this.start.parent.nextSibling),this.end.parent.is("$text")&&this.end.isAtStart&&this.end.parent.previousSibling&&(t=this.end.parent.previousSibling),e&&e.is("element")&&e===t)?e:null}clone(){return new e(this.start,this.end)}*getItems(e={}){for(let t of(e.boundaries=this,e.ignoreElementEnd=!0,new $(e)))yield t.item}*getPositions(e={}){e.boundaries=this;let t=new $(e);for(let e of(yield t.position,t))yield e.nextPosition}isIntersecting(e){return this.start.isBefore(e.end)&&this.end.isAfter(e.start)}static _createFromParentsAndOffsets(e,t,i,r){return new this(new q(e,t),new q(i,r))}static _createFromPositionAndShift(e,t){let i=e.getShiftedBy(t);return t>0?new this(e,i):new this(i,e)}static _createIn(e){return this._createFromParentsAndOffsets(e,0,e,e.childCount)}static _createOn(e){let t=e.is("$textProxy")?e.offsetSize:1;return this._createFromPositionAndShift(q._createBefore(e),t)}};function W(e){return!!(e.item.is("attributeElement")||e.item.is("uiElement"))}L.prototype.is=function(e){return"range"===e||"view:range"===e};let j=class e extends(0,r.ln)(v){_ranges;_lastRangeBackward;_isFake;_fakeSelectionLabel;constructor(...e){super(),this._ranges=[],this._lastRangeBackward=!1,this._isFake=!1,this._fakeSelectionLabel="",e.length&&this.setTo(...e)}get isFake(){return this._isFake}get fakeSelectionLabel(){return this._fakeSelectionLabel}get anchor(){if(!this._ranges.length)return null;let e=this._ranges[this._ranges.length-1];return(this._lastRangeBackward?e.end:e.start).clone()}get focus(){if(!this._ranges.length)return null;let e=this._ranges[this._ranges.length-1];return(this._lastRangeBackward?e.start:e.end).clone()}get isCollapsed(){return 1===this.rangeCount&&this._ranges[0].isCollapsed}get rangeCount(){return this._ranges.length}get isBackward(){return!this.isCollapsed&&this._lastRangeBackward}get editableElement(){return this.anchor?this.anchor.editableElement:null}*getRanges(){for(let e of this._ranges)yield e.clone()}getFirstRange(){let e=null;for(let t of this._ranges)(!e||t.start.isBefore(e.start))&&(e=t);return e?e.clone():null}getLastRange(){let e=null;for(let t of this._ranges)(!e||t.end.isAfter(e.end))&&(e=t);return e?e.clone():null}getFirstPosition(){let e=this.getFirstRange();return e?e.start.clone():null}getLastPosition(){let e=this.getLastRange();return e?e.end.clone():null}isEqual(e){if(this.isFake!=e.isFake||this.isFake&&this.fakeSelectionLabel!=e.fakeSelectionLabel||this.rangeCount!=e.rangeCount)return!1;if(0===this.rangeCount)return!0;if(!this.anchor.isEqual(e.anchor)||!this.focus.isEqual(e.focus))return!1;for(let t of this._ranges){let i=!1;for(let r of e._ranges)if(t.isEqual(r)){i=!0;break}if(!i)return!1}return!0}isSimilar(e){if(this.isBackward!=e.isBackward)return!1;let t=(0,r.QX)(this.getRanges());if(t!=(0,r.QX)(e.getRanges()))return!1;if(0==t)return!0;for(let t of this.getRanges()){t=t.getTrimmed();let i=!1;for(let r of e.getRanges())if(r=r.getTrimmed(),t.start.isEqual(r.start)&&t.end.isEqual(r.end)){i=!0;break}if(!i)return!1}return!0}getSelectedElement(){return 1!==this.rangeCount?null:this.getFirstRange().getContainedElement()}setTo(...t){let[i,n,s]=t;if("object"==typeof n&&(s=n,n=void 0),null===i)this._setRanges([]),this._setFakeOptions(s);else if(i instanceof e||i instanceof U)this._setRanges(i.getRanges(),i.isBackward),this._setFakeOptions({fake:i.isFake,label:i.fakeSelectionLabel});else if(i instanceof L)this._setRanges([i],s&&s.backward),this._setFakeOptions(s);else if(i instanceof q)this._setRanges([new L(i)]),this._setFakeOptions(s);else if(i instanceof P){let e;let t=!!s&&!!s.backward;if(void 0===n)throw new r.Bb("view-selection-setto-required-second-parameter",this);e="in"==n?L._createIn(i):"on"==n?L._createOn(i):new L(q._createAt(i,n)),this._setRanges([e],t),this._setFakeOptions(s)}else if((0,r.TW)(i))this._setRanges(i,s&&s.backward),this._setFakeOptions(s);else throw new r.Bb("view-selection-setto-not-selectable",this);this.fire("change")}setFocus(e,t){if(null===this.anchor)throw new r.Bb("view-selection-setfocus-no-ranges",this);let i=q._createAt(e,t);if("same"==i.compareWith(this.focus))return;let n=this.anchor;this._ranges.pop(),"before"==i.compareWith(n)?this._addRange(new L(i,n),!0):this._addRange(new L(n,i)),this.fire("change")}_setRanges(e,t=!1){for(let t of(e=Array.from(e),this._ranges=[],e))this._addRange(t);this._lastRangeBackward=!!t}_setFakeOptions(e={}){this._isFake=!!e.fake,this._fakeSelectionLabel=e.fake&&e.label||""}_addRange(e,t=!1){if(!(e instanceof L))throw new r.Bb("view-selection-add-range-not-range",this);this._pushRange(e),this._lastRangeBackward=!!t}_pushRange(e){for(let t of this._ranges)if(e.isIntersecting(t))throw new r.Bb("view-selection-range-intersects",this,{addedRange:e,intersectingRange:t});this._ranges.push(new L(e.start,e.end))}};j.prototype.is=function(e){return"selection"===e||"view:selection"===e};let U=class extends(0,r.ln)(v){_selection;constructor(...e){super(),this._selection=new j,this._selection.delegate("change").to(this),e.length&&this._selection.setTo(...e)}get isFake(){return this._selection.isFake}get fakeSelectionLabel(){return this._selection.fakeSelectionLabel}get anchor(){return this._selection.anchor}get focus(){return this._selection.focus}get isCollapsed(){return this._selection.isCollapsed}get rangeCount(){return this._selection.rangeCount}get isBackward(){return this._selection.isBackward}get editableElement(){return this._selection.editableElement}get _ranges(){return this._selection._ranges}*getRanges(){yield*this._selection.getRanges()}getFirstRange(){return this._selection.getFirstRange()}getLastRange(){return this._selection.getLastRange()}getFirstPosition(){return this._selection.getFirstPosition()}getLastPosition(){return this._selection.getLastPosition()}getSelectedElement(){return this._selection.getSelectedElement()}isEqual(e){return this._selection.isEqual(e)}isSimilar(e){return this._selection.isSimilar(e)}_setTo(...e){this._selection.setTo(...e)}_setFocus(e,t){this._selection.setFocus(e,t)}};U.prototype.is=function(e){return"selection"===e||"documentSelection"==e||"view:selection"==e||"view:documentSelection"==e};class J extends r.M3{startRange;_eventPhase;_currentTarget;constructor(e,t,i){super(e,t),this.startRange=i,this._eventPhase="none",this._currentTarget=null}get eventPhase(){return this._eventPhase}get currentTarget(){return this._currentTarget}}let K=Symbol("bubbling contexts");function G(e){class t extends e{fire(e,...t){try{let i=e instanceof r.M3?e:new r.M3(this,e),n=Y(this);if(!n.size)return;if(z(i,"capturing",this),H(n,"$capture",i,...t))return i.return;let s=i.startRange||this.selection.getFirstRange(),o=s?s.getContainedElement():null,a=!!o&&!!Z(n,o),l=o||function(e){if(!e)return null;let t=e.start.parent,i=e.end.parent,r=t.getPath(),n=i.getPath();return r.length>n.length?t:i}(s);if(z(i,"atTarget",l),!a){if(H(n,"$text",i,...t))return i.return;z(i,"bubbling",l)}for(;l;){if(l.is("rootElement")){if(H(n,"$root",i,...t))return i.return}else if(l.is("element")&&H(n,l.name,i,...t))return i.return;if(H(n,l,i,...t))return i.return;l=l.parent,z(i,"bubbling",l)}return z(i,"bubbling",this),H(n,"$document",i,...t),i.return}catch(e){r.Bb.rethrowUnexpectedError(e,this)}}_addEventListener(e,t,i){let n=(0,r.qo)(i.context||"$document"),s=Y(this);for(let o of n){let n=s.get(o);n||(n=new((0,r.ln)()),s.set(o,n)),this.listenTo(n,e,t,i)}}_removeEventListener(e,t){for(let i of Y(this).values())this.stopListening(i,e,t)}}return t}{let e=G(Object);["fire","_addEventListener","_removeEventListener"].forEach(t=>{G[t]=e.prototype[t]})}function z(e,t,i){e instanceof J&&(e._eventPhase=t,e._currentTarget=i)}function H(e,t,i,...r){let n="string"==typeof t?e.get(t):Z(e,t);return!!n&&(n.fire(i,...r),i.stop.called)}function Z(e,t){for(let[i,r]of e)if("function"==typeof i&&i(t))return r;return null}function Y(e){return e[K]||(e[K]=new Map),e[K]}let Q=class extends G((0,r.Re)()){selection;roots;stylesProcessor;_postFixers=new Set;constructor(e){super(),this.selection=new U,this.roots=new r.FE({idProperty:"rootName"}),this.stylesProcessor=e,this.set("isReadOnly",!1),this.set("isFocused",!1),this.set("isSelecting",!1),this.set("isComposing",!1)}getRoot(e="main"){return this.roots.get(e)}registerPostFixer(e){this._postFixers.add(e)}destroy(){this.roots.forEach(e=>e.destroy()),this.stopListening()}_callPostFixers(e){let t=!1;do for(let i of this._postFixers)if(t=i(e))break;while(t)}};class X extends M{static DEFAULT_PRIORITY=10;_priority=10;_id=null;_clonesGroup=null;constructor(e,t,i,r){super(e,t,i,r),this.getFillerOffset=ee}get priority(){return this._priority}get id(){return this._id}getElementsWithSameId(){if(null===this.id)throw new r.Bb("attribute-element-get-elements-with-same-id-no-id",this);return new Set(this._clonesGroup)}isSimilar(e){return null!==this.id||null!==e.id?this.id===e.id:super.isSimilar(e)&&this.priority==e.priority}_clone(e=!1){let t=super._clone(e);return t._priority=this._priority,t._id=this._id,t}}function ee(){if(et(this))return null;let e=this.parent;for(;e&&e.is("attributeElement");){if(et(e)>1)return null;e=e.parent}return!e||et(e)>1?null:this.childCount}function et(e){return Array.from(e.getChildren()).filter(e=>!e.is("uiElement")).length}X.prototype.is=function(e,t){return t?t===this.name&&("attributeElement"===e||"view:attributeElement"===e||"element"===e||"view:element"===e):"attributeElement"===e||"view:attributeElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class ei extends M{constructor(e,t,i,r){super(e,t,i,r),this.getFillerOffset=er}_insertChild(e,t){if(t&&(t instanceof P||Array.from(t).length>0))throw new r.Bb("view-emptyelement-cannot-add",[this,t]);return 0}}function er(){return null}ei.prototype.is=function(e,t){return t?t===this.name&&("emptyElement"===e||"view:emptyElement"===e||"element"===e||"view:element"===e):"emptyElement"===e||"view:emptyElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class en extends M{constructor(e,t,i,r){super(e,t,i,r),this.getFillerOffset=es}_insertChild(e,t){if(t&&(t instanceof P||Array.from(t).length>0))throw new r.Bb("view-uielement-cannot-add",[this,t]);return 0}render(e,t){return this.toDomElement(e)}toDomElement(e){let t=e.createElement(this.name);for(let e of this.getAttributeKeys())t.setAttribute(e,this.getAttribute(e));return t}}function es(){return null}en.prototype.is=function(e,t){return t?t===this.name&&("uiElement"===e||"view:uiElement"===e||"element"===e||"view:element"===e):"uiElement"===e||"view:uiElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class eo extends M{constructor(e,t,i,r){super(e,t,i,r),this.getFillerOffset=ea}_insertChild(e,t){if(t&&(t instanceof P||Array.from(t).length>0))throw new r.Bb("view-rawelement-cannot-add",[this,t]);return 0}render(e,t){}}function ea(){return null}eo.prototype.is=function(e,t){return t?t===this.name&&("rawElement"===e||"view:rawElement"===e||"element"===e||"view:element"===e):"rawElement"===e||"view:rawElement"===e||e===this.name||e==="view:"+this.name||"element"===e||"view:element"===e||"node"===e||"view:node"===e};let el=class extends(0,r.ln)(v){document;_children=[];_customProperties=new Map;constructor(e,t){super(),this.document=e,t&&this._insertChild(0,t)}[Symbol.iterator](){return this._children[Symbol.iterator]()}get childCount(){return this._children.length}get isEmpty(){return 0===this.childCount}get root(){return this}get parent(){return null}get name(){}get getFillerOffset(){}getCustomProperty(e){return this._customProperties.get(e)}*getCustomProperties(){yield*this._customProperties.entries()}_appendChild(e){return this._insertChild(this.childCount,e)}getChild(e){return this._children[e]}getChildIndex(e){return this._children.indexOf(e)}getChildren(){return this._children[Symbol.iterator]()}_insertChild(e,t){var i,n;this._fireChange("children",this);let s=0;for(let o of(i=this.document,"string"==typeof(n=t)?[new A(i,n)]:((0,r.TW)(n)||(n=[n]),Array.from(n).map(e=>"string"==typeof e?new A(i,e):e instanceof C?new A(i,e.data):e))))null!==o.parent&&o._remove(),o.parent=this,this._children.splice(e,0,o),e++,s++;return s}_removeChildren(e,t=1){this._fireChange("children",this);for(let i=e;i<e+t;i++)this._children[i].parent=null;return this._children.splice(e,t)}_fireChange(e,t){this.fire("change:"+e,t)}_setCustomProperty(e,t){this._customProperties.set(e,t)}_removeCustomProperty(e){return this._customProperties.delete(e)}};el.prototype.is=function(e){return"documentFragment"===e||"view:documentFragment"===e};class eh{document;_cloneGroups=new Map;_slotFactory=null;constructor(e){this.document=e}setSelection(...e){this.document.selection._setTo(...e)}setSelectionFocus(e,t){this.document.selection._setFocus(e,t)}createDocumentFragment(e){return new el(this.document,e)}createText(e){return new A(this.document,e)}createAttributeElement(e,t,i={}){let r=new X(this.document,e,t);return"number"==typeof i.priority&&(r._priority=i.priority),i.id&&(r._id=i.id),i.renderUnsafeAttributes&&r._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),r}createContainerElement(e,t,i={},r={}){let n=null;(0,s.Z)(i)?r=i:n=i;let o=new B(this.document,e,t,n);return r.renderUnsafeAttributes&&o._unsafeAttributesToRender.push(...r.renderUnsafeAttributes),o}createEditableElement(e,t,i={}){let r=new I(this.document,e,t);return i.renderUnsafeAttributes&&r._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),r}createEmptyElement(e,t,i={}){let r=new ei(this.document,e,t);return i.renderUnsafeAttributes&&r._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),r}createUIElement(e,t,i){let r=new en(this.document,e,t);return i&&(r.render=i),r}createRawElement(e,t,i,r={}){let n=new eo(this.document,e,t);return i&&(n.render=i),r.renderUnsafeAttributes&&n._unsafeAttributesToRender.push(...r.renderUnsafeAttributes),n}setAttribute(e,t,i){i._setAttribute(e,t)}removeAttribute(e,t){t._removeAttribute(e)}addClass(e,t){t._addClass(e)}removeClass(e,t){t._removeClass(e)}setStyle(e,t,i){(0,s.Z)(e)&&void 0===i?t._setStyle(e):i._setStyle(e,t)}removeStyle(e,t){t._removeStyle(e)}setCustomProperty(e,t,i){i._setCustomProperty(e,t)}removeCustomProperty(e,t){return t._removeCustomProperty(e)}breakAttributes(e){return e instanceof q?this._breakAttributes(e):this._breakAttributesRange(e)}breakContainer(e){let t=e.parent;if(!t.is("containerElement"))throw new r.Bb("view-writer-break-non-container-element",this.document);if(!t.parent)throw new r.Bb("view-writer-break-root",this.document);if(e.isAtStart)return q._createBefore(t);if(!e.isAtEnd){let i=t._clone(!1);this.insert(q._createAfter(t),i);let r=new L(e,q._createAt(t,"end")),n=new q(i,0);this.move(r,n)}return q._createAfter(t)}mergeAttributes(e){let t=e.offset,i=e.parent;if(i.is("$text"))return e;if(i.is("attributeElement")&&0===i.childCount){let e=i.parent,t=i.index;return i._remove(),this._removeFromClonedElementsGroup(i),this.mergeAttributes(new q(e,t))}let r=i.getChild(t-1),n=i.getChild(t);if(!r||!n)return e;if(r.is("$text")&&n.is("$text"))return ef(r,n);if(r.is("attributeElement")&&n.is("attributeElement")&&r.isSimilar(n)){let e=r.childCount;return r._appendChild(n.getChildren()),n._remove(),this._removeFromClonedElementsGroup(n),this.mergeAttributes(new q(r,e))}return e}mergeContainers(e){let t=e.nodeBefore,i=e.nodeAfter;if(!t||!i||!t.is("containerElement")||!i.is("containerElement"))throw new r.Bb("view-writer-merge-containers-invalid-position",this.document);let n=t.getChild(t.childCount-1),s=n instanceof A?q._createAt(n,"end"):q._createAt(t,"end");return this.move(L._createIn(i),q._createAt(t,"end")),this.remove(L._createOn(i)),s}insert(e,t){!function e(t,i){for(let n of t){if(!em.some(e=>n instanceof e))throw new r.Bb("view-writer-insert-invalid-node-type",i);n.is("$text")||e(n.getChildren(),i)}}(t=(0,r.TW)(t)?[...t]:[t],this.document);let i=t.reduce((e,t)=>{let i=e[e.length-1],r=!t.is("uiElement");return i&&i.breakAttributes==r?i.nodes.push(t):e.push({breakAttributes:r,nodes:[t]}),e},[]),n=null,s=e;for(let{nodes:e,breakAttributes:t}of i){let i=this._insertNodes(s,e,t);n||(n=i.start),s=i.end}return n?new L(n,s):new L(e)}remove(e){let t=e instanceof L?e:L._createOn(e);if(ep(t,this.document),t.isCollapsed)return new el(this.document);let{start:i,end:r}=this._breakAttributesRange(t,!0),n=i.parent,s=r.offset-i.offset,o=n._removeChildren(i.offset,s);for(let e of o)this._removeFromClonedElementsGroup(e);let a=this.mergeAttributes(i);return t.start=a,t.end=a.clone(),new el(this.document,o)}clear(e,t){for(let i of(ep(e,this.document),e.getWalker({direction:"backward",ignoreElementEnd:!0}))){let r;let n=i.item;if(n.is("element")&&t.isSimilar(n))r=L._createOn(n);else if(!i.nextPosition.isAfter(e.start)&&n.is("$textProxy")){let e=n.getAncestors().find(e=>e.is("element")&&t.isSimilar(e));e&&(r=L._createIn(e))}r&&(r.end.isAfter(e.end)&&(r.end=e.end),r.start.isBefore(e.start)&&(r.start=e.start),this.remove(r))}}move(e,t){let i;if(t.isAfter(e.end)){let r=(t=this._breakAttributes(t,!0)).parent,n=r.childCount;e=this._breakAttributesRange(e,!0),i=this.remove(e),t.offset+=r.childCount-n}else i=this.remove(e);return this.insert(t,i)}wrap(e,t){if(!(t instanceof X))throw new r.Bb("view-writer-wrap-invalid-attribute",this.document);if(ep(e,this.document),!e.isCollapsed)return this._wrapRange(e,t);{let i=e.start;i.parent.is("element")&&!Array.from(i.parent.getChildren()).some(e=>!e.is("uiElement"))&&(i=i.getLastMatchingPosition(e=>e.item.is("uiElement"))),i=this._wrapPosition(i,t);let r=this.document.selection;return r.isCollapsed&&r.getFirstPosition().isEqual(e.start)&&this.setSelection(i),new L(i)}}unwrap(e,t){if(!(t instanceof X))throw new r.Bb("view-writer-unwrap-invalid-attribute",this.document);if(ep(e,this.document),e.isCollapsed)return e;let{start:i,end:n}=this._breakAttributesRange(e,!0),s=i.parent,o=this._unwrapChildren(s,i.offset,n.offset,t),a=this.mergeAttributes(o.start);return!a.isEqual(o.start)&&o.end.offset--,new L(a,this.mergeAttributes(o.end))}rename(e,t){let i=new B(this.document,e,t.getAttributes());return this.insert(q._createAfter(t),i),this.move(L._createIn(t),q._createAt(i,0)),this.remove(L._createOn(t)),i}clearClonedElementsGroup(e){this._cloneGroups.delete(e)}createPositionAt(e,t){return q._createAt(e,t)}createPositionAfter(e){return q._createAfter(e)}createPositionBefore(e){return q._createBefore(e)}createRange(e,t){return new L(e,t)}createRangeOn(e){return L._createOn(e)}createRangeIn(e){return L._createIn(e)}createSelection(...e){return new j(...e)}createSlot(e="children"){if(!this._slotFactory)throw new r.Bb("view-writer-invalid-create-slot-context",this.document);return this._slotFactory(this,e)}_registerSlotFactory(e){this._slotFactory=e}_clearSlotFactory(){this._slotFactory=null}_insertNodes(e,t,i){let n,s;if(!(n=i?eu(e):e.parent.is("$text")?e.parent.parent:e.parent))throw new r.Bb("view-writer-invalid-position-container",this.document);s=i?this._breakAttributes(e,!0):e.parent.is("$text")?ec(e):e;let o=n._insertChild(s.offset,t);for(let e of t)this._addToClonedElementsGroup(e);let a=s.getShiftedBy(o),l=this.mergeAttributes(s);return!l.isEqual(s)&&a.offset--,new L(l,this.mergeAttributes(a))}_wrapChildren(e,t,i,r){let n=t,s=[];for(;n<i;){let t=e.getChild(n),i=t.is("$text"),o=t.is("attributeElement");if(o&&this._wrapAttributeElement(r,t))s.push(new q(e,n));else if(i||!o||r.priority<t.priority||!(r.priority>t.priority)&&r.getIdentity()<t.getIdentity()){let i=r._clone();t._remove(),i._appendChild(t),e._insertChild(n,i),this._addToClonedElementsGroup(i),s.push(new q(e,n))}else this._wrapChildren(t,0,t.childCount,r);n++}let o=0;for(let e of s)e.offset-=o,e.offset!=t&&!this.mergeAttributes(e).isEqual(e)&&(o++,i--);return L._createFromParentsAndOffsets(e,t,e,i)}_unwrapChildren(e,t,i,r){let n=t,s=[];for(;n<i;){let t=e.getChild(n);if(!t.is("attributeElement")){n++;continue}if(t.isSimilar(r)){let r=t.getChildren(),o=t.childCount;t._remove(),e._insertChild(n,r),this._removeFromClonedElementsGroup(t),s.push(new q(e,n),new q(e,n+o)),n+=o,i+=o-1;continue}if(this._unwrapAttributeElement(r,t)){s.push(new q(e,n),new q(e,n+1)),n++;continue}this._unwrapChildren(t,0,t.childCount,r),n++}let o=0;for(let e of s)e.offset-=o,e.offset!=t&&e.offset!=i&&!this.mergeAttributes(e).isEqual(e)&&(o++,i--);return L._createFromParentsAndOffsets(e,t,e,i)}_wrapRange(e,t){let{start:i,end:r}=this._breakAttributesRange(e,!0),n=i.parent,s=this._wrapChildren(n,i.offset,r.offset,t),o=this.mergeAttributes(s.start);return!o.isEqual(s.start)&&s.end.offset--,new L(o,this.mergeAttributes(s.end))}_wrapPosition(e,t){if(t.isSimilar(e.parent))return ed(e.clone());e.parent.is("$text")&&(e=ec(e));let i=this.createAttributeElement("_wrapPosition-fake-element");i._priority=Number.POSITIVE_INFINITY,i.isSimilar=()=>!1,e.parent._insertChild(e.offset,i);let r=new L(e,e.getShiftedBy(1));this.wrap(r,t);let n=new q(i.parent,i.index);i._remove();let s=n.nodeBefore,o=n.nodeAfter;return s instanceof A&&o instanceof A?ef(s,o):ed(n)}_wrapAttributeElement(e,t){if(!e_(e,t)||e.name!==t.name||e.priority!==t.priority)return!1;for(let i of e.getAttributeKeys())if("class"!==i&&"style"!==i&&t.hasAttribute(i)&&t.getAttribute(i)!==e.getAttribute(i))return!1;for(let i of e.getStyleNames())if(t.hasStyle(i)&&t.getStyle(i)!==e.getStyle(i))return!1;for(let i of e.getAttributeKeys())"class"!==i&&"style"!==i&&(t.hasAttribute(i)||this.setAttribute(i,e.getAttribute(i),t));for(let i of e.getStyleNames())t.hasStyle(i)||this.setStyle(i,e.getStyle(i),t);for(let i of e.getClassNames())t.hasClass(i)||this.addClass(i,t);return!0}_unwrapAttributeElement(e,t){if(!e_(e,t)||e.name!==t.name||e.priority!==t.priority)return!1;for(let i of e.getAttributeKeys())if("class"!==i&&"style"!==i&&(!t.hasAttribute(i)||t.getAttribute(i)!==e.getAttribute(i)))return!1;if(!t.hasClass(...e.getClassNames()))return!1;for(let i of e.getStyleNames())if(!t.hasStyle(i)||t.getStyle(i)!==e.getStyle(i))return!1;for(let i of e.getAttributeKeys())"class"!==i&&"style"!==i&&this.removeAttribute(i,t);return this.removeClass(Array.from(e.getClassNames()),t),this.removeStyle(Array.from(e.getStyleNames()),t),!0}_breakAttributesRange(e,t=!1){let i=e.start,r=e.end;if(ep(e,this.document),e.isCollapsed){let i=this._breakAttributes(e.start,t);return new L(i,i)}let n=this._breakAttributes(r,t),s=n.parent.childCount,o=this._breakAttributes(i,t);return n.offset+=n.parent.childCount-s,new L(o,n)}_breakAttributes(e,t=!1){let i=e.offset,n=e.parent;if(e.parent.is("emptyElement"))throw new r.Bb("view-writer-cannot-break-empty-element",this.document);if(e.parent.is("uiElement"))throw new r.Bb("view-writer-cannot-break-ui-element",this.document);if(e.parent.is("rawElement"))throw new r.Bb("view-writer-cannot-break-raw-element",this.document);if(!t&&n.is("$text")&&eg(n.parent)||eg(n))return e.clone();if(n.is("$text"))return this._breakAttributes(ec(e),t);if(i==n.childCount){let e=new q(n.parent,n.index+1);return this._breakAttributes(e,t)}if(0===i){let e=new q(n.parent,n.index);return this._breakAttributes(e,t)}{let e=n.index+1,r=n._clone();n.parent._insertChild(e,r),this._addToClonedElementsGroup(r);let s=n.childCount-i,o=n._removeChildren(i,s);r._appendChild(o);let a=new q(n.parent,e);return this._breakAttributes(a,t)}}_addToClonedElementsGroup(e){if(!e.root.is("rootElement"))return;if(e.is("element"))for(let t of e.getChildren())this._addToClonedElementsGroup(t);let t=e.id;if(!t)return;let i=this._cloneGroups.get(t);i||(i=new Set,this._cloneGroups.set(t,i)),i.add(e),e._clonesGroup=i}_removeFromClonedElementsGroup(e){if(e.is("element"))for(let t of e.getChildren())this._removeFromClonedElementsGroup(t);let t=e.id;if(!t)return;let i=this._cloneGroups.get(t);i&&i.delete(e)}}function eu(e){let t=e.parent;for(;!eg(t);){if(!t)return;t=t.parent}return t}function ed(e){let t=e.nodeBefore;if(t&&t.is("$text"))return new q(t,t.data.length);let i=e.nodeAfter;return i&&i.is("$text")?new q(i,0):e}function ec(e){if(e.offset==e.parent.data.length)return new q(e.parent.parent,e.parent.index+1);if(0===e.offset)return new q(e.parent.parent,e.parent.index);let t=e.parent.data.slice(e.offset);return e.parent._data=e.parent.data.slice(0,e.offset),e.parent.parent._insertChild(e.parent.index+1,new A(e.root.document,t)),new q(e.parent.parent,e.parent.index+1)}function ef(e,t){let i=e.data.length;return e._data+=t.data,t._remove(),new q(e,i)}let em=[A,X,B,ei,eo,en];function eg(e){return e&&(e.is("containerElement")||e.is("documentFragment"))}function ep(e,t){let i=eu(e.start),n=eu(e.end);if(!i||!n||i!==n)throw new r.Bb("view-writer-invalid-range-container",t)}function e_(e,t){return null===e.id&&null===t.id}let ew=e=>e.createTextNode("\xa0"),eb=e=>{let t=e.createElement("span");return t.dataset.ckeFiller="true",t.innerText="\xa0",t},ey=e=>{let t=e.createElement("br");return t.dataset.ckeFiller="true",t},ev="".repeat(7);function eP(e){return"string"==typeof e?e.substr(0,7)===ev:(0,r.Gs)(e)&&e.data.substr(0,7)===ev}function eA(e){return 7==e.data.length&&eP(e)}function eC(e){let t="string"==typeof e?e:e.data;return eP(e)?t.slice(7):t}function ek(e,t){if(t.keyCode==r.Do.arrowleft){let e=t.domTarget.ownerDocument.defaultView.getSelection();if(1==e.rangeCount&&e.getRangeAt(0).collapsed){let t=e.getRangeAt(0).startContainer,i=e.getRangeAt(0).startOffset;eP(t)&&i<=7&&e.collapse(t,0)}}}class eS extends(0,r.Re)(){domDocuments=new Set;domConverter;markedAttributes=new Set;markedChildren=new Set;markedTexts=new Set;selection;_inlineFiller=null;_fakeSelectionContainer=null;constructor(e,t){super(),this.domConverter=e,this.selection=t,this.set("isFocused",!1),this.set("isSelecting",!1),this.set("isComposing",!1),r.OB.isBlink&&!r.OB.isAndroid&&this.on("change:isSelecting",()=>{this.isSelecting||this.render()})}markToSync(e,t){if("text"===e)this.domConverter.mapViewToDom(t.parent)&&this.markedTexts.add(t);else{if(!this.domConverter.mapViewToDom(t))return;if("attributes"===e)this.markedAttributes.add(t);else if("children"===e)this.markedChildren.add(t);else throw new r.Bb("view-renderer-unknown-type",this)}}render(){if(this.isComposing&&!r.OB.isAndroid)return;let e=null,t=!r.OB.isBlink||!!r.OB.isAndroid||!this.isSelecting;for(let e of this.markedChildren)this._updateChildrenMappings(e);for(let i of(t?(this._inlineFiller&&!this._isSelectionInInlineFiller()&&this._removeInlineFiller(),this._inlineFiller?e=this._getInlineFillerPosition():this._needsInlineFillerAtSelection()&&(e=this.selection.getFirstPosition(),this.markedChildren.add(e.parent))):this._inlineFiller&&this._inlineFiller.parentNode&&(e=this.domConverter.domPositionToView(this._inlineFiller))&&e.parent.is("$text")&&(e=q._createBefore(e.parent)),this.markedAttributes))this._updateAttrs(i);for(let t of this.markedChildren)this._updateChildren(t,{inlineFillerPosition:e});for(let t of this.markedTexts)!this.markedChildren.has(t.parent)&&this.domConverter.mapViewToDom(t.parent)&&this._updateText(t,{inlineFillerPosition:e});if(t){if(e){let t=this.domConverter.viewPositionToDom(e),i=t.parent.ownerDocument;eP(t.parent)?this._inlineFiller=t.parent:this._inlineFiller=eE(i,t.parent,t.offset)}else this._inlineFiller=null}this._updateFocus(),this._updateSelection(),this.domConverter._clearTemporaryCustomProperties(),this.markedTexts.clear(),this.markedAttributes.clear(),this.markedChildren.clear()}_updateChildrenMappings(e){let t=this.domConverter.mapViewToDom(e);if(!t)return;let i=Array.from(t.childNodes),n=Array.from(this.domConverter.viewChildrenToDom(e,{withChildren:!1})),s=this._diffNodeLists(i,n),o=this._findUpdateActions(s,i,n,eR);if(-1!==o.indexOf("update")){let t={equal:0,insert:0,delete:0};for(let s of o)if("update"===s){let s=t.equal+t.insert,o=t.equal+t.delete,a=e.getChild(s);!a||a.is("uiElement")||a.is("rawElement")||this._updateElementMappings(a,i[o]),(0,r.Od)(n[s]),t.equal++}else t[s]++}}_updateElementMappings(e,t){this.domConverter.unbindDomElement(t),this.domConverter.bindElements(t,e),this.markedChildren.add(e),this.markedAttributes.add(e)}_getInlineFillerPosition(){let e=this.selection.getFirstPosition();return e.parent.is("$text")?q._createBefore(e.parent):e}_isSelectionInInlineFiller(){if(1!=this.selection.rangeCount||!this.selection.isCollapsed)return!1;let e=this.selection.getFirstPosition(),t=this.domConverter.viewPositionToDom(e);return!!(t&&(0,r.Gs)(t.parent)&&eP(t.parent))}_removeInlineFiller(){let e=this._inlineFiller;if(!eP(e))throw new r.Bb("view-renderer-filler-was-lost",this);eA(e)?e.remove():e.data=e.data.substr(7),this._inlineFiller=null}_needsInlineFillerAtSelection(){if(1!=this.selection.rangeCount||!this.selection.isCollapsed)return!1;let e=this.selection.getFirstPosition(),t=e.parent,i=e.offset;if(!this.domConverter.mapViewToDom(t.root)||!t.is("element")||!function(e){if("false"==e.getAttribute("contenteditable"))return!1;let t=e.findAncestor(e=>e.hasAttribute("contenteditable"));return!t||"true"==t.getAttribute("contenteditable")}(t))return!1;let n=e.nodeBefore,s=e.nodeAfter;return!(n instanceof A)&&!(s instanceof A)&&(i!==t.getFillerOffset()||!!n&&!!n.is("element","br"))&&(!r.OB.isAndroid||!n&&!s)}_updateText(e,t){let i=this.domConverter.findCorrespondingDomText(e),r=this.domConverter.viewToDom(e).data,n=t.inlineFillerPosition;n&&n.parent==e.parent&&n.offset==e.index&&(r=ev+r),this._updateTextNode(i,r)}_updateAttrs(e){let t=this.domConverter.mapViewToDom(e);if(t){for(let i of t.attributes){let r=i.name;e.hasAttribute(r)||this.domConverter.removeDomElementAttribute(t,r)}for(let i of e.getAttributeKeys())this.domConverter.setDomElementAttribute(t,i,e.getAttribute(i),e)}}_updateChildren(e,t){let i=this.domConverter.mapViewToDom(e);if(!i)return;if(r.OB.isAndroid){let e=null;for(let t of Array.from(i.childNodes)){if(e&&(0,r.Gs)(e)&&(0,r.Gs)(t)){i.normalize();break}e=t}}let n=t.inlineFillerPosition,s=i.childNodes,o=Array.from(this.domConverter.viewChildrenToDom(e,{bind:!0}));n&&n.parent===e&&eE(i.ownerDocument,o,n.offset);let a=this._diffNodeLists(s,o),l=this._findUpdateActions(a,s,o,eO),h=0,u=new Set;for(let e of l)"delete"===e?(u.add(s[h]),(0,r.Od)(s[h])):("equal"===e||"update"===e)&&h++;for(let e of(h=0,l))"insert"===e?((0,r.ZQ)(i,h,o[h]),h++):"update"===e?(this._updateTextNode(s[h],o[h].data),h++):"equal"===e&&(this._markDescendantTextToSync(this.domConverter.domToView(o[h])),h++);for(let e of u)e.parentNode||this.domConverter.unbindDomElement(e)}_diffNodeLists(e,t){return e=function(e,t){let i=Array.from(e);return 0!=i.length&&t&&i[i.length-1]==t&&i.pop(),i}(e,this._fakeSelectionContainer),(0,r.Hg)(e,t,eT.bind(null,this.domConverter))}_findUpdateActions(e,t,i,n){if(-1===e.indexOf("insert")||-1===e.indexOf("delete"))return e;let s=[],o=[],a=[],l={equal:0,insert:0,delete:0};for(let h of e)"insert"===h?a.push(i[l.equal+l.insert]):"delete"===h?o.push(t[l.equal+l.delete]):((s=s.concat((0,r.Hg)(o,a,n).map(e=>"equal"===e?"update":e))).push("equal"),o=[],a=[]),l[h]++;return s.concat((0,r.Hg)(o,a,n).map(e=>"equal"===e?"update":e))}_updateTextNode(e,t){let i=e.data;i==t||r.OB.isAndroid&&this.isComposing&&i.replace(/\u00A0/g," ")==t.replace(/\u00A0/g," ")||this._updateTextNodeInternal(e,t)}_updateTextNodeInternal(e,t){for(let i of(0,r.HZ)(e.data,t))"insert"===i.type?e.insertData(i.index,i.values.join("")):e.deleteData(i.index,i.howMany)}_markDescendantTextToSync(e){if(e){if(e.is("$text"))this.markedTexts.add(e);else if(e.is("element"))for(let t of e.getChildren())this._markDescendantTextToSync(t)}}_updateSelection(){if(r.OB.isBlink&&!r.OB.isAndroid&&this.isSelecting&&!this.markedChildren.size)return;if(0===this.selection.rangeCount){this._removeDomSelection(),this._removeFakeSelection();return}let e=this.domConverter.mapViewToDom(this.selection.editableElement);this.isFocused&&e&&(this.selection.isFake?this._updateFakeSelection(e):this._fakeSelectionContainer&&this._fakeSelectionContainer.isConnected?(this._removeFakeSelection(),this._updateDomSelection(e)):this.isComposing&&r.OB.isAndroid||this._updateDomSelection(e))}_updateFakeSelection(e){let t=e.ownerDocument;this._fakeSelectionContainer||(this._fakeSelectionContainer=function(e){let t=e.createElement("div");return t.className="ck-fake-selection-container",Object.assign(t.style,{position:"fixed",top:0,left:"-9999px",width:"42px"}),t.textContent="\xa0",t}(t));let i=this._fakeSelectionContainer;if(this.domConverter.bindFakeSelection(i,this.selection),!this._fakeSelectionNeedsUpdate(e))return;i.parentElement&&i.parentElement==e||e.appendChild(i),i.textContent=this.selection.fakeSelectionLabel||"\xa0";let r=t.getSelection(),n=t.createRange();r.removeAllRanges(),n.selectNodeContents(i),r.addRange(n)}_updateDomSelection(e){let t=e.ownerDocument.defaultView.getSelection();if(!this._domSelectionNeedsUpdate(t))return;let i=this.domConverter.viewPositionToDom(this.selection.anchor),n=this.domConverter.viewPositionToDom(this.selection.focus);t.setBaseAndExtent(i.parent,i.offset,n.parent,n.offset),r.OB.isGecko&&function(e,t){let i=e.parent,n=e.offset;if((0,r.Gs)(i)&&eA(i)&&(n=(0,r.cq)(i)+1,i=i.parentNode),i.nodeType!=Node.ELEMENT_NODE||n!=i.childNodes.length-1)return;let s=i.childNodes[n];s&&"BR"==s.tagName&&t.addRange(t.getRangeAt(0))}(n,t)}_domSelectionNeedsUpdate(e){if(!this.domConverter.isDomSelectionCorrect(e))return!0;let t=e&&this.domConverter.domSelectionToView(e);return!(t&&this.selection.isEqual(t)||!this.selection.isCollapsed&&this.selection.isSimilar(t))}_fakeSelectionNeedsUpdate(e){let t=this._fakeSelectionContainer,i=e.ownerDocument.getSelection();return!(t&&t.parentElement===e&&(i.anchorNode===t||t.contains(i.anchorNode)))||t.textContent!==this.selection.fakeSelectionLabel}_removeDomSelection(){for(let e of this.domDocuments){let t=e.getSelection();if(t.rangeCount){let i=e.activeElement,r=this.domConverter.mapDomToView(i);i&&r&&t.removeAllRanges()}}}_removeFakeSelection(){let e=this._fakeSelectionContainer;e&&e.remove()}_updateFocus(){if(this.isFocused){let e=this.selection.editableElement;e&&this.domConverter.focus(e)}}}function eE(e,t,i){let n=t instanceof Array?t:t.childNodes,s=n[i];if((0,r.Gs)(s))return s.data=ev+s.data,s;{let s=e.createTextNode(ev);return Array.isArray(t)?n.splice(i,0,s):(0,r.ZQ)(t,i,s),s}}function eR(e,t){return(0,r.UG)(e)&&(0,r.UG)(t)&&!(0,r.Gs)(e)&&!(0,r.Gs)(t)&&!(0,r.C3)(e)&&!(0,r.C3)(t)&&e.tagName.toLowerCase()===t.tagName.toLowerCase()}function eO(e,t){return(0,r.UG)(e)&&(0,r.UG)(t)&&(0,r.Gs)(e)&&(0,r.Gs)(t)}function eT(e,t,i){return t===i||((0,r.Gs)(t)&&(0,r.Gs)(i)?t.data===i.data:!!(e.isBlockFiller(t)&&e.isBlockFiller(i)))}let ex=ey(r.global.document),eM=ew(r.global.document),eN=eb(r.global.document),eB="data-ck-unsafe-attribute-",eF="data-ck-unsafe-element";class eI{document;renderingMode;blockFillerMode;preElements;blockElements;inlineObjectElements;unsafeElements;_domDocument;_domToViewMapping=new WeakMap;_viewToDomMapping=new WeakMap;_fakeSelectionMapping=new WeakMap;_rawContentElementMatcher=new k;_inlineObjectElementMatcher=new k;_elementsWithTemporaryCustomProperties=new Set;constructor(e,{blockFillerMode:t,renderingMode:i="editing"}={}){this.document=e,this.renderingMode=i,this.blockFillerMode=t||("editing"===i?"br":"nbsp"),this.preElements=["pre","textarea"],this.blockElements=["address","article","aside","blockquote","caption","center","dd","details","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","legend","li","main","menu","nav","ol","p","pre","section","summary","table","tbody","td","tfoot","th","thead","tr","ul"],this.inlineObjectElements=["object","iframe","input","button","textarea","select","option","video","embed","audio","img","canvas"],this.unsafeElements=["script","style"],this._domDocument="editing"===this.renderingMode?r.global.document:r.global.document.implementation.createHTMLDocument("")}bindFakeSelection(e,t){this._fakeSelectionMapping.set(e,new j(t))}fakeSelectionToView(e){return this._fakeSelectionMapping.get(e)}bindElements(e,t){this._domToViewMapping.set(e,t),this._viewToDomMapping.set(t,e)}unbindDomElement(e){let t=this._domToViewMapping.get(e);if(t)for(let i of(this._domToViewMapping.delete(e),this._viewToDomMapping.delete(t),e.children))this.unbindDomElement(i)}bindDocumentFragments(e,t){this._domToViewMapping.set(e,t),this._viewToDomMapping.set(t,e)}shouldRenderAttribute(e,t,i){return"data"===this.renderingMode||!((e=e.toLowerCase()).startsWith("on")||"srcdoc"===e&&t.match(/\bon\S+\s*=|javascript:|<\s*\/*script/i))&&("img"===i&&("src"===e||"srcset"===e)||"source"===i&&"srcset"===e||!t.match(/^\s*(javascript:|data:(image\/svg|text\/x?html))/i))}setContentOf(e,t){let i;if("data"===this.renderingMode){e.innerHTML=t;return}let r=new DOMParser().parseFromString(t,"text/html"),n=r.createDocumentFragment(),s=r.body.childNodes;for(;s.length>0;)n.appendChild(s[0]);let o=r.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),a=[];for(;i=o.nextNode();)a.push(i);for(let e of a){for(let t of e.getAttributeNames())this.setDomElementAttribute(e,t,e.getAttribute(t));let t=e.tagName.toLowerCase();this._shouldRenameElement(t)&&(e$(t),e.replaceWith(this._createReplacementDomElement(t,e)))}for(;e.firstChild;)e.firstChild.remove();e.append(n)}viewToDom(e,t={}){if(e.is("$text")){let t=this._processDataFromViewText(e);return this._domDocument.createTextNode(t)}{let i;if(this.mapViewToDom(e)){if(!e.getCustomProperty("editingPipeline:doNotReuseOnce"))return this.mapViewToDom(e);this._elementsWithTemporaryCustomProperties.add(e)}if(e.is("documentFragment"))i=this._domDocument.createDocumentFragment(),t.bind&&this.bindDocumentFragments(i,e);else if(e.is("uiElement"))return i="$comment"===e.name?this._domDocument.createComment(e.getCustomProperty("$rawContent")):e.render(this._domDocument,this),t.bind&&this.bindElements(i,e),i;else for(let r of(this._shouldRenameElement(e.name)?(e$(e.name),i=this._createReplacementDomElement(e.name)):i=e.hasAttribute("xmlns")?this._domDocument.createElementNS(e.getAttribute("xmlns"),e.name):this._domDocument.createElement(e.name),e.is("rawElement")&&e.render(i,this),t.bind&&this.bindElements(i,e),e.getAttributeKeys()))this.setDomElementAttribute(i,r,e.getAttribute(r),e);if(!1!==t.withChildren)for(let r of this.viewChildrenToDom(e,t))i instanceof HTMLTemplateElement?i.content.appendChild(r):i.appendChild(r);return i}}setDomElementAttribute(e,t,i,n){let s=this.shouldRenderAttribute(t,i,e.tagName.toLowerCase())||n&&n.shouldRenderUnsafeAttribute(t);if(s||(0,r.KE)("domconverter-unsafe-attribute-detected",{domElement:e,key:t,value:i}),!(0,r.$b)(t)){(0,r.KE)("domconverter-invalid-attribute-detected",{domElement:e,key:t,value:i});return}e.hasAttribute(t)&&!s?e.removeAttribute(t):e.hasAttribute(eB+t)&&s&&e.removeAttribute(eB+t),e.setAttribute(s?t:eB+t,i)}removeDomElementAttribute(e,t){t!=eF&&(e.removeAttribute(t),e.removeAttribute(eB+t))}*viewChildrenToDom(e,t={}){let i=e.getFillerOffset&&e.getFillerOffset(),n=0;for(let s of e.getChildren()){i===n&&(yield this._getBlockFiller());let e=s.is("element")&&!!s.getCustomProperty("dataPipeline:transparentRendering")&&!(0,r.Ps)(s.getAttributes());if(e&&"data"==this.renderingMode){if(s.is("rawElement")){let e=this._domDocument.createElement(s.name);s.render(e,this),yield*[...e.childNodes]}else yield*this.viewChildrenToDom(s,t)}else e&&(0,r.KE)("domconverter-transparent-rendering-unsupported-in-editing-pipeline",{viewElement:s}),yield this.viewToDom(s,t);n++}i===n&&(yield this._getBlockFiller())}viewRangeToDom(e){let t=this.viewPositionToDom(e.start),i=this.viewPositionToDom(e.end),r=this._domDocument.createRange();return r.setStart(t.parent,t.offset),r.setEnd(i.parent,i.offset),r}viewPositionToDom(e){let t=e.parent;if(t.is("$text")){let i=this.findCorrespondingDomText(t);if(!i)return null;let r=e.offset;return eP(i)&&(r+=7),{parent:i,offset:r}}{let i,n,s;if(0===e.offset){if(!(i=this.mapViewToDom(t)))return null;s=i.childNodes[0]}else{let t=e.nodeBefore;if(!(n=t.is("$text")?this.findCorrespondingDomText(t):this.mapViewToDom(t)))return null;i=n.parentNode,s=n.nextSibling}return(0,r.Gs)(s)&&eP(s)?{parent:s,offset:7}:{parent:i,offset:n?(0,r.cq)(n)+1:0}}}domToView(e,t={}){let i=[],r=this._domToView(e,t,i),n=r.next().value;return n?(r.next(),this._processDomInlineNodes(null,i,t),n.is("$text")&&0==n.data.length)?null:n:null}*domChildrenToView(e,t={},i=[]){let r=[];e instanceof HTMLTemplateElement?r=[...e.content.childNodes]:r=[...e.childNodes];for(let n=0;n<r.length;n++){let s=r[n],o=this._domToView(s,t,i),a=o.next().value;null!==a&&(this._isBlockViewElement(a)&&this._processDomInlineNodes(e,i,t),yield a,o.next())}this._processDomInlineNodes(e,i,t)}domSelectionToView(e){if(function(e){if(!r.OB.isGecko||!e.rangeCount)return!1;let t=e.getRangeAt(0).startContainer;try{Object.prototype.toString.call(t)}catch(e){return!0}return!1}(e))return new j([]);if(1===e.rangeCount){let t=e.getRangeAt(0).startContainer;(0,r.Gs)(t)&&(t=t.parentNode);let i=this.fakeSelectionToView(t);if(i)return i}let t=this.isDomSelectionBackward(e),i=[];for(let t=0;t<e.rangeCount;t++){let r=e.getRangeAt(t),n=this.domRangeToView(r);n&&i.push(n)}return new j(i,{backward:t})}domRangeToView(e){let t=this.domPositionToView(e.startContainer,e.startOffset),i=this.domPositionToView(e.endContainer,e.endOffset);return t&&i?new L(t,i):null}domPositionToView(e,t=0){if(this.isBlockFiller(e))return this.domPositionToView(e.parentNode,(0,r.cq)(e));let i=this.mapDomToView(e);if(i&&(i.is("uiElement")||i.is("rawElement")))return q._createBefore(i);if((0,r.Gs)(e)){if(eA(e))return this.domPositionToView(e.parentNode,(0,r.cq)(e));let i=this.findCorrespondingViewText(e),n=t;return i?(eP(e)&&(n-=7,n=n<0?0:n),new q(i,n)):null}if(0===t){let t=this.mapDomToView(e);if(t)return new q(t,0)}else{let i=e.childNodes[t-1];if((0,r.Gs)(i)&&eA(i)||i&&this.isBlockFiller(i))return this.domPositionToView(i.parentNode,(0,r.cq)(i));let n=(0,r.Gs)(i)?this.findCorrespondingViewText(i):this.mapDomToView(i);if(n&&n.parent)return new q(n.parent,n.index+1)}return null}mapDomToView(e){return this.getHostViewElement(e)||this._domToViewMapping.get(e)}findCorrespondingViewText(e){if(eA(e))return null;let t=this.getHostViewElement(e);if(t)return t;let i=e.previousSibling;if(i){if(!this.isElement(i))return null;let e=this.mapDomToView(i);if(e){let t=e.nextSibling;if(t instanceof A)return t}}else{let t=this.mapDomToView(e.parentNode);if(t){let e=t.getChild(0);if(e instanceof A)return e}}return null}mapViewToDom(e){return this._viewToDomMapping.get(e)}findCorrespondingDomText(e){let t=e.previousSibling;return t&&this.mapViewToDom(t)?this.mapViewToDom(t).nextSibling:!t&&e.parent&&this.mapViewToDom(e.parent)?this.mapViewToDom(e.parent).childNodes[0]:null}focus(e){let t=this.mapViewToDom(e);if(t&&t.ownerDocument.activeElement!==t){let{scrollX:e,scrollY:i}=r.global.window,n=[];eD(t,e=>{let{scrollLeft:t,scrollTop:i}=e;n.push([t,i])}),t.focus(),eD(t,e=>{let[t,i]=n.shift();e.scrollLeft=t,e.scrollTop=i}),r.global.window.scrollTo(e,i)}}_clearDomSelection(){let e=this.mapViewToDom(this.document.selection.editableElement);if(!e)return;let t=e.ownerDocument.defaultView.getSelection(),i=this.domSelectionToView(t);i&&i.rangeCount>0&&t.removeAllRanges()}isElement(e){return e&&e.nodeType==Node.ELEMENT_NODE}isDocumentFragment(e){return e&&e.nodeType==Node.DOCUMENT_FRAGMENT_NODE}isBlockFiller(e){var t;return"br"==this.blockFillerMode?e.isEqualNode(ex):!!("BR"===e.tagName&&eV(e,this.blockElements))&&1===e.parentNode.childNodes.length||e.isEqualNode(eN)||(t=this.blockElements,e.isEqualNode(eM)&&eV(e,t)&&1===e.parentNode.childNodes.length)}isDomSelectionBackward(e){if(e.isCollapsed)return!1;let t=this._domDocument.createRange();try{t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset)}catch(e){return!1}let i=t.collapsed;return t.detach(),i}getHostViewElement(e){let t=(0,r.dk)(e);for(t.pop();t.length;){let e=t.pop(),i=this._domToViewMapping.get(e);if(i&&(i.is("uiElement")||i.is("rawElement")))return i}return null}isDomSelectionCorrect(e){return this._isDomSelectionPositionCorrect(e.anchorNode,e.anchorOffset)&&this._isDomSelectionPositionCorrect(e.focusNode,e.focusOffset)}registerRawContentMatcher(e){this._rawContentElementMatcher.add(e)}registerInlineObjectMatcher(e){this._inlineObjectElementMatcher.add(e)}_clearTemporaryCustomProperties(){for(let e of this._elementsWithTemporaryCustomProperties)e._removeCustomProperty("editingPipeline:doNotReuseOnce");this._elementsWithTemporaryCustomProperties.clear()}_getBlockFiller(){switch(this.blockFillerMode){case"nbsp":return ew(this._domDocument);case"markedNbsp":return eb(this._domDocument);case"br":return ey(this._domDocument)}}_isDomSelectionPositionCorrect(e,t){if((0,r.Gs)(e)&&eP(e)&&t<7||this.isElement(e)&&eP(e.childNodes[t]))return!1;let i=this.mapDomToView(e);return!(i&&(i.is("uiElement")||i.is("rawElement")))}*_domToView(e,t,i){if(this.isBlockFiller(e))return null;let n=this.getHostViewElement(e);if(n)return n;if((0,r.C3)(e)&&t.skipComments)return null;if((0,r.Gs)(e)){if(eA(e))return null;{let t=e.data;if(""===t)return null;let r=new A(this.document,t);return i.push(r),r}}{let n=this.mapDomToView(e);if(n)return this._isInlineObjectElement(n)&&i.push(n),n;if(this.isDocumentFragment(e))n=new el(this.document),t.bind&&this.bindDocumentFragments(e,n);else{n=this._createViewElement(e,t),t.bind&&this.bindElements(e,n);let s=e.attributes;if(s)for(let e=s.length,t=0;t<e;t++)n._setAttribute(s[t].name,s[t].value);if(this._isViewElementWithRawContent(n,t))return n._setCustomProperty("$rawContent",e.innerHTML),this._isBlockViewElement(n)||i.push(n),n;if((0,r.C3)(e))return n._setCustomProperty("$rawContent",e.data),n}yield n;let s=[];if(!1!==t.withChildren)for(let i of this.domChildrenToView(e,t,s))n._appendChild(i);if(this._isInlineObjectElement(n))i.push(n),this._processDomInlineNodes(null,s,t);else for(let e of s)i.push(e)}}_processDomInlineNodes(e,t,i){if(!t.length||e&&!this.isDocumentFragment(e)&&!this._isBlockDomElement(e))return;let r=!1;for(let e=0;e<t.length;e++){let n;let s=t[e];if(!s.is("$text")){r=!1;continue}let o=!1;if(this._isPreFormatted(s))n=eC(s.data);else{n=s.data.replace(/[ \n\t\r]{1,}/g," "),o=/[^\S\u00A0]/.test(n.charAt(n.length-1));let a=e>0?t[e-1]:null,l=e+1<t.length?t[e+1]:null,h=!a||a.is("element")&&"br"==a.name||r,u=!l&&!eP(s.data);!1!==i.withChildren&&(h&&(n=n.replace(/^ /,"")),u&&(n=n.replace(/ $/,""))),n=(n=eC(n)).replace(/ \u00A0/g,"  ");let d=l&&l.is("element")&&"br"!=l.name,c=l&&l.is("$text")&&" "==l.data.charAt(0);(/[ \u00A0]\u00A0$/.test(n)||!l||d||c)&&(n=n.replace(/\u00A0$/," ")),(h||a&&a.is("element")&&"br"!=a.name)&&(n=n.replace(/^\u00A0/," "))}0==n.length&&s.parent?(s._remove(),t.splice(e,1),e--):(s._data=n,r=o)}t.length=0}_processDataFromViewText(e){let t=e.data;if(this._isPreFormatted(e))return t;if(" "==t.charAt(0)){let i=this._getTouchingInlineViewNode(e,!1);(i&&i.is("$textProxy")&&this._nodeEndsWithSpace(i)||!i)&&(t="\xa0"+t.substr(1))}if(" "==t.charAt(t.length-1)){let i=this._getTouchingInlineViewNode(e,!0),r=i&&i.is("$textProxy")&&" "==i.data.charAt(0);(" "==t.charAt(t.length-2)||!i||r)&&(t=t.substr(0,t.length-1)+"\xa0")}return t.replace(/ {2}/g," \xa0")}_nodeEndsWithSpace(e){if(this._isPreFormatted(e))return!1;let t=this._processDataFromViewText(e);return" "==t.charAt(t.length-1)}_isPreFormatted(e){var t;if(t=this.preElements,e.getAncestors().some(e=>e.is("element")&&t.includes(e.name)))return!0;for(let t of e.getAncestors({parentFirst:!0}))if(t.is("element")&&t.hasStyle("white-space")&&"inherit"!==t.getStyle("white-space"))return["pre","pre-wrap","break-spaces"].includes(t.getStyle("white-space"));return!1}_getTouchingInlineViewNode(e,t){for(let{item:i}of new $({startPosition:t?q._createAfter(e):q._createBefore(e),direction:t?"forward":"backward"})){if(i.is("$textProxy"))return i;if(!(i.is("element")&&i.getCustomProperty("dataPipeline:transparentRendering"))){if(i.is("element","br"))break;else if(this._isInlineObjectElement(i))return i;else if(i.is("containerElement"))break}}return null}_isBlockDomElement(e){return this.isElement(e)&&this.blockElements.includes(e.tagName.toLowerCase())}_isBlockViewElement(e){return e.is("element")&&this.blockElements.includes(e.name)}_isInlineObjectElement(e){return!!e.is("element")&&("br"==e.name||this.inlineObjectElements.includes(e.name)||!!this._inlineObjectElementMatcher.match(e))}_createViewElement(e,t){if((0,r.C3)(e))return new en(this.document,"$comment");let i=t.keepOriginalCase?e.tagName:e.tagName.toLowerCase();return new M(this.document,i)}_isViewElementWithRawContent(e,t){return!1!==t.withChildren&&e.is("element")&&!!this._rawContentElementMatcher.match(e)}_shouldRenameElement(e){let t=e.toLowerCase();return"editing"===this.renderingMode&&this.unsafeElements.includes(t)}_createReplacementDomElement(e,t){let i=this._domDocument.createElement("span");if(i.setAttribute(eF,e),t){for(;t.firstChild;)i.appendChild(t.firstChild);for(let e of t.getAttributeNames())i.setAttribute(e,t.getAttribute(e))}return i}}function eD(e,t){let i=e;for(;i;)t(i),i=i.parentElement}function eV(e,t){let i=e.parentNode;return!!i&&!!i.tagName&&t.includes(i.tagName.toLowerCase())}function e$(e){"script"===e&&(0,r.KE)("domconverter-unsafe-script-element-detected"),"style"===e&&(0,r.KE)("domconverter-unsafe-style-element-detected")}class eq extends(0,r.Xu)(){view;document;_isEnabled=!1;constructor(e){super(),this.view=e,this.document=e.document}get isEnabled(){return this._isEnabled}enable(){this._isEnabled=!0}disable(){this._isEnabled=!1}destroy(){this.disable(),this.stopListening()}checkShouldIgnoreEventFromTarget(e){return e&&3===e.nodeType&&(e=e.parentNode),!!e&&1===e.nodeType&&e.matches("[data-cke-ignore-events], [data-cke-ignore-events] *")}}class eL{view;document;domEvent;domTarget;constructor(e,t,i){this.view=e,this.document=e.document,this.domEvent=t,this.domTarget=t.target,(0,d.Z)(this,i)}get target(){return this.view.domConverter.mapDomToView(this.domTarget)}preventDefault(){this.domEvent.preventDefault()}stopPropagation(){this.domEvent.stopPropagation()}}class eW extends eq{useCapture=!1;usePassive=!1;observe(e){("string"==typeof this.domEventType?[this.domEventType]:this.domEventType).forEach(t=>{this.listenTo(e,t,(e,t)=>{this.isEnabled&&!this.checkShouldIgnoreEventFromTarget(t.target)&&this.onDomEvent(t)},{useCapture:this.useCapture,usePassive:this.usePassive})})}stopObserving(e){this.stopListening(e)}fire(e,t,i){this.isEnabled&&this.document.fire(e,new eL(this.view,t,i))}}class ej extends eW{domEventType=["keydown","keyup"];onDomEvent(e){let t={keyCode:e.keyCode,altKey:e.altKey,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,metaKey:e.metaKey,get keystroke(){return(0,r.Cq)(this)}};this.fire(e.type,e,t)}}class eU extends eq{_fireSelectionChangeDoneDebounced;constructor(e){super(e),this._fireSelectionChangeDoneDebounced=(0,c.Z)(e=>{this.document.fire("selectionChangeDone",e)},200)}observe(){let e=this.document;e.on("arrowKey",(t,i)=>{e.selection.isFake&&this.isEnabled&&i.preventDefault()},{context:"$capture"}),e.on("arrowKey",(t,i)=>{e.selection.isFake&&this.isEnabled&&this._handleSelectionMove(i.keyCode)},{priority:"lowest"})}stopObserving(){}destroy(){super.destroy(),this._fireSelectionChangeDoneDebounced.cancel()}_handleSelectionMove(e){let t=this.document.selection,i=new j(t.getRanges(),{backward:t.isBackward,fake:!1});(e==r.Do.arrowleft||e==r.Do.arrowup)&&i.setTo(i.getFirstPosition()),(e==r.Do.arrowright||e==r.Do.arrowdown)&&i.setTo(i.getLastPosition());let n={oldSelection:t,newSelection:i,domSelection:null};this.document.fire("selectionChange",n),this._fireSelectionChangeDoneDebounced(n)}}class eJ extends eq{domConverter;_config;_domElements;_mutationObserver;constructor(e){super(e),this._config={childList:!0,characterData:!0,subtree:!0},this.domConverter=e.domConverter,this._domElements=new Set,this._mutationObserver=new window.MutationObserver(this._onMutations.bind(this))}flush(){this._onMutations(this._mutationObserver.takeRecords())}observe(e){this._domElements.add(e),this.isEnabled&&this._mutationObserver.observe(e,this._config)}stopObserving(e){if(this._domElements.delete(e),this.isEnabled)for(let e of(this._mutationObserver.disconnect(),this._domElements))this._mutationObserver.observe(e,this._config)}enable(){for(let e of(super.enable(),this._domElements))this._mutationObserver.observe(e,this._config)}disable(){super.disable(),this._mutationObserver.disconnect()}destroy(){super.destroy(),this._mutationObserver.disconnect()}_onMutations(e){if(0===e.length)return;let t=this.domConverter,i=new Set,r=new Set;for(let i of e){let e=t.mapDomToView(i.target);!(!e||e.is("uiElement")||e.is("rawElement"))&&("childList"!==i.type||this._isBogusBrMutation(i)||r.add(e))}for(let n of e){let e=t.mapDomToView(n.target);if(!(e&&(e.is("uiElement")||e.is("rawElement")))&&"characterData"===n.type){let e=t.findCorrespondingViewText(n.target);e&&!r.has(e.parent)?i.add(e):!e&&eP(n.target)&&r.add(t.mapDomToView(n.target.parentNode))}}let n=[];for(let e of i)n.push({type:"text",node:e});for(let e of r){let i=t.mapViewToDom(e),r=Array.from(e.getChildren()),s=Array.from(t.domChildrenToView(i,{withChildren:!1}));(0,f.Z)(r,s,eK)||n.push({type:"children",node:e})}n.length&&this.document.fire("mutations",{mutations:n})}_isBogusBrMutation(e){let t=null;return null===e.nextSibling&&0===e.removedNodes.length&&1==e.addedNodes.length&&(t=this.domConverter.domToView(e.addedNodes[0],{withChildren:!1})),t&&t.is("element","br")}}function eK(e,t){return Array.isArray(e)?void 0:e===t||!!(e.is("$text")&&t.is("$text"))&&e.data===t.data}class eG extends eW{_renderTimeoutId=null;_isFocusChanging=!1;domEventType=["focus","blur"];constructor(e){super(e),this.useCapture=!0;let t=this.document;t.on("focus",()=>this._handleFocus()),t.on("blur",(e,t)=>this._handleBlur(t)),t.on("beforeinput",()=>{t.isFocused||this._handleFocus()},{priority:"highest"})}flush(){this._isFocusChanging&&(this._isFocusChanging=!1,this.document.isFocused=!0)}onDomEvent(e){this.fire(e.type,e)}destroy(){this._clearTimeout(),super.destroy()}_handleFocus(){this._clearTimeout(),this._isFocusChanging=!0,this._renderTimeoutId=setTimeout(()=>{this._renderTimeoutId=null,this.flush(),this.view.change(()=>{})},50)}_handleBlur(e){let t=this.document.selection.editableElement;(null===t||t===e.target)&&(this.document.isFocused=!1,this._isFocusChanging=!1,this.view.change(()=>{}))}_clearTimeout(){this._renderTimeoutId&&(clearTimeout(this._renderTimeoutId),this._renderTimeoutId=null)}}class ez extends eq{mutationObserver;focusObserver;selection;domConverter;_documents;_fireSelectionChangeDoneDebounced;_clearInfiniteLoopInterval;_documentIsSelectingInactivityTimeoutDebounced;_loopbackCounter;constructor(e){super(e),this.mutationObserver=e.getObserver(eJ),this.focusObserver=e.getObserver(eG),this.selection=this.document.selection,this.domConverter=e.domConverter,this._documents=new WeakSet,this._fireSelectionChangeDoneDebounced=(0,c.Z)(e=>{this.document.fire("selectionChangeDone",e)},200),this._clearInfiniteLoopInterval=setInterval(()=>this._clearInfiniteLoop(),1e3),this._documentIsSelectingInactivityTimeoutDebounced=(0,c.Z)(()=>this.document.isSelecting=!1,5e3),this._loopbackCounter=0}observe(e){let t=e.ownerDocument,i=()=>{this.document.isSelecting&&(this._handleSelectionChange(t),this.document.isSelecting=!1,this._documentIsSelectingInactivityTimeoutDebounced.cancel())};this.listenTo(e,"selectstart",()=>{this.document.isSelecting=!0,this._documentIsSelectingInactivityTimeoutDebounced()},{priority:"highest"}),this.listenTo(e,"keydown",i,{priority:"highest",useCapture:!0}),this.listenTo(e,"keyup",i,{priority:"highest",useCapture:!0}),this._documents.has(t)||(this.listenTo(t,"mouseup",i,{priority:"highest",useCapture:!0}),this.listenTo(t,"selectionchange",()=>{(!this.document.isComposing||r.OB.isAndroid)&&(this._handleSelectionChange(t),this._documentIsSelectingInactivityTimeoutDebounced())}),this.listenTo(this.view.document,"compositionstart",()=>{this._handleSelectionChange(t)},{priority:"lowest"}),this._documents.add(t))}stopObserving(e){this.stopListening(e)}destroy(){super.destroy(),clearInterval(this._clearInfiniteLoopInterval),this._fireSelectionChangeDoneDebounced.cancel(),this._documentIsSelectingInactivityTimeoutDebounced.cancel()}_reportInfiniteLoop(){}_handleSelectionChange(e){if(!this.isEnabled)return;let t=e.defaultView.getSelection();if(this.checkShouldIgnoreEventFromTarget(t.anchorNode))return;this.mutationObserver.flush();let i=this.domConverter.domSelectionToView(t);if(0==i.rangeCount){this.view.hasDomSelection=!1;return}if(this.view.hasDomSelection=!0,this.focusObserver.flush(),!(this.selection.isEqual(i)&&this.domConverter.isDomSelectionCorrect(t))){if(++this._loopbackCounter>60){this._reportInfiniteLoop();return}if(this.selection.isSimilar(i))this.view.forceRender();else{let e={oldSelection:this.selection,newSelection:i,domSelection:t};this.document.fire("selectionChange",e),this._fireSelectionChangeDoneDebounced(e)}}}_clearInfiniteLoop(){this._loopbackCounter=0}}class eH extends eW{domEventType=["compositionstart","compositionupdate","compositionend"];constructor(e){super(e);let t=this.document;t.on("compositionstart",()=>{t.isComposing=!0},{priority:"low"}),t.on("compositionend",()=>{t.isComposing=!1},{priority:"low"})}onDomEvent(e){this.fire(e.type,e,{data:e.data})}}class eZ{_files;_native;constructor(e,t={}){this._files=t.cacheFiles?eY(e):null,this._native=e}get files(){return this._files||(this._files=eY(this._native)),this._files}get types(){return this._native.types}getData(e){return this._native.getData(e)}setData(e,t){this._native.setData(e,t)}set effectAllowed(e){this._native.effectAllowed=e}get effectAllowed(){return this._native.effectAllowed}set dropEffect(e){this._native.dropEffect=e}get dropEffect(){return this._native.dropEffect}setDragImage(e,t,i){this._native.setDragImage(e,t,i)}get isCanceled(){return"none"==this._native.dropEffect||!!this._native.mozUserCancelled}}function eY(e){let t=Array.from(e.files||[]),i=Array.from(e.items||[]);return t.length?t:i.filter(e=>"file"===e.kind).map(e=>e.getAsFile())}class eQ extends eW{domEventType="beforeinput";onDomEvent(e){let t=e.getTargetRanges(),i=this.view,n=i.document,s=null,o=null,a=[];if(e.dataTransfer&&(s=new eZ(e.dataTransfer)),null!==e.data?o=e.data:s&&(o=s.getData("text/plain")),n.selection.isFake)a=Array.from(n.selection.getRanges());else if(t.length)a=t.map(e=>{let t=i.domConverter.domPositionToView(e.startContainer,e.startOffset),r=i.domConverter.domPositionToView(e.endContainer,e.endOffset);return t?i.createRange(t,r):r?i.createRange(r):void 0}).filter(e=>!!e);else if(r.OB.isAndroid){let t=e.target.ownerDocument.defaultView.getSelection();a=Array.from(i.domConverter.domSelectionToView(t).getRanges())}if(r.OB.isAndroid&&"insertCompositionText"==e.inputType&&o&&o.endsWith("\n")){this.fire(e.type,e,{inputType:"insertParagraph",targetRanges:[i.createRange(a[0].end)]});return}if("insertText"==e.inputType&&o&&o.includes("\n")){let t=o.split(/\n{1,2}/g),i=a;for(let r=0;r<t.length;r++){let o=t[r];""!=o&&(this.fire(e.type,e,{data:o,dataTransfer:s,targetRanges:i,inputType:e.inputType,isComposing:e.isComposing}),i=[n.selection.getFirstRange()]),r+1<t.length&&(this.fire(e.type,e,{inputType:"insertParagraph",targetRanges:i}),i=[n.selection.getFirstRange()])}return}this.fire(e.type,e,{data:o,dataTransfer:s,targetRanges:a,inputType:e.inputType,isComposing:e.isComposing})}}class eX extends eq{constructor(e){super(e),this.document.on("keydown",(e,t)=>{if(this.isEnabled&&(0,r.dj)(t.keyCode)){let i=new J(this.document,"arrowKey",this.document.selection.getFirstRange());this.document.fire(i,t),i.stop.called&&e.stop()}})}observe(){}stopObserving(){}}class e0 extends eq{constructor(e){super(e);let t=this.document;t.on("keydown",(e,i)=>{if(!this.isEnabled||i.keyCode!=r.Do.tab||i.ctrlKey)return;let n=new J(t,"tab",t.selection.getFirstRange());t.fire(n,i),n.stop.called&&e.stop()})}observe(){}stopObserving(){}}class e1 extends(0,r.Re)(){document;domConverter;domRoots=new Map;_renderer;_initialDomRootAttributes=new WeakMap;_observers=new Map;_writer;_ongoingChange=!1;_postFixersInProgress=!1;_renderingDisabled=!1;_hasChangedSinceTheLastRendering=!1;constructor(e){super(),this.document=new Q(e),this.domConverter=new eI(this.document),this.set("isRenderingInProgress",!1),this.set("hasDomSelection",!1),this._renderer=new eS(this.domConverter,this.document.selection),this._renderer.bind("isFocused","isSelecting","isComposing").to(this.document,"isFocused","isSelecting","isComposing"),this._writer=new eh(this.document),this.addObserver(eJ),this.addObserver(eG),this.addObserver(ez),this.addObserver(ej),this.addObserver(eU),this.addObserver(eH),this.addObserver(eX),this.addObserver(eQ),this.addObserver(e0),function(e){e.document.on("arrowKey",ek,{priority:"low"})}(this),function(e){e.document.on("arrowKey",(t,i)=>(function(e,t,i){if(t.keyCode==r.Do.arrowright){let e=t.domTarget.ownerDocument.defaultView.getSelection(),r=1==e.rangeCount&&e.getRangeAt(0).collapsed;if(r||t.shiftKey){let t=e.focusNode,n=e.focusOffset,s=i.domPositionToView(t,n);if(null===s)return;let o=!1,a=s.getLastMatchingPosition(e=>(e.item.is("uiElement")&&(o=!0),!!(e.item.is("uiElement")||e.item.is("attributeElement"))));if(o){let t=i.viewPositionToDom(a);r?e.collapse(t.parent,t.offset):e.extend(t.parent,t.offset)}}}})(0,i,e.domConverter),{priority:"low"})}(this),this.on("render",()=>{this._render(),this.document.fire("layoutChanged"),this._hasChangedSinceTheLastRendering=!1}),this.listenTo(this.document.selection,"change",()=>{this._hasChangedSinceTheLastRendering=!0}),this.listenTo(this.document,"change:isFocused",()=>{this._hasChangedSinceTheLastRendering=!0}),r.OB.isiOS&&this.listenTo(this.document,"blur",(e,t)=>{this.domConverter.mapDomToView(t.domEvent.relatedTarget)||this.domConverter._clearDomSelection()}),this.listenTo(this.document,"mutations",(e,{mutations:t})=>{t.forEach(e=>this._renderer.markToSync(e.type,e.node))},{priority:"low"}),this.listenTo(this.document,"mutations",()=>{this.forceRender()},{priority:"lowest"})}attachDomRoot(e,t="main"){let i=this.document.getRoot(t);i._name=e.tagName.toLowerCase();let r={};for(let{name:t,value:n}of Array.from(e.attributes))r[t]=n,"class"===t?this._writer.addClass(n.split(" "),i):i.hasAttribute(t)||this._writer.setAttribute(t,n,i);this._initialDomRootAttributes.set(e,r);let n=()=>{this._writer.setAttribute("contenteditable",(!i.isReadOnly).toString(),i),i.isReadOnly?this._writer.addClass("ck-read-only",i):this._writer.removeClass("ck-read-only",i)};for(let r of(n(),this.domRoots.set(t,e),this.domConverter.bindElements(e,i),this._renderer.markToSync("children",i),this._renderer.markToSync("attributes",i),this._renderer.domDocuments.add(e.ownerDocument),i.on("change:children",(e,t)=>this._renderer.markToSync("children",t)),i.on("change:attributes",(e,t)=>this._renderer.markToSync("attributes",t)),i.on("change:text",(e,t)=>this._renderer.markToSync("text",t)),i.on("change:isReadOnly",()=>this.change(n)),i.on("change",()=>{this._hasChangedSinceTheLastRendering=!0}),this._observers.values()))r.observe(e,t)}detachDomRoot(e){let t=this.domRoots.get(e);Array.from(t.attributes).forEach(({name:e})=>t.removeAttribute(e));let i=this._initialDomRootAttributes.get(t);for(let e in i)t.setAttribute(e,i[e]);for(let i of(this.domRoots.delete(e),this.domConverter.unbindDomElement(t),this._observers.values()))i.stopObserving(t)}getDomRoot(e="main"){return this.domRoots.get(e)}addObserver(e){let t=this._observers.get(e);if(t)return t;for(let[i,r]of(t=new e(this),this._observers.set(e,t),this.domRoots))t.observe(r,i);return t.enable(),t}getObserver(e){return this._observers.get(e)}disableObservers(){for(let e of this._observers.values())e.disable()}enableObservers(){for(let e of this._observers.values())e.enable()}scrollToTheSelection({alignToTop:e,forceScroll:t,viewportOffset:i=20,ancestorOffset:n=20}={}){let s=this.document.selection.getFirstRange();if(!s)return;let o=(0,m.Z)({alignToTop:e,forceScroll:t,viewportOffset:i,ancestorOffset:n});"number"==typeof i&&(i={top:i,bottom:i,left:i,right:i});let a={target:this.domConverter.viewRangeToDom(s),viewportOffset:i,ancestorOffset:n,alignToTop:e,forceScroll:t};this.fire("scrollToTheSelection",a,o),(0,r.mR)(a)}focus(){if(!this.document.isFocused){let e=this.document.selection.editableElement;e&&(this.domConverter.focus(e),this.forceRender())}}change(e){if(this.isRenderingInProgress||this._postFixersInProgress)throw new r.Bb("cannot-change-view-tree",this);try{if(this._ongoingChange)return e(this._writer);this._ongoingChange=!0;let t=e(this._writer);return this._ongoingChange=!1,!this._renderingDisabled&&this._hasChangedSinceTheLastRendering&&(this._postFixersInProgress=!0,this.document._callPostFixers(this._writer),this._postFixersInProgress=!1,this.fire("render")),t}catch(e){r.Bb.rethrowUnexpectedError(e,this)}}forceRender(){this._hasChangedSinceTheLastRendering=!0,this.getObserver(eG).flush(),this.change(()=>{})}destroy(){for(let e of this._observers.values())e.destroy();this.document.destroy(),this.stopListening()}createPositionAt(e,t){return q._createAt(e,t)}createPositionAfter(e){return q._createAfter(e)}createPositionBefore(e){return q._createBefore(e)}createRange(e,t){return new L(e,t)}createRangeOn(e){return L._createOn(e)}createRangeIn(e){return L._createIn(e)}createSelection(...e){return new j(...e)}_disableRendering(e){this._renderingDisabled=e,!1==e&&this.change(()=>{})}_render(){this.isRenderingInProgress=!0,this.disableObservers(),this._renderer.render(),this.enableObservers(),this.isRenderingInProgress=!1}}class e3{is(){throw Error("is() method is abstract")}}let e9=class extends e3{parent=null;_attrs;_index=null;_startOffset=null;constructor(e){super(),this._attrs=(0,r.qL)(e)}get document(){return null}get index(){return this._index}get startOffset(){return this._startOffset}get offsetSize(){return 1}get endOffset(){return null===this.startOffset?null:this.startOffset+this.offsetSize}get nextSibling(){let e=this.index;return null!==e&&this.parent.getChild(e+1)||null}get previousSibling(){let e=this.index;return null!==e&&this.parent.getChild(e-1)||null}get root(){let e=this;for(;e.parent;)e=e.parent;return e}isAttached(){return null!==this.parent&&this.root.isAttached()}getPath(){let e=[],t=this;for(;t.parent;)e.unshift(t.startOffset),t=t.parent;return e}getAncestors(e={}){let t=[],i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}getCommonAncestor(e,t={}){let i=this.getAncestors(t),r=e.getAncestors(t),n=0;for(;i[n]==r[n]&&i[n];)n++;return 0===n?null:i[n-1]}isBefore(e){if(this==e||this.root!==e.root)return!1;let t=this.getPath(),i=e.getPath(),n=(0,r.Rt)(t,i);switch(n){case"prefix":return!0;case"extension":return!1;default:return t[n]<i[n]}}isAfter(e){return this!=e&&this.root===e.root&&!this.isBefore(e)}hasAttribute(e){return this._attrs.has(e)}getAttribute(e){return this._attrs.get(e)}getAttributes(){return this._attrs.entries()}getAttributeKeys(){return this._attrs.keys()}toJSON(){let e={};return this._attrs.size&&(e.attributes=Array.from(this._attrs).reduce((e,t)=>(e[t[0]]=t[1],e),{})),e}_clone(e){return new this.constructor(this._attrs)}_remove(){this.parent._removeChildren(this.index)}_setAttribute(e,t){this._attrs.set(e,t)}_setAttributesTo(e){this._attrs=(0,r.qL)(e)}_removeAttribute(e){return this._attrs.delete(e)}_clearAttributes(){this._attrs.clear()}};e9.prototype.is=function(e){return"node"===e||"model:node"===e};class e2{_nodes=[];_offsetToNode=[];constructor(e){e&&this._insertNodes(0,e)}[Symbol.iterator](){return this._nodes[Symbol.iterator]()}get length(){return this._nodes.length}get maxOffset(){return this._offsetToNode.length}getNode(e){return this._nodes[e]||null}getNodeAtOffset(e){return this._offsetToNode[e]||null}getNodeIndex(e){return e.index}getNodeStartOffset(e){return e.startOffset}indexToOffset(e){if(e==this._nodes.length)return this.maxOffset;let t=this._nodes[e];if(!t)throw new r.Bb("model-nodelist-index-out-of-bounds",this);return this.getNodeStartOffset(t)}offsetToIndex(e){if(e==this._offsetToNode.length)return this._nodes.length;let t=this._offsetToNode[e];if(!t)throw new r.Bb("model-nodelist-offset-out-of-bounds",this,{offset:e,nodeList:this});return this.getNodeIndex(t)}_insertNodes(e,t){for(let e of t)if(!(e instanceof e9))throw new r.Bb("model-nodelist-insertnodes-not-node",this);let i=Array.from(t),n=function(e){let t=[];for(let i of e){let e=t.length;t.length+=i.offsetSize,t.fill(i,e)}return t}(i),s=this.indexToOffset(e);this._nodes=(0,r.x)(this._nodes,i,e,0),this._offsetToNode=(0,r.x)(this._offsetToNode,n,s,0);for(let t=e;t<this._nodes.length;t++)this._nodes[t]._index=t,this._nodes[t]._startOffset=s,s+=this._nodes[t].offsetSize}_removeNodes(e,t=1){if(0==t)return[];let i=this.indexToOffset(e),r=this._nodes.splice(e,t),n=r[r.length-1],s=n.startOffset+n.offsetSize-i;for(let e of(this._offsetToNode.splice(i,s),r))e._index=null,e._startOffset=null;for(let t=e;t<this._nodes.length;t++)this._nodes[t]._index=t,this._nodes[t]._startOffset=i,i+=this._nodes[t].offsetSize;return r}toJSON(){return this._nodes.map(e=>e.toJSON())}}class e7 extends e9{_data;constructor(e,t){super(t),this._data=e||""}get offsetSize(){return this.data.length}get data(){return this._data}toJSON(){let e=super.toJSON();return e.data=this.data,e}_clone(){return new e7(this.data,this.getAttributes())}static fromJSON(e){return new e7(e.data,e.attributes)}}e7.prototype.is=function(e){return"$text"===e||"model:$text"===e||"text"===e||"model:text"===e||"node"===e||"model:node"===e};class e6 extends e3{textNode;data;offsetInText;constructor(e,t,i){if(super(),this.textNode=e,t<0||t>e.offsetSize)throw new r.Bb("model-textproxy-wrong-offsetintext",this);if(i<0||t+i>e.offsetSize)throw new r.Bb("model-textproxy-wrong-length",this);this.data=e.data.substring(t,t+i),this.offsetInText=t}get startOffset(){return null!==this.textNode.startOffset?this.textNode.startOffset+this.offsetInText:null}get offsetSize(){return this.data.length}get endOffset(){return null!==this.startOffset?this.startOffset+this.offsetSize:null}get isPartial(){return this.offsetSize!==this.textNode.offsetSize}get parent(){return this.textNode.parent}get root(){return this.textNode.root}getPath(){let e=this.textNode.getPath();return e.length>0&&(e[e.length-1]+=this.offsetInText),e}getAncestors(e={}){let t=[],i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}hasAttribute(e){return this.textNode.hasAttribute(e)}getAttribute(e){return this.textNode.getAttribute(e)}getAttributes(){return this.textNode.getAttributes()}getAttributeKeys(){return this.textNode.getAttributeKeys()}}e6.prototype.is=function(e){return"$textProxy"===e||"model:$textProxy"===e||"textProxy"===e||"model:textProxy"===e};class e4 extends e9{name;_children=new e2;constructor(e,t,i){super(t),this.name=e,i&&this._insertChild(0,i)}get childCount(){return this._children.length}get maxOffset(){return this._children.maxOffset}get isEmpty(){return 0===this.childCount}getChild(e){return this._children.getNode(e)}getChildAtOffset(e){return this._children.getNodeAtOffset(e)}getChildren(){return this._children[Symbol.iterator]()}getChildIndex(e){return this._children.getNodeIndex(e)}getChildStartOffset(e){return this._children.getNodeStartOffset(e)}offsetToIndex(e){return this._children.offsetToIndex(e)}getNodeByPath(e){let t=this;for(let i of e)t=t.getChildAtOffset(i);return t}findAncestor(e,t={}){let i=t.includeSelf?this:this.parent;for(;i;){if(i.name===e)return i;i=i.parent}return null}toJSON(){let e=super.toJSON();if(e.name=this.name,this._children.length>0)for(let t of(e.children=[],this._children))e.children.push(t.toJSON());return e}_clone(e=!1){let t=e?Array.from(this._children).map(e=>e._clone(!0)):void 0;return new e4(this.name,this.getAttributes(),t)}_appendChild(e){this._insertChild(this.childCount,e)}_insertChild(e,t){var i;let n="string"==typeof(i=t)?[new e7(i)]:((0,r.TW)(i)||(i=[i]),Array.from(i).map(e=>"string"==typeof e?new e7(e):e instanceof e6?new e7(e.data,e.getAttributes()):e));for(let e of n)null!==e.parent&&e._remove(),e.parent=this;this._children._insertNodes(e,n)}_removeChildren(e,t=1){let i=this._children._removeNodes(e,t);for(let e of i)e.parent=null;return i}static fromJSON(e){let t;if(e.children)for(let i of(t=[],e.children))i.name?t.push(e4.fromJSON(i)):t.push(e7.fromJSON(i));return new e4(e.name,e.attributes,t)}}e4.prototype.is=function(e,t){return t?t===this.name&&("element"===e||"model:element"===e):"element"===e||"model:element"===e||"node"===e||"model:node"===e};class e5{direction;boundaries;singleCharacters;shallow;ignoreElementEnd;_position;_boundaryStartParent;_boundaryEndParent;_visitedParent;constructor(e){if(!e||!e.boundaries&&!e.startPosition)throw new r.Bb("model-tree-walker-no-start-position",null);let t=e.direction||"forward";if("forward"!=t&&"backward"!=t)throw new r.Bb("model-tree-walker-unknown-direction",e,{direction:t});this.direction=t,this.boundaries=e.boundaries||null,e.startPosition?this._position=e.startPosition.clone():this._position=te._createAt(this.boundaries["backward"==this.direction?"end":"start"]),this.position.stickiness="toNone",this.singleCharacters=!!e.singleCharacters,this.shallow=!!e.shallow,this.ignoreElementEnd=!!e.ignoreElementEnd,this._boundaryStartParent=this.boundaries?this.boundaries.start.parent:null,this._boundaryEndParent=this.boundaries?this.boundaries.end.parent:null,this._visitedParent=this.position.parent}[Symbol.iterator](){return this}get position(){return this._position}skip(e){let t,i,r,n;do r=this.position,n=this._visitedParent,{done:t,value:i}=this.next();while(!t&&e(i));t||(this._position=r,this._visitedParent=n)}next(){return"forward"==this.direction?this._next():this._previous()}_next(){let e=this.position,t=this.position.clone(),i=this._visitedParent;if(null===i.parent&&t.offset===i.maxOffset||i===this._boundaryEndParent&&t.offset==this.boundaries.end.offset)return{done:!0,value:void 0};let r=tt(t,i),n=r||ti(t,i,r);if(n instanceof e4){if(this.shallow){if(this.boundaries&&this.boundaries.end.isBefore(t))return{done:!0,value:void 0};t.offset++}else t.path.push(0),this._visitedParent=n;return this._position=t,e8("elementStart",n,e,t,1)}if(n instanceof e7){let r;if(this.singleCharacters)r=1;else{let e=n.endOffset;this._boundaryEndParent==i&&this.boundaries.end.offset<e&&(e=this.boundaries.end.offset),r=e-t.offset}let s=t.offset-n.startOffset,o=new e6(n,s,r);return t.offset+=r,this._position=t,e8("text",o,e,t,r)}return(t.path.pop(),t.offset++,this._position=t,this._visitedParent=i.parent,this.ignoreElementEnd)?this._next():e8("elementEnd",i,e,t)}_previous(){let e=this.position,t=this.position.clone(),i=this._visitedParent;if(null===i.parent&&0===t.offset||i==this._boundaryStartParent&&t.offset==this.boundaries.start.offset)return{done:!0,value:void 0};let r=t.parent,n=tt(t,r),s=n||tr(t,r,n);if(s instanceof e4)return(t.offset--,this.shallow)?(this._position=t,e8("elementStart",s,e,t,1)):(t.path.push(s.maxOffset),this._position=t,this._visitedParent=s,this.ignoreElementEnd)?this._previous():e8("elementEnd",s,e,t);if(s instanceof e7){let r;if(this.singleCharacters)r=1;else{let e=s.startOffset;this._boundaryStartParent==i&&this.boundaries.start.offset>e&&(e=this.boundaries.start.offset),r=t.offset-e}let n=t.offset-s.startOffset,o=new e6(s,n-r,r);return t.offset-=r,this._position=t,e8("text",o,e,t,r)}return t.path.pop(),this._position=t,this._visitedParent=i.parent,e8("elementStart",i,e,t,1)}}function e8(e,t,i,r,n){return{done:!1,value:{type:e,item:t,previousPosition:i,nextPosition:r,length:n}}}class te extends e3{root;path;stickiness;constructor(e,t,i="toNone"){if(super(),!e.is("element")&&!e.is("documentFragment"))throw new r.Bb("model-position-root-invalid",e);if(!(t instanceof Array)||0===t.length)throw new r.Bb("model-position-path-incorrect-format",e,{path:t});e.is("rootElement")?t=t.slice():(t=[...e.getPath(),...t],e=e.root),this.root=e,this.path=t,this.stickiness=i}get offset(){return this.path[this.path.length-1]}set offset(e){this.path[this.path.length-1]=e}get parent(){let e=this.root;for(let t=0;t<this.path.length-1;t++)if(!(e=e.getChildAtOffset(this.path[t])))throw new r.Bb("model-position-path-incorrect",this,{position:this});if(e.is("$text"))throw new r.Bb("model-position-path-incorrect",this,{position:this});return e}get index(){return this.parent.offsetToIndex(this.offset)}get textNode(){return tt(this,this.parent)}get nodeAfter(){let e=this.parent;return ti(this,e,tt(this,e))}get nodeBefore(){let e=this.parent;return tr(this,e,tt(this,e))}get isAtStart(){return 0===this.offset}get isAtEnd(){return this.offset==this.parent.maxOffset}isValid(){if(this.offset<0)return!1;let e=this.root;for(let t=0;t<this.path.length-1;t++)if(!(e=e.getChildAtOffset(this.path[t])))return!1;return this.offset<=e.maxOffset}compareWith(e){if(this.root!=e.root)return"different";let t=(0,r.Rt)(this.path,e.path);switch(t){case"same":return"same";case"prefix":return"before";case"extension":return"after";default:return this.path[t]<e.path[t]?"before":"after"}}getLastMatchingPosition(e,t={}){t.startPosition=this;let i=new e5(t);return i.skip(e),i.position}getParentPath(){return this.path.slice(0,-1)}getAncestors(){let e=this.parent;return e.is("documentFragment")?[e]:e.getAncestors({includeSelf:!0})}findAncestor(e){let t=this.parent;return t.is("element")?t.findAncestor(e,{includeSelf:!0}):null}getCommonPath(e){if(this.root!=e.root)return[];let t=(0,r.Rt)(this.path,e.path),i="string"==typeof t?Math.min(this.path.length,e.path.length):t;return this.path.slice(0,i)}getCommonAncestor(e){let t=this.getAncestors(),i=e.getAncestors(),r=0;for(;t[r]==i[r]&&t[r];)r++;return 0===r?null:t[r-1]}getShiftedBy(e){let t=this.clone(),i=t.offset+e;return t.offset=i<0?0:i,t}isAfter(e){return"after"==this.compareWith(e)}isBefore(e){return"before"==this.compareWith(e)}isEqual(e){return"same"==this.compareWith(e)}isTouching(e){if(this.root!==e.root)return!1;let t=Math.min(this.path.length,e.path.length);for(let i=0;i<t;i++){let t=this.path[i]-e.path[i];if(t<-1||t>1)return!1;if(1===t)return tn(e,this,i);if(-1===t)return tn(this,e,i)}return this.path.length===e.path.length||(this.path.length>e.path.length?ts(this.path,t):ts(e.path,t))}hasSameParentAs(e){if(this.root!==e.root)return!1;let t=this.getParentPath(),i=e.getParentPath();return"same"==(0,r.Rt)(t,i)}getTransformedByOperation(e){let t;switch(e.type){case"insert":t=this._getTransformedByInsertOperation(e);break;case"move":case"remove":case"reinsert":t=this._getTransformedByMoveOperation(e);break;case"split":t=this._getTransformedBySplitOperation(e);break;case"merge":t=this._getTransformedByMergeOperation(e);break;default:t=te._createAt(this)}return t}_getTransformedByInsertOperation(e){return this._getTransformedByInsertion(e.position,e.howMany)}_getTransformedByMoveOperation(e){return this._getTransformedByMove(e.sourcePosition,e.targetPosition,e.howMany)}_getTransformedBySplitOperation(e){let t=e.movedRange;return t.containsPosition(this)||t.start.isEqual(this)&&"toNext"==this.stickiness?this._getCombined(e.splitPosition,e.moveTargetPosition):e.graveyardPosition?this._getTransformedByMove(e.graveyardPosition,e.insertionPosition,1):this._getTransformedByInsertion(e.insertionPosition,1)}_getTransformedByMergeOperation(e){let t;let i=e.movedRange;return i.containsPosition(this)||i.start.isEqual(this)?(t=this._getCombined(e.sourcePosition,e.targetPosition),e.sourcePosition.isBefore(e.targetPosition)&&(t=t._getTransformedByDeletion(e.deletionPosition,1))):t=this.isEqual(e.deletionPosition)?te._createAt(e.deletionPosition):this._getTransformedByMove(e.deletionPosition,e.graveyardPosition,1),t}_getTransformedByDeletion(e,t){let i=te._createAt(this);if(this.root!=e.root)return i;if("same"==(0,r.Rt)(e.getParentPath(),this.getParentPath())){if(e.offset<this.offset){if(e.offset+t>this.offset)return null;i.offset-=t}}else if("prefix"==(0,r.Rt)(e.getParentPath(),this.getParentPath())){let r=e.path.length-1;if(e.offset<=this.path[r]){if(e.offset+t>this.path[r])return null;i.path[r]-=t}}return i}_getTransformedByInsertion(e,t){let i=te._createAt(this);if(this.root!=e.root)return i;if("same"==(0,r.Rt)(e.getParentPath(),this.getParentPath()))(e.offset<this.offset||e.offset==this.offset&&"toPrevious"!=this.stickiness)&&(i.offset+=t);else if("prefix"==(0,r.Rt)(e.getParentPath(),this.getParentPath())){let r=e.path.length-1;e.offset<=this.path[r]&&(i.path[r]+=t)}return i}_getTransformedByMove(e,t,i){if(t=t._getTransformedByDeletion(e,i),e.isEqual(t))return te._createAt(this);let r=this._getTransformedByDeletion(e,i);return null===r||e.isEqual(this)&&"toNext"==this.stickiness||e.getShiftedBy(i).isEqual(this)&&"toPrevious"==this.stickiness?this._getCombined(e,t):r._getTransformedByInsertion(t,i)}_getCombined(e,t){let i=e.path.length-1,r=te._createAt(t);return r.stickiness=this.stickiness,r.offset=r.offset+this.path[i]-e.offset,r.path=[...r.path,...this.path.slice(i+1)],r}toJSON(){return{root:this.root.toJSON(),path:Array.from(this.path),stickiness:this.stickiness}}clone(){return new this.constructor(this.root,this.path,this.stickiness)}static _createAt(e,t,i="toNone"){if(e instanceof te)return new te(e.root,e.path,e.stickiness);{if("end"==t)t=e.maxOffset;else if("before"==t)return this._createBefore(e,i);else if("after"==t)return this._createAfter(e,i);else if(0!==t&&!t)throw new r.Bb("model-createpositionat-offset-required",[this,e]);if(!e.is("element")&&!e.is("documentFragment"))throw new r.Bb("model-position-parent-incorrect",[this,e]);let n=e.getPath();return n.push(t),new this(e.root,n,i)}}static _createAfter(e,t){if(!e.parent)throw new r.Bb("model-position-after-root",[this,e],{root:e});return this._createAt(e.parent,e.endOffset,t)}static _createBefore(e,t){if(!e.parent)throw new r.Bb("model-position-before-root",e,{root:e});return this._createAt(e.parent,e.startOffset,t)}static fromJSON(e,t){if("$graveyard"===e.root){let i=new te(t.graveyard,e.path);return i.stickiness=e.stickiness,i}if(!t.getRoot(e.root))throw new r.Bb("model-position-fromjson-no-root",t,{rootName:e.root});return new te(t.getRoot(e.root),e.path,e.stickiness)}}function tt(e,t){let i=t.getChildAtOffset(e.offset);return i&&i.is("$text")&&i.startOffset<e.offset?i:null}function ti(e,t,i){return null!==i?null:t.getChildAtOffset(e.offset)}function tr(e,t,i){return null!==i?null:t.getChild(t.offsetToIndex(e.offset)-1)}function tn(e,t,i){return!!(i+1!==e.path.length&&ts(t.path,i+1)&&function(e,t){let i=e.parent,r=e.path.length-1,n=0;for(;r>=t;){if(e.path[r]+n!==i.maxOffset)return!1;n=1,r--,i=i.parent}return!0}(e,i+1))}function ts(e,t){for(;t<e.length;){if(0!==e[t])return!1;t++}return!0}te.prototype.is=function(e){return"position"===e||"model:position"===e};class to extends e3{start;end;constructor(e,t){super(),this.start=te._createAt(e),this.end=t?te._createAt(t):te._createAt(e),this.start.stickiness=this.isCollapsed?"toNone":"toNext",this.end.stickiness=this.isCollapsed?"toNone":"toPrevious"}*[Symbol.iterator](){yield*new e5({boundaries:this,ignoreElementEnd:!0})}get isCollapsed(){return this.start.isEqual(this.end)}get isFlat(){let e=this.start.getParentPath(),t=this.end.getParentPath();return"same"==(0,r.Rt)(e,t)}get root(){return this.start.root}containsPosition(e){return e.isAfter(this.start)&&e.isBefore(this.end)}containsRange(e,t=!1){e.isCollapsed&&(t=!1);let i=this.containsPosition(e.start)||t&&this.start.isEqual(e.start),r=this.containsPosition(e.end)||t&&this.end.isEqual(e.end);return i&&r}containsItem(e){let t=te._createBefore(e);return this.containsPosition(t)||this.start.isEqual(t)}isEqual(e){return this.start.isEqual(e.start)&&this.end.isEqual(e.end)}isIntersecting(e){return this.start.isBefore(e.end)&&this.end.isAfter(e.start)}getDifference(e){let t=[];return this.isIntersecting(e)?(this.containsPosition(e.start)&&t.push(new to(this.start,e.start)),this.containsPosition(e.end)&&t.push(new to(e.end,this.end))):t.push(new to(this.start,this.end)),t}getIntersection(e){if(this.isIntersecting(e)){let t=this.start,i=this.end;return this.containsPosition(e.start)&&(t=e.start),this.containsPosition(e.end)&&(i=e.end),new to(t,i)}return null}getJoined(e,t=!1){let i=this.isIntersecting(e);if(i||(i=this.start.isBefore(e.start)?t?this.end.isTouching(e.start):this.end.isEqual(e.start):t?e.end.isTouching(this.start):e.end.isEqual(this.start)),!i)return null;let r=this.start,n=this.end;return e.start.isBefore(r)&&(r=e.start),e.end.isAfter(n)&&(n=e.end),new to(r,n)}getMinimalFlatRanges(){let e=[],t=this.start.getCommonPath(this.end).length,i=te._createAt(this.start),r=i.parent;for(;i.path.length>t+1;){let t=r.maxOffset-i.offset;0!==t&&e.push(new to(i,i.getShiftedBy(t))),i.path=i.path.slice(0,-1),i.offset++,r=r.parent}for(;i.path.length<=this.end.path.length;){let t=this.end.path[i.path.length-1],r=t-i.offset;0!==r&&e.push(new to(i,i.getShiftedBy(r))),i.offset=t,i.path.push(0)}return e}getWalker(e={}){return e.boundaries=this,new e5(e)}*getItems(e={}){for(let t of(e.boundaries=this,e.ignoreElementEnd=!0,new e5(e)))yield t.item}*getPositions(e={}){e.boundaries=this;let t=new e5(e);for(let e of(yield t.position,t))yield e.nextPosition}getTransformedByOperation(e){switch(e.type){case"insert":return this._getTransformedByInsertOperation(e);case"move":case"remove":case"reinsert":return this._getTransformedByMoveOperation(e);case"split":return[this._getTransformedBySplitOperation(e)];case"merge":return[this._getTransformedByMergeOperation(e)]}return[new to(this.start,this.end)]}getTransformedByOperations(e){let t=[new to(this.start,this.end)];for(let i of e)for(let e=0;e<t.length;e++){let r=t[e].getTransformedByOperation(i);t.splice(e,1,...r),e+=r.length-1}for(let e=0;e<t.length;e++){let i=t[e];for(let r=e+1;r<t.length;r++){let e=t[r];(i.containsRange(e)||e.containsRange(i)||i.isEqual(e))&&t.splice(r,1)}}return t}getCommonAncestor(){return this.start.getCommonAncestor(this.end)}getContainedElement(){if(this.isCollapsed)return null;let e=this.start.nodeAfter,t=this.end.nodeBefore;return e&&e.is("element")&&e===t?e:null}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}clone(){return new this.constructor(this.start,this.end)}_getTransformedByInsertOperation(e,t=!1){return this._getTransformedByInsertion(e.position,e.howMany,t)}_getTransformedByMoveOperation(e,t=!1){let i=e.sourcePosition,r=e.howMany,n=e.targetPosition;return this._getTransformedByMove(i,n,r,t)}_getTransformedBySplitOperation(e){let t=this.start._getTransformedBySplitOperation(e),i=this.end._getTransformedBySplitOperation(e);return this.end.isEqual(e.insertionPosition)&&(i=this.end.getShiftedBy(1)),t.root!=i.root&&(i=this.end.getShiftedBy(-1)),new to(t,i)}_getTransformedByMergeOperation(e){if(this.start.isEqual(e.targetPosition)&&this.end.isEqual(e.deletionPosition))return new to(this.start);let t=this.start._getTransformedByMergeOperation(e),i=this.end._getTransformedByMergeOperation(e);return t.root!=i.root&&(i=this.end.getShiftedBy(-1)),t.isAfter(i)&&(e.sourcePosition.isBefore(e.targetPosition)?(t=te._createAt(i)).offset=0:(e.deletionPosition.isEqual(t)||(i=e.deletionPosition),t=e.targetPosition)),new to(t,i)}_getTransformedByInsertion(e,t,i=!1){if(i&&this.containsPosition(e))return[new to(this.start,e),new to(e.getShiftedBy(t),this.end._getTransformedByInsertion(e,t))];{let i=new to(this.start,this.end);return i.start=i.start._getTransformedByInsertion(e,t),i.end=i.end._getTransformedByInsertion(e,t),[i]}}_getTransformedByMove(e,t,i,r=!1){let n;if(this.isCollapsed)return[new to(this.start._getTransformedByMove(e,t,i))];let s=to._createFromPositionAndShift(e,i),o=t._getTransformedByDeletion(e,i);if(this.containsPosition(t)&&!r&&(s.containsPosition(this.start)||s.containsPosition(this.end)))return[new to(this.start._getTransformedByMove(e,t,i),this.end._getTransformedByMove(e,t,i))];let a=this.getDifference(s),l=null,h=this.getIntersection(s);if(1==a.length?l=new to(a[0].start._getTransformedByDeletion(e,i),a[0].end._getTransformedByDeletion(e,i)):2==a.length&&(l=new to(this.start,this.end._getTransformedByDeletion(e,i))),n=l?l._getTransformedByInsertion(o,i,null!==h||r):[],h){let e=new to(h.start._getCombined(s.start,o),h.end._getCombined(s.start,o));2==n.length?n.splice(1,0,e):n.push(e)}return n}_getTransformedByDeletion(e,t){let i=this.start._getTransformedByDeletion(e,t),r=this.end._getTransformedByDeletion(e,t);return null==i&&null==r?null:(null==i&&(i=e),null==r&&(r=e),new to(i,r))}static _createFromPositionAndShift(e,t){let i=e.getShiftedBy(t);return t>0?new this(e,i):new this(i,e)}static _createIn(e){return new this(te._createAt(e,0),te._createAt(e,e.maxOffset))}static _createOn(e){return this._createFromPositionAndShift(te._createBefore(e),e.offsetSize)}static _createFromRanges(e){if(0===e.length)throw new r.Bb("range-create-from-ranges-empty-array",null);if(1==e.length)return e[0].clone();let t=e[0];e.sort((e,t)=>e.start.isAfter(t.start)?1:-1);let i=e.indexOf(t),n=new this(t.start,t.end);for(let t=i-1;t>=0;t--)if(e[t].end.isEqual(n.start))n.start=te._createAt(e[t].start);else break;for(let t=i+1;t<e.length;t++)if(e[t].start.isEqual(n.end))n.end=te._createAt(e[t].end);else break;return n}static fromJSON(e,t){return new this(te.fromJSON(e.start,t),te.fromJSON(e.end,t))}}to.prototype.is=function(e){return"range"===e||"model:range"===e};class ta extends(0,r.ln)(){_modelToViewMapping=new WeakMap;_viewToModelMapping=new WeakMap;_viewToModelLengthCallbacks=new Map;_markerNameToElements=new Map;_elementToMarkerNames=new Map;_deferredBindingRemovals=new Map;_unboundMarkerNames=new Set;constructor(){super(),this.on("modelToViewPosition",(e,t)=>{if(t.viewPosition)return;let i=this._modelToViewMapping.get(t.modelPosition.parent);if(!i)throw new r.Bb("mapping-model-position-view-parent-not-found",this,{modelPosition:t.modelPosition});t.viewPosition=this.findPositionIn(i,t.modelPosition.offset)},{priority:"low"}),this.on("viewToModelPosition",(e,t)=>{if(t.modelPosition)return;let i=this.findMappedViewAncestor(t.viewPosition),r=this._viewToModelMapping.get(i),n=this._toModelOffset(t.viewPosition.parent,t.viewPosition.offset,i);t.modelPosition=te._createAt(r,n)},{priority:"low"})}bindElements(e,t){this._modelToViewMapping.set(e,t),this._viewToModelMapping.set(t,e)}unbindViewElement(e,t={}){let i=this.toModelElement(e);if(this._elementToMarkerNames.has(e))for(let t of this._elementToMarkerNames.get(e))this._unboundMarkerNames.add(t);t.defer?this._deferredBindingRemovals.set(e,e.root):(this._viewToModelMapping.delete(e),this._modelToViewMapping.get(i)==e&&this._modelToViewMapping.delete(i))}unbindModelElement(e){let t=this.toViewElement(e);this._modelToViewMapping.delete(e),this._viewToModelMapping.get(t)==e&&this._viewToModelMapping.delete(t)}bindElementToMarker(e,t){let i=this._markerNameToElements.get(t)||new Set;i.add(e);let r=this._elementToMarkerNames.get(e)||new Set;r.add(t),this._markerNameToElements.set(t,i),this._elementToMarkerNames.set(e,r)}unbindElementFromMarkerName(e,t){let i=this._markerNameToElements.get(t);i&&(i.delete(e),0==i.size&&this._markerNameToElements.delete(t));let r=this._elementToMarkerNames.get(e);r&&(r.delete(t),0==r.size&&this._elementToMarkerNames.delete(e))}flushUnboundMarkerNames(){let e=Array.from(this._unboundMarkerNames);return this._unboundMarkerNames.clear(),e}flushDeferredBindings(){for(let[e,t]of this._deferredBindingRemovals)e.root==t&&this.unbindViewElement(e);this._deferredBindingRemovals=new Map}clearBindings(){this._modelToViewMapping=new WeakMap,this._viewToModelMapping=new WeakMap,this._markerNameToElements=new Map,this._elementToMarkerNames=new Map,this._unboundMarkerNames=new Set,this._deferredBindingRemovals=new Map}toModelElement(e){return this._viewToModelMapping.get(e)}toViewElement(e){return this._modelToViewMapping.get(e)}toModelRange(e){return new to(this.toModelPosition(e.start),this.toModelPosition(e.end))}toViewRange(e){return new L(this.toViewPosition(e.start),this.toViewPosition(e.end))}toModelPosition(e){let t={viewPosition:e,mapper:this};return this.fire("viewToModelPosition",t),t.modelPosition}toViewPosition(e,t={}){let i={modelPosition:e,mapper:this,isPhantom:t.isPhantom};return this.fire("modelToViewPosition",i),i.viewPosition}markerNameToElements(e){let t=this._markerNameToElements.get(e);if(!t)return null;let i=new Set;for(let e of t)if(e.is("attributeElement"))for(let t of e.getElementsWithSameId())i.add(t);else i.add(e);return i}registerViewToModelLength(e,t){this._viewToModelLengthCallbacks.set(e,t)}findMappedViewAncestor(e){let t=e.parent;for(;!this._viewToModelMapping.has(t);)t=t.parent;return t}_toModelOffset(e,t,i){if(i!=e)return this._toModelOffset(e.parent,e.index,i)+this._toModelOffset(e,t,e);if(e.is("$text"))return t;let r=0;for(let i=0;i<t;i++)r+=this.getModelLength(e.getChild(i));return r}getModelLength(e){if(this._viewToModelLengthCallbacks.get(e.name))return this._viewToModelLengthCallbacks.get(e.name)(e);if(this._viewToModelMapping.has(e))return 1;if(e.is("$text"))return e.data.length;{if(e.is("uiElement"))return 0;let t=0;for(let i of e.getChildren())t+=this.getModelLength(i);return t}}findPositionIn(e,t){let i;let r=0,n=0,s=0;if(e.is("$text"))return new q(e,t);for(;n<t;)i=e.getChild(s),n+=r=this.getModelLength(i),s++;return n==t?this._moveViewPositionToTextNode(new q(e,s)):this.findPositionIn(i,t-(n-r))}_moveViewPositionToTextNode(e){let t=e.nodeBefore,i=e.nodeAfter;return t instanceof A?new q(t,t.data.length):i instanceof A?new q(i,0):e}}class tl{_consumable=new Map;_textProxyRegistry=new Map;add(e,t){t=th(t),e instanceof e6&&(e=this._getSymbolForTextProxy(e)),this._consumable.has(e)||this._consumable.set(e,new Map),this._consumable.get(e).set(t,!0)}consume(e,t){return t=th(t),e instanceof e6&&(e=this._getSymbolForTextProxy(e)),!!this.test(e,t)&&(this._consumable.get(e).set(t,!1),!0)}test(e,t){t=th(t),e instanceof e6&&(e=this._getSymbolForTextProxy(e));let i=this._consumable.get(e);if(void 0===i)return null;let r=i.get(t);return void 0===r?null:r}revert(e,t){t=th(t),e instanceof e6&&(e=this._getSymbolForTextProxy(e));let i=this.test(e,t);return!1===i?(this._consumable.get(e).set(t,!0),!0):!0!==i&&null}verifyAllConsumed(e){let t=[];for(let[i,r]of this._consumable)for(let[n,s]of r){let r=n.split(":")[0];s&&e==r&&t.push({event:n,item:i.name||i.description})}if(t.length)throw new r.Bb("conversion-model-consumable-not-consumed",null,{items:t})}_getSymbolForTextProxy(e){let t=null,i=this._textProxyRegistry.get(e.startOffset);if(i){let r=i.get(e.endOffset);r&&(t=r.get(e.parent))}return t||(t=this._addSymbolForTextProxy(e)),t}_addSymbolForTextProxy(e){let t,i;let r=e.startOffset,n=e.endOffset,s=e.parent,o=Symbol("$textProxy:"+e.data);return(t=this._textProxyRegistry.get(r))||(t=new Map,this._textProxyRegistry.set(r,t)),(i=t.get(n))||(i=new Map,t.set(n,i)),i.set(s,o),o}}function th(e){let t=e.split(":");return"insert"==t[0]?t[0]:"addMarker"==t[0]||"removeMarker"==t[0]?e:t.length>1?t[0]+":"+t[1]:t[0]}class tu extends(0,r.ln)(){_conversionApi;_firedEventsMap;constructor(e){super(),this._conversionApi={dispatcher:this,...e},this._firedEventsMap=new WeakMap}convertChanges(e,t,i){let r=this._createConversionApi(i,e.getRefreshedItems());for(let t of e.getMarkersToRemove())this._convertMarkerRemove(t.name,t.range,r);for(let t of this._reduceChanges(e.getChanges()))"insert"===t.type?this._convertInsert(to._createFromPositionAndShift(t.position,t.length),r):"reinsert"===t.type?this._convertReinsert(to._createFromPositionAndShift(t.position,t.length),r):"remove"===t.type?this._convertRemove(t.position,t.length,t.name,r):this._convertAttribute(t.range,t.attributeKey,t.attributeOldValue,t.attributeNewValue,r);for(let e of(r.mapper.flushDeferredBindings(),r.mapper.flushUnboundMarkerNames())){let i=t.get(e).getRange();this._convertMarkerRemove(e,i,r),this._convertMarkerAdd(e,i,r)}for(let t of e.getMarkersToAdd())this._convertMarkerAdd(t.name,t.range,r);r.consumable.verifyAllConsumed("insert")}convert(e,t,i,r={}){let n=this._createConversionApi(i,void 0,r);for(let[i,r]of(this._convertInsert(e,n),t))this._convertMarkerAdd(i,r,n);n.consumable.verifyAllConsumed("insert")}convertSelection(e,t,i){let r=this._createConversionApi(i);this.fire("cleanSelection",{selection:e},r);let n=e.getFirstPosition().root;if(!r.mapper.toViewElement(n))return;let s=Array.from(t.getMarkersAtPosition(e.getFirstPosition()));if(this._addConsumablesForSelection(r.consumable,e,s),this.fire("selection",{selection:e},r),e.isCollapsed){for(let t of s)if(r.consumable.test(e,"addMarker:"+t.name)){let i=t.getRange();if(!function(e,t,i){let r=t.getRange(),n=Array.from(e.getAncestors());return n.shift(),n.reverse(),!n.some(e=>{if(r.containsItem(e))return!!i.toViewElement(e).getCustomProperty("addHighlight")})}(e.getFirstPosition(),t,r.mapper))continue;let n={item:e,markerName:t.name,markerRange:i};this.fire(`addMarker:${t.name}`,n,r)}for(let t of e.getAttributeKeys())if(r.consumable.test(e,"attribute:"+t)){let i={item:e,range:e.getFirstRange(),attributeKey:t,attributeOldValue:null,attributeNewValue:e.getAttribute(t)};this.fire(`attribute:${t}:$text`,i,r)}}}_convertInsert(e,t,i={}){for(let r of(i.doNotAddConsumables||this._addConsumablesForInsert(t.consumable,e),Array.from(e.getWalker({shallow:!0})).map(td)))this._testAndFire("insert",r,t)}_convertRemove(e,t,i,r){this.fire(`remove:${i}`,{position:e,length:t},r)}_convertAttribute(e,t,i,r,n){for(let s of(this._addConsumablesForRange(n.consumable,e,`attribute:${t}`),e)){let e={item:s.item,range:to._createFromPositionAndShift(s.previousPosition,s.length),attributeKey:t,attributeOldValue:i,attributeNewValue:r};this._testAndFire(`attribute:${t}`,e,n)}}_convertReinsert(e,t){let i=Array.from(e.getWalker({shallow:!0}));for(let e of(this._addConsumablesForInsert(t.consumable,i),i.map(td)))this._testAndFire("insert",{...e,reconversion:!0},t)}_convertMarkerAdd(e,t,i){if("$graveyard"==t.root.rootName)return;let r=`addMarker:${e}`;if(i.consumable.add(t,r),this.fire(r,{markerName:e,markerRange:t},i),i.consumable.consume(t,r))for(let n of(this._addConsumablesForRange(i.consumable,t,r),t.getItems())){if(!i.consumable.test(n,r))continue;let s={item:n,range:to._createOn(n),markerName:e,markerRange:t};this.fire(r,s,i)}}_convertMarkerRemove(e,t,i){"$graveyard"!=t.root.rootName&&this.fire(`removeMarker:${e}`,{markerName:e,markerRange:t},i)}_reduceChanges(e){let t={changes:e};return this.fire("reduceChanges",t),t.changes}_addConsumablesForInsert(e,t){for(let i of t){let t=i.item;if(null===e.test(t,"insert"))for(let i of(e.add(t,"insert"),t.getAttributeKeys()))e.add(t,"attribute:"+i)}return e}_addConsumablesForRange(e,t,i){for(let r of t.getItems())e.add(r,i);return e}_addConsumablesForSelection(e,t,i){for(let r of(e.add(t,"selection"),i))e.add(t,"addMarker:"+r.name);for(let i of t.getAttributeKeys())e.add(t,"attribute:"+i);return e}_testAndFire(e,t,i){let r=function(e,t){let i=t.item.is("element")?t.item.name:"$text";return`${e}:${i}`}(e,t),n=t.item.is("$textProxy")?i.consumable._getSymbolForTextProxy(t.item):t.item,s=this._firedEventsMap.get(i),o=s.get(n);if(o){if(o.has(r))return;o.add(r)}else s.set(n,new Set([r]));this.fire(r,t,i)}_testAndFireAddAttributes(e,t){let i={item:e,range:to._createOn(e)};for(let e of i.item.getAttributeKeys())i.attributeKey=e,i.attributeOldValue=null,i.attributeNewValue=i.item.getAttribute(e),this._testAndFire(`attribute:${e}`,i,t)}_createConversionApi(e,t=new Set,i={}){let r={...this._conversionApi,consumable:new tl,writer:e,options:i,convertItem:e=>this._convertInsert(to._createOn(e),r),convertChildren:e=>this._convertInsert(to._createIn(e),r,{doNotAddConsumables:!0}),convertAttributes:e=>this._testAndFireAddAttributes(e,r),canReuseView:e=>!t.has(r.mapper.toModelElement(e))};return this._firedEventsMap.set(r,new Map),r}}function td(e){return{item:e.item,range:to._createFromPositionAndShift(e.previousPosition,e.length)}}class tc extends(0,r.ln)(e3){_lastRangeBackward=!1;_attrs=new Map;_ranges=[];constructor(...e){super(),e.length&&this.setTo(...e)}get anchor(){if(this._ranges.length>0){let e=this._ranges[this._ranges.length-1];return this._lastRangeBackward?e.end:e.start}return null}get focus(){if(this._ranges.length>0){let e=this._ranges[this._ranges.length-1];return this._lastRangeBackward?e.start:e.end}return null}get isCollapsed(){return 1===this._ranges.length&&this._ranges[0].isCollapsed}get rangeCount(){return this._ranges.length}get isBackward(){return!this.isCollapsed&&this._lastRangeBackward}isEqual(e){if(this.rangeCount!=e.rangeCount)return!1;if(0===this.rangeCount)return!0;if(!this.anchor.isEqual(e.anchor)||!this.focus.isEqual(e.focus))return!1;for(let t of this._ranges){let i=!1;for(let r of e._ranges)if(t.isEqual(r)){i=!0;break}if(!i)return!1}return!0}*getRanges(){for(let e of this._ranges)yield new to(e.start,e.end)}getFirstRange(){let e=null;for(let t of this._ranges)(!e||t.start.isBefore(e.start))&&(e=t);return e?new to(e.start,e.end):null}getLastRange(){let e=null;for(let t of this._ranges)(!e||t.end.isAfter(e.end))&&(e=t);return e?new to(e.start,e.end):null}getFirstPosition(){let e=this.getFirstRange();return e?e.start.clone():null}getLastPosition(){let e=this.getLastRange();return e?e.end.clone():null}setTo(...e){let[t,i,n]=e;if("object"==typeof i&&(n=i,i=void 0),null===t)this._setRanges([]);else if(t instanceof tc)this._setRanges(t.getRanges(),t.isBackward);else if(t&&"function"==typeof t.getRanges)this._setRanges(t.getRanges(),t.isBackward);else if(t instanceof to)this._setRanges([t],!!n&&!!n.backward);else if(t instanceof te)this._setRanges([new to(t)]);else if(t instanceof e9){let e;let s=!!n&&!!n.backward;if("in"==i)e=to._createIn(t);else if("on"==i)e=to._createOn(t);else if(void 0!==i)e=new to(te._createAt(t,i));else throw new r.Bb("model-selection-setto-required-second-parameter",[this,t]);this._setRanges([e],s)}else if((0,r.TW)(t))this._setRanges(t,n&&!!n.backward);else throw new r.Bb("model-selection-setto-not-selectable",[this,t])}_setRanges(e,t=!1){let i=Array.from(e),n=i.some(t=>{if(!(t instanceof to))throw new r.Bb("model-selection-set-ranges-not-range",[this,e]);return this._ranges.every(e=>!e.isEqual(t))});(i.length!==this._ranges.length||n)&&(this._replaceAllRanges(i),this._lastRangeBackward=!!t,this.fire("change:range",{directChange:!0}))}setFocus(e,t){if(null===this.anchor)throw new r.Bb("model-selection-setfocus-no-ranges",[this,e]);let i=te._createAt(e,t);if("same"==i.compareWith(this.focus))return;let n=this.anchor;this._ranges.length&&this._popRange(),"before"==i.compareWith(n)?(this._pushRange(new to(i,n)),this._lastRangeBackward=!0):(this._pushRange(new to(n,i)),this._lastRangeBackward=!1),this.fire("change:range",{directChange:!0})}getAttribute(e){return this._attrs.get(e)}getAttributes(){return this._attrs.entries()}getAttributeKeys(){return this._attrs.keys()}hasAttribute(e){return this._attrs.has(e)}removeAttribute(e){this.hasAttribute(e)&&(this._attrs.delete(e),this.fire("change:attribute",{attributeKeys:[e],directChange:!0}))}setAttribute(e,t){this.getAttribute(e)!==t&&(this._attrs.set(e,t),this.fire("change:attribute",{attributeKeys:[e],directChange:!0}))}getSelectedElement(){return 1!==this.rangeCount?null:this.getFirstRange().getContainedElement()}*getSelectedBlocks(){let e=new WeakSet;for(let t of this.getRanges()){let i=tm(t.start,e);for(let r of(i&&(t.isCollapsed||i.isEmpty||!t.start.isTouching(te._createAt(i,i.maxOffset))&&tg(i,t))&&(yield i),t.getWalker())){let i=r.item;"elementEnd"==r.type&&tf(i,e)&&tg(i,t)&&(yield i)}let r=tm(t.end,e);r&&(t.isCollapsed||r.isEmpty||!t.end.isTouching(te._createAt(r,0))&&tg(r,t))&&(yield r)}}containsEntireContent(e=this.anchor.root){let t=te._createAt(e,0),i=te._createAt(e,"end");return t.isTouching(this.getFirstPosition())&&i.isTouching(this.getLastPosition())}_pushRange(e){this._checkRange(e),this._ranges.push(new to(e.start,e.end))}_checkRange(e){for(let t=0;t<this._ranges.length;t++)if(e.isIntersecting(this._ranges[t]))throw new r.Bb("model-selection-range-intersects",[this,e],{addedRange:e,intersectingRange:this._ranges[t]})}_replaceAllRanges(e){for(let t of(this._removeAllRanges(),e))this._pushRange(t)}_removeAllRanges(){for(;this._ranges.length>0;)this._popRange()}_popRange(){this._ranges.pop()}}function tf(e,t){return!t.has(e)&&(t.add(e),e.root.document.model.schema.isBlock(e)&&!!e.parent)}function tm(e,t){let i=e.parent.root.document.model.schema,r=e.parent.getAncestors({parentFirst:!0,includeSelf:!0}),n=!1,s=r.find(e=>!n&&!(n=i.isLimit(e))&&tf(e,t));return r.forEach(e=>t.add(e)),s}function tg(e,t){let i=function(e){let t=e.root.document.model.schema,i=e.parent;for(;i;){if(t.isBlock(i))return i;i=i.parent}}(e);return!i||!t.containsRange(to._createOn(i),!0)}tc.prototype.is=function(e){return"selection"===e||"model:selection"===e};class tp extends(0,r.ln)(to){constructor(e,t){super(e,t),t_.call(this)}detach(){this.stopListening()}toRange(){return new to(this.start,this.end)}static fromRange(e){return new tp(e.start,e.end)}}function t_(){this.listenTo(this.root.document.model,"applyOperation",(e,t)=>{let i=t[0];i.isDocumentOperation&&tw.call(this,i)},{priority:"low"})}function tw(e){let t=this.getTransformedByOperation(e),i=to._createFromRanges(t),r=!i.isEqual(this),n=function(e,t){switch(t.type){case"insert":return e.containsPosition(t.position);case"move":case"remove":case"reinsert":case"merge":return e.containsPosition(t.sourcePosition)||e.start.isEqual(t.sourcePosition)||e.containsPosition(t.targetPosition);case"split":return e.containsPosition(t.splitPosition)||e.containsPosition(t.insertionPosition)}return!1}(this,e),s=null;if(r){"$graveyard"==i.root.rootName&&(s="remove"==e.type?e.sourcePosition:e.deletionPosition);let t=this.toRange();this.start=i.start,this.end=i.end,this.fire("change:range",t,{deletionPosition:s})}else n&&this.fire("change:content",this.toRange(),{deletionPosition:s})}tp.prototype.is=function(e){return"liveRange"===e||"model:liveRange"===e||"range"==e||"model:range"===e};let tb="selection:";class ty extends(0,r.ln)(e3){_selection;constructor(e){super(),this._selection=new tv(e),this._selection.delegate("change:range").to(this),this._selection.delegate("change:attribute").to(this),this._selection.delegate("change:marker").to(this)}get isCollapsed(){return this._selection.isCollapsed}get anchor(){return this._selection.anchor}get focus(){return this._selection.focus}get rangeCount(){return this._selection.rangeCount}get hasOwnRange(){return this._selection.hasOwnRange}get isBackward(){return this._selection.isBackward}get isGravityOverridden(){return this._selection.isGravityOverridden}get markers(){return this._selection.markers}get _ranges(){return this._selection._ranges}getRanges(){return this._selection.getRanges()}getFirstPosition(){return this._selection.getFirstPosition()}getLastPosition(){return this._selection.getLastPosition()}getFirstRange(){return this._selection.getFirstRange()}getLastRange(){return this._selection.getLastRange()}getSelectedBlocks(){return this._selection.getSelectedBlocks()}getSelectedElement(){return this._selection.getSelectedElement()}containsEntireContent(e){return this._selection.containsEntireContent(e)}destroy(){this._selection.destroy()}getAttributeKeys(){return this._selection.getAttributeKeys()}getAttributes(){return this._selection.getAttributes()}getAttribute(e){return this._selection.getAttribute(e)}hasAttribute(e){return this._selection.hasAttribute(e)}refresh(){this._selection.updateMarkers(),this._selection._updateAttributes(!1)}observeMarkers(e){this._selection.observeMarkers(e)}_setFocus(e,t){this._selection.setFocus(e,t)}_setTo(...e){this._selection.setTo(...e)}_setAttribute(e,t){this._selection.setAttribute(e,t)}_removeAttribute(e){this._selection.removeAttribute(e)}_getStoredAttributes(){return this._selection.getStoredAttributes()}_overrideGravity(){return this._selection.overrideGravity()}_restoreGravity(e){this._selection.restoreGravity(e)}static _getStoreAttributeKey(e){return tb+e}static _isStoreAttributeKey(e){return e.startsWith(tb)}}ty.prototype.is=function(e){return"selection"===e||"model:selection"==e||"documentSelection"==e||"model:documentSelection"==e};class tv extends tc{markers=new r.FE({idProperty:"name"});_model;_document;_attributePriority=new Map;_selectionRestorePosition=null;_hasChangedRange=!1;_overriddenGravityRegister=new Set;_observedMarkers=new Set;constructor(e){super(),this._model=e.model,this._document=e,this.listenTo(this._model,"applyOperation",(e,t)=>{let i=t[0];i.isDocumentOperation&&"marker"!=i.type&&"rename"!=i.type&&"noop"!=i.type&&(0==this._ranges.length&&this._selectionRestorePosition&&this._fixGraveyardSelection(this._selectionRestorePosition),this._selectionRestorePosition=null,this._hasChangedRange&&(this._hasChangedRange=!1,this.fire("change:range",{directChange:!1})))},{priority:"lowest"}),this.on("change:range",()=>{this._validateSelectionRanges(this.getRanges())}),this.listenTo(this._model.markers,"update",(e,t,i,r)=>{this._updateMarker(t,r)}),this.listenTo(this._document,"change",(e,t)=>{(function(e,t){for(let i of e.document.differ.getChanges()){if("insert"!=i.type)continue;let r=i.position.parent;i.length===r.maxOffset&&e.enqueueChange(t,e=>{for(let t of Array.from(r.getAttributeKeys()).filter(e=>e.startsWith(tb)))e.removeAttribute(t,r)})}})(this._model,t)})}get isCollapsed(){return 0===this._ranges.length?this._document._getDefaultRange().isCollapsed:super.isCollapsed}get anchor(){return super.anchor||this._document._getDefaultRange().start}get focus(){return super.focus||this._document._getDefaultRange().end}get rangeCount(){return this._ranges.length?this._ranges.length:1}get hasOwnRange(){return this._ranges.length>0}get isGravityOverridden(){return!!this._overriddenGravityRegister.size}destroy(){for(let e=0;e<this._ranges.length;e++)this._ranges[e].detach();this.stopListening()}*getRanges(){this._ranges.length?yield*super.getRanges():yield this._document._getDefaultRange()}getFirstRange(){return super.getFirstRange()||this._document._getDefaultRange()}getLastRange(){return super.getLastRange()||this._document._getDefaultRange()}setTo(...e){super.setTo(...e),this._updateAttributes(!0),this.updateMarkers()}setFocus(e,t){super.setFocus(e,t),this._updateAttributes(!0),this.updateMarkers()}setAttribute(e,t){this._setAttribute(e,t)&&this.fire("change:attribute",{attributeKeys:[e],directChange:!0})}removeAttribute(e){this._removeAttribute(e)&&this.fire("change:attribute",{attributeKeys:[e],directChange:!0})}overrideGravity(){let e=(0,r.hQ)();return this._overriddenGravityRegister.add(e),1===this._overriddenGravityRegister.size&&this._updateAttributes(!0),e}restoreGravity(e){if(!this._overriddenGravityRegister.has(e))throw new r.Bb("document-selection-gravity-wrong-restore",this,{uid:e});this._overriddenGravityRegister.delete(e),this.isGravityOverridden||this._updateAttributes(!0)}observeMarkers(e){this._observedMarkers.add(e),this.updateMarkers()}_replaceAllRanges(e){this._validateSelectionRanges(e),super._replaceAllRanges(e)}_popRange(){this._ranges.pop().detach()}_pushRange(e){let t=this._prepareRange(e);t&&this._ranges.push(t)}_validateSelectionRanges(e){for(let t of e)if(!this._document._validateSelectionRange(t))throw new r.Bb("document-selection-wrong-position",this,{range:t})}_prepareRange(e){if(this._checkRange(e),e.root==this._document.graveyard)return;let t=tp.fromRange(e);return t.on("change:range",(e,i,r)=>{if(this._hasChangedRange=!0,t.root==this._document.graveyard){this._selectionRestorePosition=r.deletionPosition;let e=this._ranges.indexOf(t);this._ranges.splice(e,1),t.detach()}}),t}updateMarkers(){if(!this._observedMarkers.size)return;let e=[],t=!1;for(let t of this._model.markers){let i=t.name.split(":",1)[0];if(!this._observedMarkers.has(i))continue;let r=t.getRange();for(let i of this.getRanges())r.containsRange(i,!i.isCollapsed)&&e.push(t)}let i=Array.from(this.markers);for(let i of e)this.markers.has(i)||(this.markers.add(i),t=!0);for(let i of Array.from(this.markers))e.includes(i)||(this.markers.remove(i),t=!0);t&&this.fire("change:marker",{oldMarkers:i,directChange:!1})}_updateMarker(e,t){let i=e.name.split(":",1)[0];if(!this._observedMarkers.has(i))return;let r=!1,n=Array.from(this.markers),s=this.markers.has(e);if(t){let i=!1;for(let e of this.getRanges())if(t.containsRange(e,!e.isCollapsed)){i=!0;break}i&&!s?(this.markers.add(e),r=!0):!i&&s&&(this.markers.remove(e),r=!0)}else s&&(this.markers.remove(e),r=!0);r&&this.fire("change:marker",{oldMarkers:n,directChange:!1})}_updateAttributes(e){let t=(0,r.qL)(this._getSurroundingAttributes()),i=(0,r.qL)(this.getAttributes());if(e)this._attributePriority=new Map,this._attrs=new Map;else for(let[e,t]of this._attributePriority)"low"==t&&(this._attrs.delete(e),this._attributePriority.delete(e));this._setAttributesTo(t);let n=[];for(let[e,t]of this.getAttributes())i.has(e)&&i.get(e)===t||n.push(e);for(let[e]of i)this.hasAttribute(e)||n.push(e);n.length>0&&this.fire("change:attribute",{attributeKeys:n,directChange:!1})}_setAttribute(e,t,i=!0){let r=i?"normal":"low";return("low"!=r||"normal"!=this._attributePriority.get(e))&&super.getAttribute(e)!==t&&(this._attrs.set(e,t),this._attributePriority.set(e,r),!0)}_removeAttribute(e,t=!0){let i=t?"normal":"low";return("low"!=i||"normal"!=this._attributePriority.get(e))&&(this._attributePriority.set(e,i),!!super.hasAttribute(e)&&(this._attrs.delete(e),!0))}_setAttributesTo(e){let t=new Set;for(let[t,i]of this.getAttributes())e.get(t)!==i&&this._removeAttribute(t,!1);for(let[i,r]of e)this._setAttribute(i,r,!1)&&t.add(i);return t}*getStoredAttributes(){let e=this.getFirstPosition().parent;if(this.isCollapsed&&e.isEmpty){for(let t of e.getAttributeKeys())if(t.startsWith(tb)){let i=t.substr(tb.length);yield[i,e.getAttribute(t)]}}}_getSurroundingAttributes(){let e=this.getFirstPosition(),t=this._model.schema;if("$graveyard"==e.root.rootName)return null;let i=null;if(this.isCollapsed){let r=e.textNode?e.textNode:e.nodeBefore,n=e.textNode?e.textNode:e.nodeAfter;if(this.isGravityOverridden||(i=tP(r,t)),i||(i=tP(n,t)),!this.isGravityOverridden&&!i){let e=r;for(;e&&!i;)i=tP(e=e.previousSibling,t)}if(!i){let e=n;for(;e&&!i;)i=tP(e=e.nextSibling,t)}i||(i=this.getStoredAttributes())}else for(let e of this.getFirstRange()){if(e.item.is("element")&&t.isObject(e.item)){i=tP(e.item,t);break}if("text"==e.type){i=e.item.getAttributes();break}}return i}_fixGraveyardSelection(e){let t=this._model.schema.getNearestSelectionRange(e);t&&this._pushRange(t)}}function tP(e,t){if(!e)return null;if(e instanceof e6||e instanceof e7)return e.getAttributes();if(!t.isInline(e))return null;if(!t.isObject(e))return[];let i=[];for(let[r,n]of e.getAttributes())t.checkAttribute("$text",r)&&!1!==t.getAttributeProperties(r).copyFromObject&&i.push([r,n]);return i}class tA{_dispatchers;constructor(e){this._dispatchers=e}add(e){for(let t of this._dispatchers)e(t);return this}}class tC extends tA{elementToElement(e){return this.add(function(e){let t=tO(e.model),i=tT(e.view,"container");return t.attributes.length&&(t.children=!0),r=>{r.on(`insert:${t.name}`,function(e,t=function(e,t,{preflight:i}={}){return i?t.test(e,"insert"):t.consume(e,"insert")}){return(i,r,n)=>{if(!t(r.item,n.consumable,{preflight:!0}))return;let s=e(r.item,n,r);if(!s)return;t(r.item,n.consumable);let o=n.mapper.toViewPosition(r.range.start);n.mapper.bindElements(r.item,s),n.writer.insert(o,s),n.convertAttributes(r.item),tI(s,r.item.getChildren(),n,{reconversion:r.reconversion})}}(i,tF(t)),{priority:e.converterPriority||"normal"}),(t.children||t.attributes.length)&&r.on("reduceChanges",tB(t),{priority:"low"})}}(e))}elementToStructure(e){return this.add(function(e){let t=tO(e.model),i=tT(e.view,"container");return t.children=!0,n=>{var s;if(n._conversionApi.schema.checkChild(t.name,"$text"))throw new r.Bb("conversion-element-to-structure-disallowed-text",n,{elementName:t.name});n.on(`insert:${t.name}`,(s=tF(t),(e,t,n)=>{var o;if(!s(t.item,n.consumable,{preflight:!0}))return;let a=new Map;n.writer._registerSlotFactory((o=t.item,(e,t)=>{let i=e.createContainerElement("$slot"),s=null;if("children"===t)s=Array.from(o.getChildren());else if("function"==typeof t)s=Array.from(o.getChildren()).filter(e=>t(e));else throw new r.Bb("conversion-slot-mode-unknown",n.dispatcher,{modeOrFilter:t});return a.set(i,s),i}));let l=i(t.item,n,t);if(n.writer._clearSlotFactory(),!l)return;(function(e,t,i){let n=Array.from(t.values()).flat(),s=new Set(n);if(s.size!=n.length)throw new r.Bb("conversion-slot-filter-overlap",i.dispatcher,{element:e});if(s.size!=e.childCount)throw new r.Bb("conversion-slot-filter-incomplete",i.dispatcher,{element:e})})(t.item,a,n),s(t.item,n.consumable);let h=n.mapper.toViewPosition(t.range.start);n.mapper.bindElements(t.item,l),n.writer.insert(h,l),n.convertAttributes(t.item),function(e,t,i,r){i.mapper.on("modelToViewPosition",o,{priority:"highest"});let n=null,s=null;for([n,s]of t)tI(e,s,i,r),i.writer.move(i.writer.createRangeIn(n),i.writer.createPositionBefore(n)),i.writer.remove(n);function o(e,t){let i=t.modelPosition.nodeAfter,r=s.indexOf(i);r<0||(t.viewPosition=t.mapper.findPositionIn(n,r))}i.mapper.off("modelToViewPosition",o)}(l,a,n,{reconversion:t.reconversion})}),{priority:e.converterPriority||"normal"}),n.on("reduceChanges",tB(t),{priority:"low"})}}(e))}attributeToElement(e){return this.add(function(e){let t=(e=(0,m.Z)(e)).model;"string"==typeof t&&(t={key:t});let i=`attribute:${t.key}`;if(t.name&&(i+=":"+t.name),t.values)for(let i of t.values)e.view[i]=tT(e.view[i],"attribute");else e.view=tT(e.view,"attribute");let r=tx(e);return t=>{var n;t.on(i,(n=r,(e,t,i)=>{if(!i.consumable.test(t.item,e.name))return;let r=n(t.attributeOldValue,i,t),s=n(t.attributeNewValue,i,t);if(!r&&!s)return;i.consumable.consume(t.item,e.name);let o=i.writer,a=o.document.selection;if(t.item instanceof tc||t.item instanceof ty)o.wrap(a.getFirstRange(),s);else{let e=i.mapper.toViewRange(t.range);null!==t.attributeOldValue&&r&&(e=o.unwrap(e,r)),null!==t.attributeNewValue&&s&&o.wrap(e,s)}}),{priority:e.converterPriority||"normal"})}}(e))}attributeToAttribute(e){return this.add(function(e){let t=(e=(0,m.Z)(e)).model;"string"==typeof t&&(t={key:t});let i=`attribute:${t.key}`;if(t.name&&(i+=":"+t.name),t.values)for(let i of t.values)e.view[i]=tM(e.view[i]);else e.view=tM(e.view);let n=tx(e);return t=>{t.on(i,(e,t,i)=>{if(!i.consumable.test(t.item,e.name))return;let s=n(t.attributeOldValue,i,t),o=n(t.attributeNewValue,i,t);if(!s&&!o)return;i.consumable.consume(t.item,e.name);let a=i.mapper.toViewElement(t.item),l=i.writer;if(!a)throw new r.Bb("conversion-attribute-to-attribute-on-text",i.dispatcher,t);if(null!==t.attributeOldValue&&s){if("class"==s.key)for(let e of"string"==typeof s.value?s.value.split(/\s+/):s.value)l.removeClass(e,a);else if("style"==s.key){if("string"==typeof s.value){let e=new R(l.document.stylesProcessor);for(let[t]of(e.setTo(s.value),e.getStylesEntries()))l.removeStyle(t,a)}else for(let e of Object.keys(s.value))l.removeStyle(e,a)}else l.removeAttribute(s.key,a)}if(null!==t.attributeNewValue&&o){if("class"==o.key)for(let e of"string"==typeof o.value?o.value.split(/\s+/):o.value)l.addClass(e,a);else if("style"==o.key){if("string"==typeof o.value){let e=new R(l.document.stylesProcessor);for(let[t,i]of(e.setTo(o.value),e.getStylesEntries()))l.setStyle(t,i,a)}else for(let e of Object.keys(o.value))l.setStyle(e,o.value[e],a)}else l.setAttribute(o.key,o.value,a)}},{priority:e.converterPriority||"normal"})}}(e))}markerToElement(e){return this.add(function(e){let t=tT(e.view,"ui");return i=>{var r;i.on(`addMarker:${e.model}`,(r=t,(e,t,i)=>{t.isOpening=!0;let n=r(t,i);t.isOpening=!1;let s=r(t,i);if(!n||!s)return;let o=t.markerRange;if(o.isCollapsed&&!i.consumable.consume(o,e.name))return;for(let t of o)if(!i.consumable.consume(t.item,e.name))return;let a=i.mapper,l=i.writer;l.insert(a.toViewPosition(o.start),n),i.mapper.bindElementToMarker(n,t.markerName),o.isCollapsed||(l.insert(a.toViewPosition(o.end),s),i.mapper.bindElementToMarker(s,t.markerName)),e.stop()}),{priority:e.converterPriority||"normal"}),i.on(`removeMarker:${e.model}`,(e,t,i)=>{let r=i.mapper.markerNameToElements(t.markerName);if(r){for(let e of r)i.mapper.unbindElementFromMarkerName(e,t.markerName),i.writer.clear(i.writer.createRangeOn(e),e);i.writer.clearClonedElementsGroup(t.markerName),e.stop()}},{priority:e.converterPriority||"normal"})}}(e))}markerToHighlight(e){return this.add(t=>{var i,r,n;t.on(`addMarker:${e.model}`,(i=e.view,(e,t,r)=>{if(!t.item||!(t.item instanceof tc||t.item instanceof ty)&&!t.item.is("$textProxy"))return;let n=tN(i,t,r);if(!n||!r.consumable.consume(t.item,e.name))return;let s=r.writer,o=tE(s,n),a=s.document.selection;if(t.item instanceof tc||t.item instanceof ty)s.wrap(a.getFirstRange(),o);else{let e=r.mapper.toViewRange(t.range);for(let i of s.wrap(e,o).getItems())if(i.is("attributeElement")&&i.isSimilar(o)){r.mapper.bindElementToMarker(i,t.markerName);break}}}),{priority:e.converterPriority||"normal"}),t.on(`addMarker:${e.model}`,(r=e.view,(e,t,i)=>{if(!t.item||!(t.item instanceof e4))return;let n=tN(r,t,i);if(!n||!i.consumable.test(t.item,e.name))return;let s=i.mapper.toViewElement(t.item);if(s&&s.getCustomProperty("addHighlight")){for(let r of(i.consumable.consume(t.item,e.name),to._createIn(t.item)))i.consumable.consume(r.item,e.name);s.getCustomProperty("addHighlight")(s,n,i.writer),i.mapper.bindElementToMarker(s,t.markerName)}}),{priority:e.converterPriority||"normal"}),t.on(`removeMarker:${e.model}`,(n=e.view,(e,t,i)=>{if(t.markerRange.isCollapsed)return;let r=tN(n,t,i);if(!r)return;let s=tE(i.writer,r),o=i.mapper.markerNameToElements(t.markerName);if(o){for(let e of o)i.mapper.unbindElementFromMarkerName(e,t.markerName),e.is("attributeElement")?i.writer.unwrap(i.writer.createRangeOn(e),s):e.getCustomProperty("removeHighlight")(e,r.id,i.writer);i.writer.clearClonedElementsGroup(t.markerName),e.stop()}}),{priority:e.converterPriority||"normal"})})}markerToData(e){return this.add(function(e){let t=(e=(0,m.Z)(e)).model,i=e.view;return i||(i=i=>({group:t,name:i.substr(e.model.length+1)})),r=>{var n,s;r.on(`addMarker:${t}`,(n=i,(e,t,i)=>{let r=n(t.markerName,i);if(!r)return;let s=t.markerRange;i.consumable.consume(s,e.name)&&(tR(s,!1,i,t,r),tR(s,!0,i,t,r),e.stop())}),{priority:e.converterPriority||"normal"}),r.on(`removeMarker:${t}`,(s=i,(e,t,i)=>{let r=s(t.markerName,i);if(!r)return;let n=i.mapper.markerNameToElements(t.markerName);if(n){for(let e of n)i.mapper.unbindElementFromMarkerName(e,t.markerName),e.is("containerElement")?(o(`data-${r.group}-start-before`,e),o(`data-${r.group}-start-after`,e),o(`data-${r.group}-end-before`,e),o(`data-${r.group}-end-after`,e)):i.writer.clear(i.writer.createRangeOn(e),e);i.writer.clearClonedElementsGroup(t.markerName),e.stop()}function o(e,t){if(t.hasAttribute(e)){let n=new Set(t.getAttribute(e).split(","));n.delete(r.name),0==n.size?i.writer.removeAttribute(e,t):i.writer.setAttribute(e,Array.from(n).join(","),t)}}}),{priority:e.converterPriority||"normal"})}}(e))}}function tk(){return(e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;let r=i.writer,n=i.mapper.toViewPosition(t.range.start),s=r.createText(t.item.data);r.insert(n,s)}}function tS(){return(e,t,i)=>{i.convertAttributes(t.item),!t.reconversion&&t.item.is("element")&&!t.item.isEmpty&&i.convertChildren(t.item)}}function tE(e,t){let i=e.createAttributeElement("span",t.attributes);return t.classes&&i._addClass(t.classes),"number"==typeof t.priority&&(i._priority=t.priority),i._id=t.id,i}function tR(e,t,i,r,n){let s=t?e.start:e.end,o=s.nodeAfter&&s.nodeAfter.is("element")?s.nodeAfter:null,a=s.nodeBefore&&s.nodeBefore.is("element")?s.nodeBefore:null;if(o||a){let e,s;t&&o||!t&&!a?(e=o,s=!0):(e=a,s=!1);let l=i.mapper.toViewElement(e);if(l){!function(e,t,i,r,n,s){let o=`data-${s.group}-${t?"start":"end"}-${i?"before":"after"}`,a=e.hasAttribute(o)?e.getAttribute(o).split(","):[];a.unshift(s.name),r.writer.setAttribute(o,a.join(","),e),r.mapper.bindElementToMarker(e,n.markerName)}(l,t,s,i,r,n);return}}!function(e,t,i,r,n){let s=`${n.group}-${t?"start":"end"}`,o=n.name?{name:n.name}:null,a=i.writer.createUIElement(s,o);i.writer.insert(e,a),i.mapper.bindElementToMarker(a,r.markerName)}(i.mapper.toViewPosition(s),t,i,r,n)}function tO(e){return"string"==typeof e&&(e={name:e}),{name:e.name,attributes:e.attributes?(0,r.qo)(e.attributes):[],children:!!e.children}}function tT(e,t){return"function"==typeof e?e:(i,r)=>(function(e,t,i){let r;"string"==typeof e&&(e={name:e});let n=t.writer,s=Object.assign({},e.attributes);if("container"==i)r=n.createContainerElement(e.name,s);else if("attribute"==i){let t={priority:e.priority||X.DEFAULT_PRIORITY};r=n.createAttributeElement(e.name,s,t)}else r=n.createUIElement(e.name,s);if(e.styles)for(let t of Object.keys(e.styles))n.setStyle(t,e.styles[t],r);if(e.classes){let t=e.classes;if("string"==typeof t)n.addClass(t,r);else for(let e of t)n.addClass(e,r)}return r})(e,r,t)}function tx(e){return e.model.values?(t,i,r)=>{let n=e.view[t];return n?n(t,i,r):null}:e.view}function tM(e){return"string"==typeof e?t=>({key:e,value:t}):"object"!=typeof e?e:e.value?()=>e:t=>({key:e.key,value:t})}function tN(e,t,i){let r="function"==typeof e?e(t,i):e;return r?(r.priority||(r.priority=10),r.id||(r.id=t.markerName),r):null}function tB(e){let t=(t,i)=>{if(!t.is("element",e.name))return!1;if("attribute"==i.type){if(e.attributes.includes(i.attributeKey))return!0}else if(e.children)return!0;return!1};return(e,i)=>{let r=[];for(let e of(i.reconvertedElements||(i.reconvertedElements=new Set),i.changes)){let n="attribute"==e.type?e.range.start.nodeAfter:e.position.parent;if(!n||!t(n,e)){r.push(e);continue}if(!i.reconvertedElements.has(n)){i.reconvertedElements.add(n);let e=te._createBefore(n),t=r.length;for(let i=r.length-1;i>=0;i--){let n=r[i],s=("attribute"==n.type?n.range.start:n.position).compareWith(e);if("before"==s||"remove"==n.type&&"same"==s)break;t=i}r.splice(t,0,{type:"remove",name:n.name,position:e,length:1},{type:"reinsert",name:n.name,position:e,length:1})}}i.changes=r}}function tF(e){return(t,i,r={})=>{let n=["insert"];for(let i of e.attributes)t.hasAttribute(i)&&n.push(`attribute:${i}`);return!!n.every(e=>i.test(t,e))&&(r.preflight||n.forEach(e=>i.consume(t,e)),!0)}}function tI(e,t,i,r){for(let n of t)!function(e,t,i,r){let{writer:n,mapper:s}=i;if(!r.reconversion)return!1;let o=s.toViewElement(t);return!!(o&&o.root!=e&&i.canReuseView(o))&&(n.move(n.createRangeOn(o),s.toViewPosition(te._createBefore(t))),!0)}(e.root,n,i,r)&&i.convertItem(n)}function tD(e){let{schema:t,document:i}=e.model;for(let r of i.getRoots())if(r.isEmpty&&!t.checkChild(r,"$text")&&t.checkChild(r,"paragraph"))return e.insertElement("paragraph",r),!0;return!1}function tV(e,t,i){let r=i.createContext(e);return!!(i.checkChild(r,"paragraph")&&i.checkChild(r.push("paragraph"),t))}function t$(e,t){let i=t.createElement("paragraph");return t.insert(i,e),t.createPositionAt(i,0)}class tq extends tA{elementToElement(e){return this.add(tW(e))}elementToAttribute(e){return this.add(function(e){tJ(e=(0,m.Z)(e));let t=tK(e,!1),i=tj(e.view),r=i?`element:${i}`:"element";return i=>{i.on(r,t,{priority:e.converterPriority||"low"})}}(e))}attributeToAttribute(e){return this.add(function(e){e=(0,m.Z)(e);let t=null;("string"==typeof e.view||e.view.key)&&(t=function(e){let t;"string"==typeof e.view&&(e.view={key:e.view});let i=e.view.key,r=void 0===e.view.value?/[\s\S]*/:e.view.value;return t="class"==i||"style"==i?{["class"==i?"classes":"styles"]:r}:{attributes:{[i]:r}},e.view.name&&(t.name=e.view.name),e.view=t,i}(e)),tJ(e,t);let i=tK(e,!0);return t=>{t.on("element",i,{priority:e.converterPriority||"low"})}}(e))}elementToMarker(e){return this.add(function(e){var t;let i=(t=e.model,(e,i)=>{let r="string"==typeof t?t:t(e,i);return i.writer.createElement("$marker",{"data-name":r})});return tW({...e,model:i})}(e))}dataToMarker(e){return this.add(function(e){(e=(0,m.Z)(e)).model||(e.model=t=>t?e.view+":"+t:e.view);let t={view:e.view,model:e.model},i=tU(tG(t,"start")),n=tU(tG(t,"end"));return s=>{s.on(`element:${e.view}-start`,i,{priority:e.converterPriority||"normal"}),s.on(`element:${e.view}-end`,n,{priority:e.converterPriority||"normal"});let o=r.tA.low,a=r.tA.highest,l=r.tA.get(e.converterPriority)/a;s.on("element",(e,i,r)=>{let n=`data-${t.view}`;function s(e,n){for(let s of n){let n=t.model(s,r),o=r.writer.createElement("$marker",{"data-name":n});r.writer.insert(o,e),i.modelCursor.isEqual(e)?i.modelCursor=i.modelCursor.getShiftedBy(1):i.modelCursor=i.modelCursor._getTransformedByInsertion(e,1),i.modelRange=i.modelRange._getTransformedByInsertion(e,1)[0]}}(r.consumable.test(i.viewItem,{attributes:n+"-end-after"})||r.consumable.test(i.viewItem,{attributes:n+"-start-after"})||r.consumable.test(i.viewItem,{attributes:n+"-end-before"})||r.consumable.test(i.viewItem,{attributes:n+"-start-before"}))&&(i.modelRange||Object.assign(i,r.convertChildren(i.viewItem,i.modelCursor)),r.consumable.consume(i.viewItem,{attributes:n+"-end-after"})&&s(i.modelRange.end,i.viewItem.getAttribute(n+"-end-after").split(",")),r.consumable.consume(i.viewItem,{attributes:n+"-start-after"})&&s(i.modelRange.end,i.viewItem.getAttribute(n+"-start-after").split(",")),r.consumable.consume(i.viewItem,{attributes:n+"-end-before"})&&s(i.modelRange.start,i.viewItem.getAttribute(n+"-end-before").split(",")),r.consumable.consume(i.viewItem,{attributes:n+"-start-before"})&&s(i.modelRange.start,i.viewItem.getAttribute(n+"-start-before").split(",")))},{priority:o+l})}}(e))}}function tL(){return(e,t,i)=>{if(!t.modelRange&&i.consumable.consume(t.viewItem,{name:!0})){let{modelRange:e,modelCursor:r}=i.convertChildren(t.viewItem,t.modelCursor);t.modelRange=e,t.modelCursor=r}}}function tW(e){let t=tU(e=(0,m.Z)(e)),i=tj(e.view),r=i?`element:${i}`:"element";return i=>{i.on(r,t,{priority:e.converterPriority||"normal"})}}function tj(e){return"string"==typeof e?e:"object"==typeof e&&"string"==typeof e.name?e.name:null}function tU(e){let t=new k(e.view);return(i,r,n)=>{var s,o;let a=t.match(r.viewItem);if(!a)return;let l=a.match;if(l.name=!0,!n.consumable.test(r.viewItem,l))return;let h=(s=e.model,o=r.viewItem,s instanceof Function?s(o,n):n.writer.createElement(s));h&&n.safeInsert(h,r.modelCursor)&&(n.consumable.consume(r.viewItem,l),n.convertChildren(r.viewItem,h),n.updateConversionResult(h,r))}}function tJ(e,t=null){let i=null===t||(e=>e.getAttribute(t)),r="object"!=typeof e.model?e.model:e.model.key,n="object"!=typeof e.model||void 0===e.model.value?i:e.model.value;e.model={key:r,value:n}}function tK(e,t){let i=new k(e.view);return(r,n,s)=>{if(!n.modelRange&&t)return;let o=i.match(n.viewItem);if(!o||(!function(e,t){let i="function"==typeof e?e(t):e;return!!("object"!=typeof i||tj(i))&&!i.classes&&!i.attributes&&!i.styles}(e.view,n.viewItem)?delete o.match.name:o.match.name=!0,!s.consumable.test(n.viewItem,o.match)))return;let a=e.model.key,l="function"==typeof e.model.value?e.model.value(n.viewItem,s):e.model.value;null!==l&&(n.modelRange||Object.assign(n,s.convertChildren(n.viewItem,n.modelCursor)),function(e,t,i,r){let n=!1;for(let s of Array.from(e.getItems({shallow:i})))r.schema.checkAttribute(s,t.key)&&(n=!0,s.hasAttribute(t.key)||r.writer.setAttribute(t.key,t.value,s));return n}(n.modelRange,{key:a,value:l},t,s)&&(s.consumable.test(n.viewItem,{name:!0})&&(o.match.name=!0),s.consumable.consume(n.viewItem,o.match)))}}function tG(e,t){return{view:`${e.view}-${t}`,model:(t,i)=>{let r=t.getAttribute("name"),n=e.model(r,i);return i.writer.createElement("$marker",{"data-name":n})}}}function tz(e,t){return e.isCollapsed?function(e,t){let i=e.start,r=t.getNearestSelectionRange(i);if(!r){let e=i.getAncestors().reverse().find(e=>t.isObject(e));return e?to._createOn(e):null}if(!r.isCollapsed)return r;let n=r.start;return i.isEqual(n)?null:new to(n)}(e,t):function(e,t){let{start:i,end:r}=e,n=t.checkChild(i,"$text"),s=t.checkChild(r,"$text"),o=t.getLimitElement(i),a=t.getLimitElement(r);if(o===a){if(n&&s)return null;if(function(e,t,i){let r=e.nodeAfter&&!i.isLimit(e.nodeAfter)||i.checkChild(e,"$text"),n=t.nodeBefore&&!i.isLimit(t.nodeBefore)||i.checkChild(t,"$text");return r||n}(i,r,t)){let e=i.nodeAfter&&t.isSelectable(i.nodeAfter)?null:t.getNearestSelectionRange(i,"forward"),n=r.nodeBefore&&t.isSelectable(r.nodeBefore)?null:t.getNearestSelectionRange(r,"backward");return new to(e?e.start:i,n?n.end:r)}}let l=o&&!o.is("rootElement"),h=a&&!a.is("rootElement");if(l||h){let e=i.nodeAfter&&r.nodeBefore&&i.nodeAfter.parent===r.nodeBefore.parent,n=l&&(!e||!tZ(i.nodeAfter,t)),s=h&&(!e||!tZ(r.nodeBefore,t)),u=i,d=r;return n&&(u=te._createBefore(tH(o,t))),s&&(d=te._createAfter(tH(a,t))),new to(u,d)}return null}(e,t)}function tH(e,t){let i=e,r=i;for(;t.isLimit(r)&&r.parent;)i=r,r=r.parent;return i}function tZ(e,t){return e&&t.isSelectable(e)}class tY extends(0,r.Re)(){model;view;mapper;downcastDispatcher;constructor(e,t){var i,n,s,o,a;super(),this.model=e,this.view=new e1(t),this.mapper=new ta,this.downcastDispatcher=new tu({mapper:this.mapper,schema:e.schema});let l=this.model.document,h=l.selection,u=this.model.markers;this.listenTo(this.model,"_beforeChanges",()=>{this.view._disableRendering(!0)},{priority:"highest"}),this.listenTo(this.model,"_afterChanges",()=>{this.view._disableRendering(!1)},{priority:"lowest"}),this.listenTo(l,"change",()=>{this.view.change(e=>{this.downcastDispatcher.convertChanges(l.differ,u,e),this.downcastDispatcher.convertSelection(h,u,e)})},{priority:"low"}),this.listenTo(this.view.document,"selectionChange",(i=this.model,n=this.mapper,(e,t)=>{let r=t.newSelection,s=[];for(let e of r.getRanges())s.push(n.toModelRange(e));let o=i.createSelection(s,{backward:r.isBackward});o.isEqual(i.document.selection)||i.change(e=>{e.setSelection(o)})})),this.listenTo(this.view.document,"beforeinput",(s=this.mapper,o=this.model.schema,a=this.view,(e,t)=>{if(!a.document.isComposing||r.OB.isAndroid)for(let e=0;e<t.targetRanges.length;e++){let i=t.targetRanges[e],r=s.toModelRange(i),n=tz(r,o);!n||n.isEqual(r)||(t.targetRanges[e]=s.toViewRange(n))}}),{priority:"high"}),this.downcastDispatcher.on("insert:$text",tk(),{priority:"lowest"}),this.downcastDispatcher.on("insert",tS(),{priority:"lowest"}),this.downcastDispatcher.on("remove",(e,t,i)=>{let r=i.mapper.toViewPosition(t.position),n=t.position.getShiftedBy(t.length),s=i.mapper.toViewPosition(n,{isPhantom:!0}),o=i.writer.createRange(r,s),a=i.writer.remove(o.getTrimmed());for(let e of i.writer.createRangeIn(a).getItems())i.mapper.unbindViewElement(e,{defer:!0})},{priority:"low"}),this.downcastDispatcher.on("cleanSelection",(e,t,i)=>{let r=i.writer;for(let e of r.document.selection.getRanges())e.isCollapsed&&e.end.parent.isAttached()&&i.writer.mergeAttributes(e.start);r.setSelection(null)}),this.downcastDispatcher.on("selection",(e,t,i)=>{let r=t.selection;if(r.isCollapsed||!i.consumable.consume(r,"selection"))return;let n=[];for(let e of r.getRanges())n.push(i.mapper.toViewRange(e));i.writer.setSelection(n,{backward:r.isBackward})},{priority:"low"}),this.downcastDispatcher.on("selection",(e,t,i)=>{let r=t.selection;if(!r.isCollapsed||!i.consumable.consume(r,"selection"))return;let n=i.writer,s=r.getFirstPosition(),o=i.mapper.toViewPosition(s),a=n.breakAttributes(o);n.setSelection(a)},{priority:"low"}),this.view.document.roots.bindTo(this.model.document.roots).using(e=>{if("$graveyard"==e.rootName)return null;let t=new V(this.view.document,e.name);return t.rootName=e.rootName,this.mapper.bindElements(e,t),t})}destroy(){this.view.destroy(),this.stopListening()}reconvertMarker(e){let t="string"==typeof e?e:e.name,i=this.model.markers.get(t);if(!i)throw new r.Bb("editingcontroller-reconvertmarker-marker-not-exist",this,{markerName:t});this.model.change(()=>{this.model.markers._refresh(i)})}reconvertItem(e){this.model.change(()=>{this.model.document.differ._refreshItem(e)})}}class tQ{_consumables=new Map;add(e,t){let i;if(e.is("$text")||e.is("documentFragment")){this._consumables.set(e,!0);return}this._consumables.has(e)?i=this._consumables.get(e):(i=new t0(e),this._consumables.set(e,i)),i.add(t)}test(e,t){let i=this._consumables.get(e);return void 0===i?null:e.is("$text")||e.is("documentFragment")?i:i.test(t)}consume(e,t){return!!this.test(e,t)&&(e.is("$text")||e.is("documentFragment")?this._consumables.set(e,!1):this._consumables.get(e).consume(t),!0)}revert(e,t){let i=this._consumables.get(e);void 0!==i&&(e.is("$text")||e.is("documentFragment")?this._consumables.set(e,!0):i.revert(t))}static consumablesFromElement(e){let t={element:e,name:!0,attributes:[],classes:[],styles:[]};for(let i of e.getAttributeKeys())"style"!=i&&"class"!=i&&t.attributes.push(i);for(let i of e.getClassNames())t.classes.push(i);for(let i of e.getStyleNames())t.styles.push(i);return t}static createFrom(e,t){if(t||(t=new tQ),e.is("$text"))return t.add(e),t;for(let i of(e.is("element")&&t.add(e,tQ.consumablesFromElement(e)),e.is("documentFragment")&&t.add(e),e.getChildren()))t=tQ.createFrom(i,t);return t}}let tX=["attributes","classes","styles"];class t0{element;_canConsumeName;_consumables;constructor(e){this.element=e,this._canConsumeName=null,this._consumables={attributes:new Map,styles:new Map,classes:new Map}}add(e){for(let t of(e.name&&(this._canConsumeName=!0),tX))t in e&&this._add(t,e[t])}test(e){if(e.name&&!this._canConsumeName)return this._canConsumeName;for(let t of tX)if(t in e){let i=this._test(t,e[t]);if(!0!==i)return i}return!0}consume(e){for(let t of(e.name&&(this._canConsumeName=!1),tX))t in e&&this._consume(t,e[t])}revert(e){for(let t of(e.name&&(this._canConsumeName=!0),tX))t in e&&this._revert(t,e[t])}_add(e,t){let i=(0,r.qo)(t),n=this._consumables[e];for(let t of i){if("attributes"===e&&("class"===t||"style"===t))throw new r.Bb("viewconsumable-invalid-attribute",this);if(n.set(t,!0),"styles"===e)for(let e of this.element.document.stylesProcessor.getRelatedStyles(t))n.set(e,!0)}}_test(e,t){let i=(0,r.qo)(t),n=this._consumables[e];for(let t of i)if("attributes"===e&&("class"===t||"style"===t)){let e="class"==t?"classes":"styles",i=this._test(e,[...this._consumables[e].keys()]);if(!0!==i)return i}else{let e=n.get(t);if(void 0===e)return null;if(!e)return!1}return!0}_consume(e,t){let i=(0,r.qo)(t),n=this._consumables[e];for(let t of i)if("attributes"===e&&("class"===t||"style"===t)){let e="class"==t?"classes":"styles";this._consume(e,[...this._consumables[e].keys()])}else if(n.set(t,!1),"styles"==e)for(let e of this.element.document.stylesProcessor.getRelatedStyles(t))n.set(e,!1)}_revert(e,t){let i=(0,r.qo)(t),n=this._consumables[e];for(let t of i)if("attributes"===e&&("class"===t||"style"===t)){let e="class"==t?"classes":"styles";this._revert(e,[...this._consumables[e].keys()])}else!1===n.get(t)&&n.set(t,!0)}}class t1 extends(0,r.Re)(){_sourceDefinitions={};_attributeProperties=Object.create(null);_customChildChecks=new Map;_customAttributeChecks=new Map;_genericCheckSymbol=Symbol("$generic");_compiledDefinitions;constructor(){super(),this.decorate("checkChild"),this.decorate("checkAttribute"),this.on("checkAttribute",(e,t)=>{t[0]=new t3(t[0])},{priority:"highest"}),this.on("checkChild",(e,t)=>{t[0]=new t3(t[0]),t[1]=this.getDefinition(t[1])},{priority:"highest"})}register(e,t){if(this._sourceDefinitions[e])throw new r.Bb("schema-cannot-register-item-twice",this,{itemName:e});this._sourceDefinitions[e]=[Object.assign({},t)],this._clearCache()}extend(e,t){if(!this._sourceDefinitions[e])throw new r.Bb("schema-cannot-extend-missing-item",this,{itemName:e});this._sourceDefinitions[e].push(Object.assign({},t)),this._clearCache()}getDefinitions(){return this._compiledDefinitions||this._compile(),this._compiledDefinitions}getDefinition(e){let t;return t="string"==typeof e?e:"is"in e&&(e.is("$text")||e.is("$textProxy"))?"$text":e.name,this.getDefinitions()[t]}isRegistered(e){return!!this.getDefinition(e)}isBlock(e){let t=this.getDefinition(e);return!!(t&&t.isBlock)}isLimit(e){let t=this.getDefinition(e);return!!t&&!!(t.isLimit||t.isObject)}isObject(e){let t=this.getDefinition(e);return!!t&&!!(t.isObject||t.isLimit&&t.isSelectable&&t.isContent)}isInline(e){let t=this.getDefinition(e);return!!(t&&t.isInline)}isSelectable(e){let t=this.getDefinition(e);return!!t&&!!(t.isSelectable||t.isObject)}isContent(e){let t=this.getDefinition(e);return!!t&&!!(t.isContent||t.isObject)}checkChild(e,t){return!!t&&this._checkContextMatch(e,t)}checkAttribute(e,t){let i=this.getDefinition(e.last);if(!i)return!1;let r=this._evaluateAttributeChecks(e,t);return void 0!==r?r:i.allowAttributes.includes(t)}checkMerge(e,t){if(e instanceof te){let t=e.nodeBefore,i=e.nodeAfter;if(!(t instanceof e4))throw new r.Bb("schema-check-merge-no-element-before",this);if(!(i instanceof e4))throw new r.Bb("schema-check-merge-no-element-after",this);return this.checkMerge(t,i)}if(this.isLimit(e)||this.isLimit(t))return!1;for(let i of t.getChildren())if(!this.checkChild(e,i))return!1;return!0}addChildCheck(e,t){let i=void 0!==t?t:this._genericCheckSymbol,r=this._customChildChecks.get(i)||[];r.push(e),this._customChildChecks.set(i,r)}addAttributeCheck(e,t){let i=void 0!==t?t:this._genericCheckSymbol,r=this._customAttributeChecks.get(i)||[];r.push(e),this._customAttributeChecks.set(i,r)}setAttributeProperties(e,t){this._attributeProperties[e]=Object.assign(this.getAttributeProperties(e),t)}getAttributeProperties(e){return this._attributeProperties[e]||Object.create(null)}getLimitElement(e){let t;for(t=e instanceof te?e.parent:(e instanceof to?[e]:Array.from(e.getRanges())).reduce((e,t)=>{let i=t.getCommonAncestor();return e?e.getCommonAncestor(i,{includeSelf:!0}):i},null);!this.isLimit(t);)if(t.parent)t=t.parent;else break;return t}checkAttributeInSelection(e,t){if(e.isCollapsed){let i=[...e.getFirstPosition().getAncestors(),new e7("",e.getAttributes())];return this.checkAttribute(i,t)}for(let i of e.getRanges())for(let e of i)if(this.checkAttribute(e.item,t))return!0;return!1}*getValidRanges(e,t){for(let i of e=function*(e){for(let t of e)yield*t.getMinimalFlatRanges()}(e))yield*this._getValidRangesForRange(i,t)}getNearestSelectionRange(e,t="both"){let i,r;if("$graveyard"==e.root.rootName)return null;if(this.checkChild(e,"$text"))return new to(e);let n=e.getAncestors().reverse().find(e=>this.isLimit(e))||e.root;for(let s of(("both"==t||"backward"==t)&&(i=new e5({boundaries:to._createIn(n),startPosition:e,direction:"backward"})),("both"==t||"forward"==t)&&(r=new e5({boundaries:to._createIn(n),startPosition:e})),function*(e,t){let i=!1;for(;!i;){if(i=!0,e){let t=e.next();t.done||(i=!1,yield{walker:e,value:t.value})}if(t){let e=t.next();e.done||(i=!1,yield{walker:t,value:e.value})}}}(i,r))){let e=s.walker==i?"elementEnd":"elementStart",t=s.value;if(t.type==e&&this.isObject(t.item))return to._createOn(t.item);if(this.checkChild(t.nextPosition,"$text"))return new to(t.nextPosition)}return null}findAllowedParent(e,t){let i=e.parent;for(;i;){if(this.checkChild(i,t))return i;if(this.isLimit(i))break;i=i.parent}return null}setAllowedAttributes(e,t,i){let r=i.model;for(let[n,s]of Object.entries(t))r.schema.checkAttribute(e,n)&&i.setAttribute(n,s,e)}removeDisallowedAttributes(e,t){for(let i of e)if(i.is("$text"))t7(this,i,t);else for(let e of to._createIn(i).getPositions())t7(this,e.nodeBefore||e.parent,t)}getAttributesWithProperty(e,t,i){let r={};for(let[n,s]of e.getAttributes()){let e=this.getAttributeProperties(n);void 0!==e[t]&&(void 0===i||i===e[t])&&(r[n]=s)}return r}createContext(e){return new t3(e)}_clearCache(){this._compiledDefinitions=null}_compile(){let e={},t=this._sourceDefinitions;for(let i of Object.keys(t))e[i]=function(e,t){let i={name:t,allowIn:new Set,allowChildren:new Set,disallowIn:new Set,disallowChildren:new Set,allowContentOf:new Set,allowWhere:new Set,allowAttributes:new Set,disallowAttributes:new Set,allowAttributesOf:new Set,inheritTypesFrom:new Set};return function(e,t){for(let i of e)for(let e of Object.keys(i).filter(e=>e.startsWith("is")))t[e]=!!i[e]}(e,i),t9(e,i,"allowIn"),t9(e,i,"allowChildren"),t9(e,i,"disallowIn"),t9(e,i,"disallowChildren"),t9(e,i,"allowContentOf"),t9(e,i,"allowWhere"),t9(e,i,"allowAttributes"),t9(e,i,"disallowAttributes"),t9(e,i,"allowAttributesOf"),t9(e,i,"inheritTypesFrom"),function(e,t){for(let i of e){let e=i.inheritAllFrom;e&&(t.allowContentOf.add(e),t.allowWhere.add(e),t.allowAttributesOf.add(e),t.inheritTypesFrom.add(e))}}(e,i),i}(t[i],i);let i=Object.values(e);for(let t of i)(function(e,t){for(let i of t.allowIn){let r=e[i];r?r.allowChildren.add(t.name):t.allowIn.delete(i)}})(e,t),function(e,t){for(let i of t.allowChildren){let r=e[i];r?r.allowIn.add(t.name):t.allowChildren.delete(i)}}(e,t),function(e,t){for(let i of t.disallowIn){let r=e[i];r?r.disallowChildren.add(t.name):t.disallowIn.delete(i)}}(e,t),function(e,t){for(let i of t.disallowChildren){let r=e[i];r?r.disallowIn.add(t.name):t.disallowChildren.delete(i)}}(e,t);for(let e of i)!function(e,t){for(let e of t.disallowChildren)t.allowChildren.delete(e);for(let e of t.disallowIn)t.allowIn.delete(e);for(let e of t.disallowAttributes)t.allowAttributes.delete(e)}(0,e);for(let t of i)!function(e,t){for(let i of t.allowContentOf){let r=e[i];r&&(r.disallowChildren.forEach(i=>{t.allowChildren.has(i)||(t.disallowChildren.add(i),e[i].disallowIn.add(t.name))}),r.allowChildren.forEach(i=>{t.disallowChildren.has(i)||(t.allowChildren.add(i),e[i].allowIn.add(t.name))}))}}(e,t);for(let t of i)!function(e,t){for(let i of t.allowWhere){let r=e[i];r&&(r.disallowIn.forEach(i=>{t.allowIn.has(i)||(t.disallowIn.add(i),e[i].disallowChildren.add(t.name))}),r.allowIn.forEach(i=>{t.disallowIn.has(i)||(t.allowIn.add(i),e[i].allowChildren.add(t.name))}))}}(e,t);for(let t of i)!function(e,t){for(let i of t.allowAttributesOf){let r=e[i];if(!r)return;r.allowAttributes.forEach(e=>{t.disallowAttributes.has(e)||t.allowAttributes.add(e)})}}(e,t);for(let t of i)!function(e,t){for(let i of t.inheritTypesFrom){let r=e[i];if(r)for(let e of Object.keys(r).filter(e=>e.startsWith("is")))e in t||(t[e]=r[e])}}(e,t);this._compiledDefinitions=function(e){let t={};for(let i of Object.values(e))t[i.name]={name:i.name,isBlock:!!i.isBlock,isContent:!!i.isContent,isInline:!!i.isInline,isLimit:!!i.isLimit,isObject:!!i.isObject,isSelectable:!!i.isSelectable,allowIn:Array.from(i.allowIn).filter(t=>!!e[t]),allowChildren:Array.from(i.allowChildren).filter(t=>!!e[t]),allowAttributes:Array.from(i.allowAttributes)};return t}(e)}_checkContextMatch(e,t){let i=e.last,r=this._evaluateChildChecks(e,t);if(!(r=void 0!==r?r:t.allowIn.includes(i.name)))return!1;let n=this.getDefinition(i),s=e.trimLast();return!!n&&(0==s.length||this._checkContextMatch(s,n))}_evaluateChildChecks(e,t){for(let i of[...this._customChildChecks.get(this._genericCheckSymbol)||[],...this._customChildChecks.get(t.name)||[]]){let r=i(e,t);if(void 0!==r)return r}}_evaluateAttributeChecks(e,t){for(let i of[...this._customAttributeChecks.get(this._genericCheckSymbol)||[],...this._customAttributeChecks.get(t)||[]]){let r=i(e,t);if(void 0!==r)return r}}*_getValidRangesForRange(e,t){let i=e.start,r=e.start;for(let n of e.getItems({shallow:!0}))n.is("element")&&(yield*this._getValidRangesForRange(to._createIn(n),t)),this.checkAttribute(n,t)||(i.isEqual(r)||(yield new to(i,r)),i=te._createAfter(n)),r=te._createAfter(n);i.isEqual(r)||(yield new to(i,r))}findOptimalInsertionRange(e,t){let i=e.getSelectedElement();if(i&&this.isObject(i)&&!this.isInline(i))return"before"==t||"after"==t?new to(te._createAt(i,t)):to._createOn(i);let n=(0,r.Ps)(e.getSelectedBlocks());if(!n)return new to(e.focus);if(n.isEmpty)return new to(te._createAt(n,0));let s=te._createAfter(n);return new to(e.focus.isTouching(s)?s:te._createBefore(n))}}class t3{_items;constructor(e){let t;if(e instanceof t3)return e;t="string"==typeof e?[e]:Array.isArray(e)?e:e.getAncestors({includeSelf:!0}),this._items=t.map(t2)}get length(){return this._items.length}get last(){return this._items[this._items.length-1]}[Symbol.iterator](){return this._items[Symbol.iterator]()}push(e){let t=new t3([e]);return t._items=[...this._items,...t._items],t}trimLast(){let e=new t3([]);return e._items=this._items.slice(0,-1),e}getItem(e){return this._items[e]}*getNames(){yield*this._items.map(e=>e.name)}endsWith(e){return Array.from(this.getNames()).join(" ").endsWith(e)}startsWith(e){return Array.from(this.getNames()).join(" ").startsWith(e)}}function t9(e,t,i){for(let r of e){let e=r[i];"string"==typeof e&&(e=[e]),Array.isArray(e)&&e.forEach(e=>t[i].add(e))}}function t2(e){return"string"==typeof e||e.is("documentFragment")?{name:"string"==typeof e?e:"$documentFragment",*getAttributeKeys(){},getAttribute(){}}:{name:e.is("element")?e.name:"$text",*getAttributeKeys(){yield*e.getAttributeKeys()},getAttribute:t=>e.getAttribute(t)}}function t7(e,t,i){for(let r of t.getAttributeKeys())e.checkAttribute(t,r)||i.removeAttribute(r,t)}class t6 extends(0,r.ln)(){conversionApi;_splitParts=new Map;_cursorParents=new Map;_modelCursor=null;_emptyElementsToKeep=new Set;constructor(e){super(),this.conversionApi={...e,consumable:null,writer:null,store:null,convertItem:(e,t)=>this._convertItem(e,t),convertChildren:(e,t)=>this._convertChildren(e,t),safeInsert:(e,t)=>this._safeInsert(e,t),updateConversionResult:(e,t)=>this._updateConversionResult(e,t),splitToAllowedParent:(e,t)=>this._splitToAllowedParent(e,t),getSplitParts:e=>this._getSplitParts(e),keepEmptyElement:e=>this._keepEmptyElement(e)}}convert(e,t,i=["$root"]){this.fire("viewCleanup",e),this._modelCursor=function(e,t){let i;for(let r of new t3(e)){let e={};for(let t of r.getAttributeKeys())e[t]=r.getAttribute(t);let n=t.createElement(r.name,e);i&&t.insert(n,i),i=te._createAt(n,0)}return i}(i,t),this.conversionApi.writer=t,this.conversionApi.consumable=tQ.createFrom(e),this.conversionApi.store={};let{modelRange:r}=this._convertItem(e,this._modelCursor),n=t.createDocumentFragment();if(r){for(let e of(this._removeEmptyElements(),Array.from(this._modelCursor.parent.getChildren())))t.append(e,n);n.markers=function(e,t){let i=new Set,r=new Map;for(let t of to._createIn(e).getItems())t.is("element","$marker")&&i.add(t);for(let e of i){let i=e.getAttribute("data-name"),n=t.createPositionBefore(e);r.has(i)?r.get(i).end=n.clone():r.set(i,new to(n.clone())),t.remove(e)}return r}(n,t)}return this._modelCursor=null,this._splitParts.clear(),this._cursorParents.clear(),this._emptyElementsToKeep.clear(),this.conversionApi.writer=null,this.conversionApi.store=null,n}_convertItem(e,t){let i={viewItem:e,modelCursor:t,modelRange:null};if(e.is("element")?this.fire(`element:${e.name}`,i,this.conversionApi):e.is("$text")?this.fire("text",i,this.conversionApi):this.fire("documentFragment",i,this.conversionApi),i.modelRange&&!(i.modelRange instanceof to))throw new r.Bb("view-conversion-dispatcher-incorrect-result",this);return{modelRange:i.modelRange,modelCursor:i.modelCursor}}_convertChildren(e,t){let i=t.is("position")?t:te._createAt(t,0),r=new to(i);for(let t of Array.from(e.getChildren())){let e=this._convertItem(t,i);e.modelRange instanceof to&&(r.end=e.modelRange.end,i=e.modelCursor)}return{modelRange:r,modelCursor:i}}_safeInsert(e,t){let i=this._splitToAllowedParent(e,t);return!!i&&(this.conversionApi.writer.insert(e,i.position),!0)}_updateConversionResult(e,t){let i=this._getSplitParts(e),r=this.conversionApi.writer;t.modelRange||(t.modelRange=r.createRange(r.createPositionBefore(e),r.createPositionAfter(i[i.length-1])));let n=this._cursorParents.get(e);n?t.modelCursor=r.createPositionAt(n,0):t.modelCursor=t.modelRange.end}_splitToAllowedParent(e,t){let{schema:i,writer:r}=this.conversionApi,n=i.findAllowedParent(t,e);if(n){if(n===t.parent)return{position:t};this._modelCursor.parent.getAncestors().includes(n)&&(n=null)}if(!n)return tV(t,e,i)?{position:t$(t,r)}:null;let s=this.conversionApi.writer.split(t,n),o=[];for(let e of s.range.getWalker())if("elementEnd"==e.type)o.push(e.item);else{let t=o.pop(),i=e.item;this._registerSplitPair(t,i)}let a=s.range.end.parent;return this._cursorParents.set(e,a),{position:s.position,cursorParent:a}}_registerSplitPair(e,t){this._splitParts.has(e)||this._splitParts.set(e,[e]);let i=this._splitParts.get(e);this._splitParts.set(t,i),i.push(t)}_getSplitParts(e){return this._splitParts.has(e)?this._splitParts.get(e):[e]}_keepEmptyElement(e){this._emptyElementsToKeep.add(e)}_removeEmptyElements(){let e=!1;for(let t of this._splitParts.keys())t.isEmpty&&!this._emptyElementsToKeep.has(t)&&(this.conversionApi.writer.remove(t),this._splitParts.delete(t),e=!0);e&&this._removeEmptyElements()}}class t4{getHtml(e){let t=r.global.document.implementation.createHTMLDocument("").createElement("div");return t.appendChild(e),t.innerHTML}}class t5{domParser;domConverter;htmlWriter;skipComments=!0;constructor(e){this.domParser=new DOMParser,this.domConverter=new eI(e,{renderingMode:"data"}),this.htmlWriter=new t4}toData(e){let t=this.domConverter.viewToDom(e);return this.htmlWriter.getHtml(t)}toView(e){let t=this._toDom(e);return this.domConverter.domToView(t,{skipComments:this.skipComments})}registerRawContentMatcher(e){this.domConverter.registerRawContentMatcher(e)}useFillerType(e){this.domConverter.blockFillerMode="marked"==e?"markedNbsp":"nbsp"}_toDom(e){/<(?:html|body|head|meta)(?:\s[^>]*)?>/i.test(e.trim().slice(0,1e4))||(e=`<body>${e}</body>`);let t=this.domParser.parseFromString(e,"text/html"),i=t.createDocumentFragment(),r=t.body.childNodes;for(;r.length>0;)i.appendChild(r[0]);return i}}class t8 extends(0,r.ln)(){model;mapper;downcastDispatcher;upcastDispatcher;viewDocument;stylesProcessor;htmlProcessor;processor;_viewWriter;constructor(e,t){super(),this.model=e,this.mapper=new ta,this.downcastDispatcher=new tu({mapper:this.mapper,schema:e.schema}),this.downcastDispatcher.on("insert:$text",tk(),{priority:"lowest"}),this.downcastDispatcher.on("insert",tS(),{priority:"lowest"}),this.upcastDispatcher=new t6({schema:e.schema}),this.viewDocument=new Q(t),this.stylesProcessor=t,this.htmlProcessor=new t5(this.viewDocument),this.processor=this.htmlProcessor,this._viewWriter=new eh(this.viewDocument),this.upcastDispatcher.on("text",(e,t,{schema:i,consumable:r,writer:n})=>{let s=t.modelCursor;if(!r.test(t.viewItem))return;if(!i.checkChild(s,"$text")){if(!tV(s,"$text",i)||0==t.viewItem.data.trim().length)return;s=t$(s,n)}r.consume(t.viewItem);let o=n.createText(t.viewItem.data);n.insert(o,s),t.modelRange=n.createRange(s,s.getShiftedBy(o.offsetSize)),t.modelCursor=t.modelRange.end},{priority:"lowest"}),this.upcastDispatcher.on("element",tL(),{priority:"lowest"}),this.upcastDispatcher.on("documentFragment",tL(),{priority:"lowest"}),(0,r.Re)().prototype.decorate.call(this,"init"),(0,r.Re)().prototype.decorate.call(this,"set"),(0,r.Re)().prototype.decorate.call(this,"get"),(0,r.Re)().prototype.decorate.call(this,"toView"),(0,r.Re)().prototype.decorate.call(this,"toModel"),this.on("init",()=>{this.fire("ready")},{priority:"lowest"}),this.on("ready",()=>{this.model.enqueueChange({isUndoable:!1},tD)},{priority:"lowest"})}get(e={}){let{rootName:t="main",trim:i="empty"}=e;if(!this._checkIfRootsExists([t]))throw new r.Bb("datacontroller-get-non-existent-root",this);let n=this.model.document.getRoot(t);return(n.isAttached()||(0,r.KE)("datacontroller-get-detached-root",this),"empty"!==i||this.model.hasContent(n,{ignoreWhitespaces:!0}))?this.stringify(n,e):""}stringify(e,t={}){let i=this.toView(e,t);return this.processor.toData(i)}toView(e,t={}){let i=this.viewDocument,r=this._viewWriter;this.mapper.clearBindings();let n=to._createIn(e),s=new el(i);this.mapper.bindElements(e,s);let o=e.is("documentFragment")?e.markers:function(e){let t=[],i=e.root.document;if(!i)return new Map;let r=to._createIn(e);for(let e of i.model.markers){let i=e.getRange(),n=i.isCollapsed,s=i.start.isEqual(r.start)||i.end.isEqual(r.end);if(n&&s)t.push([e.name,i]);else{let n=r.getIntersection(i);n&&t.push([e.name,n])}}return t.sort(([e,t],[i,r])=>{if("after"!==t.end.compareWith(r.start))return 1;if("before"!==t.start.compareWith(r.end))return -1;switch(t.start.compareWith(r.start)){case"before":return 1;case"after":return -1;default:switch(t.end.compareWith(r.end)){case"before":return 1;case"after":return -1;default:return i.localeCompare(e)}}}),new Map(t)}(e);return this.downcastDispatcher.convert(n,o,r,t),s}init(e){if(this.model.document.version)throw new r.Bb("datacontroller-init-document-not-empty",this);let t={};if("string"==typeof e?t.main=e:t=e,!this._checkIfRootsExists(Object.keys(t)))throw new r.Bb("datacontroller-init-non-existent-root",this);return this.model.enqueueChange({isUndoable:!1},e=>{for(let i of Object.keys(t)){let r=this.model.document.getRoot(i);e.insert(this.parse(t[i],r),r,0)}}),Promise.resolve()}set(e,t={}){let i={};if("string"==typeof e?i.main=e:i=e,!this._checkIfRootsExists(Object.keys(i)))throw new r.Bb("datacontroller-set-non-existent-root",this);this.model.enqueueChange(t.batchType||{},e=>{for(let t of(e.setSelection(null),e.removeSelectionAttribute(this.model.document.selection.getAttributeKeys()),Object.keys(i))){let r=this.model.document.getRoot(t);e.remove(e.createRangeIn(r)),e.insert(this.parse(i[t],r),r,0)}})}parse(e,t="$root"){let i=this.processor.toView(e);return this.toModel(i,t)}toModel(e,t="$root"){return this.model.change(i=>this.upcastDispatcher.convert(e,i,t))}addStyleProcessorRules(e){e(this.stylesProcessor)}registerRawContentMatcher(e){this.processor&&this.processor!==this.htmlProcessor&&this.processor.registerRawContentMatcher(e),this.htmlProcessor.registerRawContentMatcher(e)}destroy(){this.stopListening()}_checkIfRootsExists(e){for(let t of e)if(!this.model.document.getRoot(t))return!1;return!0}}class ie{_helpers=new Map;_downcast;_upcast;constructor(e,t){this._downcast=(0,r.qo)(e),this._createConversionHelpers({name:"downcast",dispatchers:this._downcast,isDowncast:!0}),this._upcast=(0,r.qo)(t),this._createConversionHelpers({name:"upcast",dispatchers:this._upcast,isDowncast:!1})}addAlias(e,t){let i=this._downcast.includes(t);if(!this._upcast.includes(t)&&!i)throw new r.Bb("conversion-add-alias-dispatcher-not-registered",this);this._createConversionHelpers({name:e,dispatchers:[t],isDowncast:i})}for(e){if(!this._helpers.has(e))throw new r.Bb("conversion-for-unknown-group",this);return this._helpers.get(e)}elementToElement(e){for(let{model:t,view:i}of(this.for("downcast").elementToElement(e),it(e)))this.for("upcast").elementToElement({model:t,view:i,converterPriority:e.converterPriority})}attributeToElement(e){for(let{model:t,view:i}of(this.for("downcast").attributeToElement(e),it(e)))this.for("upcast").elementToAttribute({view:i,model:t,converterPriority:e.converterPriority})}attributeToAttribute(e){for(let{model:t,view:i}of(this.for("downcast").attributeToAttribute(e),it(e)))this.for("upcast").attributeToAttribute({view:i,model:t})}_createConversionHelpers({name:e,dispatchers:t,isDowncast:i}){if(this._helpers.has(e))throw new r.Bb("conversion-group-exists",this);let n=i?new tC(t):new tq(t);this._helpers.set(e,n)}}function*it(e){if(e.model.values)for(let t of e.model.values){let i={key:e.model.key,value:t},r=e.view[t],n=e.upcastAlso?e.upcastAlso[t]:void 0;yield*ii(i,r,n)}else yield*ii(e.model,e.view,e.upcastAlso)}function*ii(e,t,i){if(yield{model:e,view:t},i)for(let t of(0,r.qo)(i))yield{model:e,view:t}}class ir{baseVersion;isDocumentOperation;batch;constructor(e){this.baseVersion=e,this.isDocumentOperation=null!==this.baseVersion,this.batch=null}_validate(){}toJSON(){let e=Object.assign({},this);return e.__className=this.constructor.className,delete e.batch,delete e.isDocumentOperation,e}static get className(){return"Operation"}static fromJSON(e,t){return new this(e.baseVersion)}}function is(e,t){let i=il(t),r=i.reduce((e,t)=>e+t.offsetSize,0),n=e.parent;iu(e);let s=e.index;return n._insertChild(s,i),ih(n,s+i.length),ih(n,s),new to(e,e.getShiftedBy(r))}function io(e){if(!e.isFlat)throw new r.Bb("operation-utils-remove-range-not-flat",this);let t=e.start.parent;iu(e.start),iu(e.end);let i=t._removeChildren(e.start.index,e.end.index-e.start.index);return ih(t,e.start.index),i}function ia(e,t){if(!e.isFlat)throw new r.Bb("operation-utils-move-range-not-flat",this);let i=io(e);return is(t=t._getTransformedByDeletion(e.start,e.end.offset-e.start.offset),i)}function il(e){let t=[];!function e(i){if("string"==typeof i)t.push(new e7(i));else if(i instanceof e6)t.push(new e7(i.data,i.getAttributes()));else if(i instanceof e9)t.push(i);else if((0,r.TW)(i))for(let t of i)e(t)}(e);for(let e=1;e<t.length;e++){let i=t[e],r=t[e-1];i instanceof e7&&r instanceof e7&&id(i,r)&&(t.splice(e-1,2,new e7(r.data+i.data,r.getAttributes())),e--)}return t}function ih(e,t){let i=e.getChild(t-1),r=e.getChild(t);if(i&&r&&i.is("$text")&&r.is("$text")&&id(i,r)){let n=new e7(i.data+r.data,i.getAttributes());e._removeChildren(t-1,2),e._insertChild(t-1,n)}}function iu(e){let t=e.textNode,i=e.parent;if(t){let r=e.offset-t.startOffset,n=t.index;i._removeChildren(n,1);let s=new e7(t.data.substr(0,r),t.getAttributes()),o=new e7(t.data.substr(r),t.getAttributes());i._insertChild(n,[s,o])}}function id(e,t){let i=e.getAttributes(),r=t.getAttributes();for(let e of i){if(e[1]!==t.getAttribute(e[0]))return!1;r.next()}return r.next().done}class ic extends ir{sourcePosition;howMany;targetPosition;constructor(e,t,i,r){super(r),this.sourcePosition=e.clone(),this.sourcePosition.stickiness="toNext",this.howMany=t,this.targetPosition=i.clone(),this.targetPosition.stickiness="toNone"}get type(){return"$graveyard"==this.targetPosition.root.rootName?"remove":"$graveyard"==this.sourcePosition.root.rootName?"reinsert":"move"}get affectedSelectable(){return[to._createFromPositionAndShift(this.sourcePosition,this.howMany),to._createFromPositionAndShift(this.targetPosition,0)]}clone(){return new ic(this.sourcePosition,this.howMany,this.targetPosition,this.baseVersion)}getMovedRangeStart(){return this.targetPosition._getTransformedByDeletion(this.sourcePosition,this.howMany)}getReversed(){let e=this.sourcePosition._getTransformedByInsertion(this.targetPosition,this.howMany);return new ic(this.getMovedRangeStart(),this.howMany,e,this.baseVersion+1)}_validate(){let e=this.sourcePosition.parent,t=this.targetPosition.parent,i=this.sourcePosition.offset,n=this.targetPosition.offset;if(i+this.howMany>e.maxOffset)throw new r.Bb("move-operation-nodes-do-not-exist",this);if(e===t&&i<n&&n<i+this.howMany)throw new r.Bb("move-operation-range-into-itself",this);if(this.sourcePosition.root==this.targetPosition.root&&"prefix"==(0,r.Rt)(this.sourcePosition.getParentPath(),this.targetPosition.getParentPath())){let e=this.sourcePosition.path.length-1;if(this.targetPosition.path[e]>=i&&this.targetPosition.path[e]<i+this.howMany)throw new r.Bb("move-operation-node-into-itself",this)}}_execute(){ia(to._createFromPositionAndShift(this.sourcePosition,this.howMany),this.targetPosition)}toJSON(){let e=super.toJSON();return e.sourcePosition=this.sourcePosition.toJSON(),e.targetPosition=this.targetPosition.toJSON(),e}static get className(){return"MoveOperation"}static fromJSON(e,t){let i=te.fromJSON(e.sourcePosition,t),r=te.fromJSON(e.targetPosition,t);return new this(i,e.howMany,r,e.baseVersion)}}class im extends ir{position;nodes;shouldReceiveAttributes;constructor(e,t,i){super(i),this.position=e.clone(),this.position.stickiness="toNone",this.nodes=new e2(il(t)),this.shouldReceiveAttributes=!1}get type(){return"insert"}get howMany(){return this.nodes.maxOffset}get affectedSelectable(){return this.position.clone()}clone(){let e=new e2([...this.nodes].map(e=>e._clone(!0))),t=new im(this.position,e,this.baseVersion);return t.shouldReceiveAttributes=this.shouldReceiveAttributes,t}getReversed(){let e=new te(this.position.root.document.graveyard,[0]);return new ic(this.position,this.nodes.maxOffset,e,this.baseVersion+1)}_validate(){let e=this.position.parent;if(!e||e.maxOffset<this.position.offset)throw new r.Bb("insert-operation-position-invalid",this)}_execute(){let e=this.nodes;this.nodes=new e2([...e].map(e=>e._clone(!0))),is(this.position,e)}toJSON(){let e=super.toJSON();return e.position=this.position.toJSON(),e.nodes=this.nodes.toJSON(),e}static get className(){return"InsertOperation"}static fromJSON(e,t){let i=[];for(let t of e.nodes)t.name?i.push(e4.fromJSON(t)):i.push(e7.fromJSON(t));let r=new im(te.fromJSON(e.position,t),i,e.baseVersion);return r.shouldReceiveAttributes=e.shouldReceiveAttributes,r}}class ig extends ir{splitPosition;howMany;insertionPosition;graveyardPosition;constructor(e,t,i,r,n){super(n),this.splitPosition=e.clone(),this.splitPosition.stickiness="toNext",this.howMany=t,this.insertionPosition=i,this.graveyardPosition=r?r.clone():null,this.graveyardPosition&&(this.graveyardPosition.stickiness="toNext")}get type(){return"split"}get moveTargetPosition(){let e=this.insertionPosition.path.slice();return e.push(0),new te(this.insertionPosition.root,e)}get movedRange(){let e=this.splitPosition.getShiftedBy(Number.POSITIVE_INFINITY);return new to(this.splitPosition,e)}get affectedSelectable(){let e=[to._createFromPositionAndShift(this.splitPosition,0),to._createFromPositionAndShift(this.insertionPosition,0)];return this.graveyardPosition&&e.push(to._createFromPositionAndShift(this.graveyardPosition,0)),e}clone(){return new ig(this.splitPosition,this.howMany,this.insertionPosition,this.graveyardPosition,this.baseVersion)}getReversed(){let e=new te(this.splitPosition.root.document.graveyard,[0]);return new ip(this.moveTargetPosition,this.howMany,this.splitPosition,e,this.baseVersion+1)}_validate(){let e=this.splitPosition.parent,t=this.splitPosition.offset;if(!e||e.maxOffset<t)throw new r.Bb("split-operation-position-invalid",this);if(e.parent){if(this.howMany!=e.maxOffset-this.splitPosition.offset)throw new r.Bb("split-operation-how-many-invalid",this);if(this.graveyardPosition&&!this.graveyardPosition.nodeAfter)throw new r.Bb("split-operation-graveyard-position-invalid",this)}else throw new r.Bb("split-operation-split-in-root",this)}_execute(){let e=this.splitPosition.parent;if(this.graveyardPosition)ia(to._createFromPositionAndShift(this.graveyardPosition,1),this.insertionPosition);else{let t=e._clone();is(this.insertionPosition,t)}ia(new to(te._createAt(e,this.splitPosition.offset),te._createAt(e,e.maxOffset)),this.moveTargetPosition)}toJSON(){let e=super.toJSON();return e.splitPosition=this.splitPosition.toJSON(),e.insertionPosition=this.insertionPosition.toJSON(),this.graveyardPosition&&(e.graveyardPosition=this.graveyardPosition.toJSON()),e}static get className(){return"SplitOperation"}static getInsertionPosition(e){let t=e.path.slice(0,-1);return t[t.length-1]++,new te(e.root,t,"toPrevious")}static fromJSON(e,t){let i=te.fromJSON(e.splitPosition,t),r=te.fromJSON(e.insertionPosition,t),n=e.graveyardPosition?te.fromJSON(e.graveyardPosition,t):null;return new this(i,e.howMany,r,n,e.baseVersion)}}class ip extends ir{sourcePosition;howMany;targetPosition;graveyardPosition;constructor(e,t,i,r,n){super(n),this.sourcePosition=e.clone(),this.sourcePosition.stickiness="toPrevious",this.howMany=t,this.targetPosition=i.clone(),this.targetPosition.stickiness="toNext",this.graveyardPosition=r.clone()}get type(){return"merge"}get deletionPosition(){return new te(this.sourcePosition.root,this.sourcePosition.path.slice(0,-1))}get movedRange(){let e=this.sourcePosition.getShiftedBy(Number.POSITIVE_INFINITY);return new to(this.sourcePosition,e)}get affectedSelectable(){let e=this.sourcePosition.parent;return[to._createOn(e),to._createFromPositionAndShift(this.targetPosition,0),to._createFromPositionAndShift(this.graveyardPosition,0)]}clone(){return new ip(this.sourcePosition,this.howMany,this.targetPosition,this.graveyardPosition,this.baseVersion)}getReversed(){let e=this.targetPosition._getTransformedByMergeOperation(this),t=this.sourcePosition.path.slice(0,-1),i=new te(this.sourcePosition.root,t)._getTransformedByMergeOperation(this);return new ig(e,this.howMany,i,this.graveyardPosition,this.baseVersion+1)}_validate(){let e=this.sourcePosition.parent,t=this.targetPosition.parent;if(e.parent){if(t.parent){if(this.howMany!=e.maxOffset)throw new r.Bb("merge-operation-how-many-invalid",this)}else throw new r.Bb("merge-operation-target-position-invalid",this)}else throw new r.Bb("merge-operation-source-position-invalid",this)}_execute(){let e=this.sourcePosition.parent;ia(to._createIn(e),this.targetPosition),ia(to._createOn(e),this.graveyardPosition)}toJSON(){let e=super.toJSON();return e.sourcePosition=e.sourcePosition.toJSON(),e.targetPosition=e.targetPosition.toJSON(),e.graveyardPosition=e.graveyardPosition.toJSON(),e}static get className(){return"MergeOperation"}static fromJSON(e,t){let i=te.fromJSON(e.sourcePosition,t),r=te.fromJSON(e.targetPosition,t),n=te.fromJSON(e.graveyardPosition,t);return new this(i,e.howMany,r,n,e.baseVersion)}}class i_ extends ir{name;oldRange;newRange;affectsData;_markers;constructor(e,t,i,r,n,s){super(s),this.name=e,this.oldRange=t?t.clone():null,this.newRange=i?i.clone():null,this.affectsData=n,this._markers=r}get type(){return"marker"}get affectedSelectable(){let e=[];return this.oldRange&&e.push(this.oldRange.clone()),this.newRange&&(this.oldRange?e.push(...this.newRange.getDifference(this.oldRange)):e.push(this.newRange.clone())),e}clone(){return new i_(this.name,this.oldRange,this.newRange,this._markers,this.affectsData,this.baseVersion)}getReversed(){return new i_(this.name,this.newRange,this.oldRange,this._markers,this.affectsData,this.baseVersion+1)}_execute(){this.newRange?this._markers._set(this.name,this.newRange,!0,this.affectsData):this._markers._remove(this.name)}toJSON(){let e=super.toJSON();return this.oldRange&&(e.oldRange=this.oldRange.toJSON()),this.newRange&&(e.newRange=this.newRange.toJSON()),delete e._markers,e}static get className(){return"MarkerOperation"}static fromJSON(e,t){return new i_(e.name,e.oldRange?to.fromJSON(e.oldRange,t):null,e.newRange?to.fromJSON(e.newRange,t):null,t.model.markers,e.affectsData,e.baseVersion)}}class iw extends ir{range;key;oldValue;newValue;constructor(e,t,i,r,n){super(n),this.range=e.clone(),this.key=t,this.oldValue=void 0===i?null:i,this.newValue=void 0===r?null:r}get type(){return null===this.oldValue?"addAttribute":null===this.newValue?"removeAttribute":"changeAttribute"}get affectedSelectable(){return this.range.clone()}clone(){return new iw(this.range,this.key,this.oldValue,this.newValue,this.baseVersion)}getReversed(){return new iw(this.range,this.key,this.newValue,this.oldValue,this.baseVersion+1)}toJSON(){let e=super.toJSON();return e.range=this.range.toJSON(),e}_validate(){if(!this.range.isFlat)throw new r.Bb("attribute-operation-range-not-flat",this);for(let e of this.range.getItems({shallow:!0})){if(null!==this.oldValue&&!(0,g.Z)(e.getAttribute(this.key),this.oldValue))throw new r.Bb("attribute-operation-wrong-old-value",this,{item:e,key:this.key,value:this.oldValue});if(null===this.oldValue&&null!==this.newValue&&e.hasAttribute(this.key))throw new r.Bb("attribute-operation-attribute-exists",this,{node:e,key:this.key})}}_execute(){(0,g.Z)(this.oldValue,this.newValue)||function(e,t,i){for(let r of(iu(e.start),iu(e.end),e.getItems({shallow:!0}))){let e=r.is("$textProxy")?r.textNode:r;null!==i?e._setAttribute(t,i):e._removeAttribute(t),ih(e.parent,e.index)}ih(e.end.parent,e.end.index)}(this.range,this.key,this.newValue)}static get className(){return"AttributeOperation"}static fromJSON(e,t){return new iw(to.fromJSON(e.range,t),e.key,e.oldValue,e.newValue,e.baseVersion)}}class ib extends ir{get type(){return"noop"}get affectedSelectable(){return null}clone(){return new ib(this.baseVersion)}getReversed(){return new ib(this.baseVersion+1)}_execute(){}static get className(){return"NoOperation"}}class iy extends ir{position;oldName;newName;constructor(e,t,i,r){super(r),this.position=e,this.position.stickiness="toNext",this.oldName=t,this.newName=i}get type(){return"rename"}get affectedSelectable(){return this.position.nodeAfter}clone(){return new iy(this.position.clone(),this.oldName,this.newName,this.baseVersion)}getReversed(){return new iy(this.position.clone(),this.newName,this.oldName,this.baseVersion+1)}_validate(){let e=this.position.nodeAfter;if(e instanceof e4){if(e.name!==this.oldName)throw new r.Bb("rename-operation-wrong-name",this)}else throw new r.Bb("rename-operation-wrong-position",this)}_execute(){this.position.nodeAfter.name=this.newName}toJSON(){let e=super.toJSON();return e.position=this.position.toJSON(),e}static get className(){return"RenameOperation"}static fromJSON(e,t){return new iy(te.fromJSON(e.position,t),e.oldName,e.newName,e.baseVersion)}}class iv extends ir{root;key;oldValue;newValue;constructor(e,t,i,r,n){super(n),this.root=e,this.key=t,this.oldValue=void 0===i?null:i,this.newValue=void 0===r?null:r}get type(){return null===this.oldValue?"addRootAttribute":null===this.newValue?"removeRootAttribute":"changeRootAttribute"}get affectedSelectable(){return this.root}clone(){return new iv(this.root,this.key,this.oldValue,this.newValue,this.baseVersion)}getReversed(){return new iv(this.root,this.key,this.newValue,this.oldValue,this.baseVersion+1)}_validate(){if(this.root!=this.root.root||this.root.is("documentFragment"))throw new r.Bb("rootattribute-operation-not-a-root",this,{root:this.root,key:this.key});if(null!==this.oldValue&&this.root.getAttribute(this.key)!==this.oldValue)throw new r.Bb("rootattribute-operation-wrong-old-value",this,{root:this.root,key:this.key});if(null===this.oldValue&&null!==this.newValue&&this.root.hasAttribute(this.key))throw new r.Bb("rootattribute-operation-attribute-exists",this,{root:this.root,key:this.key})}_execute(){null!==this.newValue?this.root._setAttribute(this.key,this.newValue):this.root._removeAttribute(this.key)}toJSON(){let e=super.toJSON();return e.root=this.root.toJSON(),e}static get className(){return"RootAttributeOperation"}static fromJSON(e,t){if(!t.getRoot(e.root))throw new r.Bb("rootattribute-operation-fromjson-no-root",this,{rootName:e.root});return new iv(t.getRoot(e.root),e.key,e.oldValue,e.newValue,e.baseVersion)}}class iP extends ir{rootName;elementName;isAdd;_document;constructor(e,t,i,r,n){super(n),this.rootName=e,this.elementName=t,this.isAdd=i,this._document=r,this._document.getRoot(this.rootName)||(this._document.createRoot(this.elementName,this.rootName)._isAttached=!1)}get type(){return this.isAdd?"addRoot":"detachRoot"}get affectedSelectable(){return this._document.getRoot(this.rootName)}clone(){return new iP(this.rootName,this.elementName,this.isAdd,this._document,this.baseVersion)}getReversed(){return new iP(this.rootName,this.elementName,!this.isAdd,this._document,this.baseVersion+1)}_execute(){this._document.getRoot(this.rootName)._isAttached=this.isAdd}toJSON(){let e=super.toJSON();return delete e._document,e}static get className(){return"RootOperation"}static fromJSON(e,t){return new iP(e.rootName,e.elementName,e.isAdd,t,e.baseVersion)}}let iA={};iA[iw.className]=iw,iA[im.className]=im,iA[i_.className]=i_,iA[ic.className]=ic,iA[ib.className]=ib,iA[ir.className]=ir,iA[iy.className]=iy,iA[iv.className]=iv,iA[iP.className]=iP,iA[ig.className]=ig,iA[ip.className]=ip;class iC{static fromJSON(e,t){return iA[e.__className].fromJSON(e,t)}}let ik=new Map;function iS(e,t,i){let r=ik.get(e);r||(r=new Map,ik.set(e,r)),r.set(t,i)}function iE(e){return[e]}function iR(e,t,i={}){let r=function(e,t){let i=ik.get(e);return i&&i.has(t)?i.get(t):iE}(e.constructor,t.constructor);try{return e=e.clone(),r(e,t,i)}catch(e){throw e}}function iO(e,t,i){e=e.slice(),t=t.slice();let r=new iT(i.document,i.useRelations,i.forceWeakRemove);r.setOriginalOperations(e),r.setOriginalOperations(t);let n=r.originalOperations;if(0==e.length||0==t.length)return{operationsA:e,operationsB:t,originalOperations:n};let s=new WeakMap;for(let t of e)s.set(t,0);let o={nextBaseVersionA:e[e.length-1].baseVersion+1,nextBaseVersionB:t[t.length-1].baseVersion+1,originalOperationsACount:e.length,originalOperationsBCount:t.length},a=0;for(;a<e.length;){let i=e[a],n=s.get(i);if(n==t.length){a++;continue}let o=t[n],l=iR(i,o,r.getContext(i,o,!0)),h=iR(o,i,r.getContext(o,i,!1));for(let e of(r.updateRelation(i,o),r.setOriginalOperations(l,i),r.setOriginalOperations(h,o),l))s.set(e,n+h.length);e.splice(a,1,...l),t.splice(n,1,...h)}if(iN(e),iN(t),i.padWithNoOps){let i=e.length-o.originalOperationsACount,r=t.length-o.originalOperationsBCount;iM(e,r-i),iM(t,i-r)}return ix(e,o.nextBaseVersionB),ix(t,o.nextBaseVersionA),{operationsA:e,operationsB:t,originalOperations:n}}class iT{originalOperations;_history;_useRelations;_forceWeakRemove;_relations;constructor(e,t,i=!1){this.originalOperations=new Map,this._history=e.history,this._useRelations=t,this._forceWeakRemove=!!i,this._relations=new Map}setOriginalOperations(e,t=null){let i=t?this.originalOperations.get(t):null;for(let t of e)this.originalOperations.set(t,i||t)}updateRelation(e,t){if(e instanceof ic)t instanceof ip?e.targetPosition.isEqual(t.sourcePosition)||t.movedRange.containsPosition(e.targetPosition)?this._setRelation(e,t,"insertAtSource"):e.targetPosition.isEqual(t.deletionPosition)?this._setRelation(e,t,"insertBetween"):e.targetPosition.isAfter(t.sourcePosition)&&this._setRelation(e,t,"moveTargetAfter"):t instanceof ic&&(e.targetPosition.isEqual(t.sourcePosition)||e.targetPosition.isBefore(t.sourcePosition)?this._setRelation(e,t,"insertBefore"):this._setRelation(e,t,"insertAfter"));else if(e instanceof ig){if(t instanceof ip)e.splitPosition.isBefore(t.sourcePosition)&&this._setRelation(e,t,"splitBefore");else if(t instanceof ic){if(e.splitPosition.isEqual(t.sourcePosition)||e.splitPosition.isBefore(t.sourcePosition))this._setRelation(e,t,"splitBefore");else{let i=to._createFromPositionAndShift(t.sourcePosition,t.howMany);if(e.splitPosition.hasSameParentAs(t.sourcePosition)&&i.containsPosition(e.splitPosition)){let r=i.end.offset-e.splitPosition.offset,n=e.splitPosition.offset-i.start.offset;this._setRelation(e,t,{howMany:r,offset:n})}}}}else if(e instanceof ip)t instanceof ip?(e.targetPosition.isEqual(t.sourcePosition)||this._setRelation(e,t,"mergeTargetNotMoved"),e.sourcePosition.isEqual(t.targetPosition)&&this._setRelation(e,t,"mergeSourceNotMoved"),e.sourcePosition.isEqual(t.sourcePosition)&&this._setRelation(e,t,"mergeSameElement")):t instanceof ig?e.sourcePosition.isEqual(t.splitPosition)&&this._setRelation(e,t,"splitAtSource"):t instanceof ic&&t.howMany>0&&(e.sourcePosition.isEqual(t.sourcePosition.getShiftedBy(t.howMany))&&this._setRelation(e,t,"mergeSourceAffected"),e.targetPosition.isEqual(t.sourcePosition)&&this._setRelation(e,t,"mergeTargetWasBefore"));else if(e instanceof i_){let i=e.newRange;if(!i)return;if(t instanceof ip){let r=i.start.isEqual(t.targetPosition),n=i.start.isEqual(t.deletionPosition),s=i.end.isEqual(t.deletionPosition),o=i.end.isEqual(t.sourcePosition);(r||n||s||o)&&this._setRelation(e,t,{wasInLeftElement:r,wasStartBeforeMergedElement:n,wasEndBeforeMergedElement:s,wasInRightElement:o})}}}getContext(e,t,i){return{aIsStrong:i,aWasUndone:this._wasUndone(e),bWasUndone:this._wasUndone(t),abRelation:this._useRelations?this._getRelation(e,t):null,baRelation:this._useRelations?this._getRelation(t,e):null,forceWeakRemove:this._forceWeakRemove}}_wasUndone(e){let t=this.originalOperations.get(e);return t.wasUndone||this._history.isUndoneOperation(t)}_getRelation(e,t){let i=this.originalOperations.get(t),r=this._history.getUndoneOperation(i);if(!r)return null;let n=this.originalOperations.get(e),s=this._relations.get(n);return s&&s.get(r)||null}_setRelation(e,t,i){let r=this.originalOperations.get(e),n=this.originalOperations.get(t),s=this._relations.get(r);s||(s=new Map,this._relations.set(r,s)),s.set(n,i)}}function ix(e,t){for(let i of e)i.baseVersion=t++}function iM(e,t){for(let i=0;i<t;i++)e.push(new ib(0))}function iN(e){let t=new Map;for(let i=0;i<e.length;i++){let r=e[i];r instanceof i_&&(-1!==r.baseVersion?t.set(r.name,{op:r,ranges:r.newRange?[r.newRange]:[]}):(r.newRange&&t.get(r.name).ranges.push(r.newRange),e.splice(i,1),i--))}for(let{op:e,ranges:i}of t.values())i.length?e.newRange=to._createFromRanges(i):e.newRange=null}function iB(e,t,i){let r=e.nodes.getNode(0).getAttribute(t);return r==i?null:new iw(new to(e.position,e.position.getShiftedBy(e.howMany)),t,r,i,0)}function iF(e,t){return null===e.targetPosition._getTransformedByDeletion(t.sourcePosition,t.howMany)}function iI(e,t){let i=[];for(let r=0;r<e.length;r++){let n=e[r],s=new ic(n.start,n.end.offset-n.start.offset,t,0);i.push(s);for(let t=r+1;t<e.length;t++)e[t]=e[t]._getTransformedByMove(s.sourcePosition,s.targetPosition,s.howMany)[0];t=t._getTransformedByMove(s.sourcePosition,s.targetPosition,s.howMany)}return i}iS(iw,iw,(e,t,i)=>{if(!(e.key===t.key&&e.range.start.hasSameParentAs(t.range.start)))return[e];{let r=e.range.getDifference(t.range).map(t=>new iw(t,e.key,e.oldValue,e.newValue,0)),n=e.range.getIntersection(t.range);return(n&&i.aIsStrong&&r.push(new iw(n,t.key,t.newValue,e.newValue,0)),0==r.length)?[new ib(0)]:r}}),iS(iw,im,(e,t)=>{if(e.range.start.hasSameParentAs(t.position)&&e.range.containsPosition(t.position)){let i=e.range._getTransformedByInsertion(t.position,t.howMany,!t.shouldReceiveAttributes).map(t=>new iw(t,e.key,e.oldValue,e.newValue,e.baseVersion));if(t.shouldReceiveAttributes){let r=iB(t,e.key,e.oldValue);r&&i.unshift(r)}return i}return e.range=e.range._getTransformedByInsertion(t.position,t.howMany,!1)[0],[e]}),iS(iw,ip,(e,t)=>{let i=[];e.range.start.hasSameParentAs(t.deletionPosition)&&(e.range.containsPosition(t.deletionPosition)||e.range.start.isEqual(t.deletionPosition))&&i.push(to._createFromPositionAndShift(t.graveyardPosition,1));let r=e.range._getTransformedByMergeOperation(t);return r.isCollapsed||i.push(r),i.map(t=>new iw(t,e.key,e.oldValue,e.newValue,e.baseVersion))}),iS(iw,ic,(e,t)=>(function(e,t){let i=to._createFromPositionAndShift(t.sourcePosition,t.howMany),r=null,n=[];i.containsRange(e,!0)?r=e:e.start.hasSameParentAs(i.start)?(n=e.getDifference(i),r=e.getIntersection(i)):n=[e];let s=[];for(let e of n){e=e._getTransformedByDeletion(t.sourcePosition,t.howMany);let i=t.getMovedRangeStart(),r=e.start.hasSameParentAs(i),n=e._getTransformedByInsertion(i,t.howMany,r);s.push(...n)}return r&&s.push(r._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany,!1)[0]),s})(e.range,t).map(t=>new iw(t,e.key,e.oldValue,e.newValue,e.baseVersion))),iS(iw,ig,(e,t)=>{if(e.range.end.isEqual(t.insertionPosition))return!t.graveyardPosition&&e.range.end.offset++,[e];if(e.range.start.hasSameParentAs(t.splitPosition)&&e.range.containsPosition(t.splitPosition)){let i=e.clone();return i.range=new to(t.moveTargetPosition.clone(),e.range.end._getCombined(t.splitPosition,t.moveTargetPosition)),e.range.end=t.splitPosition.clone(),e.range.end.stickiness="toPrevious",[e,i]}return e.range=e.range._getTransformedBySplitOperation(t),[e]}),iS(im,iw,(e,t)=>{let i=[e];if(e.shouldReceiveAttributes&&e.position.hasSameParentAs(t.range.start)&&t.range.containsPosition(e.position)){let r=iB(e,t.key,t.newValue);r&&i.push(r)}return i}),iS(im,im,(e,t,i)=>(e.position.isEqual(t.position)&&i.aIsStrong||(e.position=e.position._getTransformedByInsertOperation(t)),[e])),iS(im,ic,(e,t)=>(e.position=e.position._getTransformedByMoveOperation(t),[e])),iS(im,ig,(e,t)=>(e.position=e.position._getTransformedBySplitOperation(t),[e])),iS(im,ip,(e,t)=>(e.position=e.position._getTransformedByMergeOperation(t),[e])),iS(i_,im,(e,t)=>(e.oldRange&&(e.oldRange=e.oldRange._getTransformedByInsertOperation(t)[0]),e.newRange&&(e.newRange=e.newRange._getTransformedByInsertOperation(t)[0]),[e])),iS(i_,i_,(e,t,i)=>{if(e.name==t.name){if(!i.aIsStrong)return[new ib(0)];e.oldRange=t.newRange?t.newRange.clone():null}return[e]}),iS(i_,ip,(e,t)=>(e.oldRange&&(e.oldRange=e.oldRange._getTransformedByMergeOperation(t)),e.newRange&&(e.newRange=e.newRange._getTransformedByMergeOperation(t)),[e])),iS(i_,ic,(e,t)=>{let i=[e];if(e.oldRange&&(e.oldRange=to._createFromRanges(e.oldRange._getTransformedByMoveOperation(t))),e.newRange){let r=e.newRange._getTransformedByMoveOperation(t);e.newRange=r[0];for(let t=1;t<r.length;t++){let n=e.clone();n.oldRange=null,n.newRange=r[t],n.baseVersion=-1,i.push(n)}}return i}),iS(i_,ig,(e,t,i)=>{if(e.oldRange&&(e.oldRange=e.oldRange._getTransformedBySplitOperation(t)),e.newRange){if(i.abRelation){let r=e.newRange._getTransformedBySplitOperation(t);return e.newRange.start.isEqual(t.splitPosition)&&i.abRelation.wasStartBeforeMergedElement?e.newRange.start=te._createAt(t.insertionPosition):e.newRange.start.isEqual(t.splitPosition)&&!i.abRelation.wasInLeftElement?e.newRange.start=te._createAt(t.moveTargetPosition):e.newRange.start=r.start,e.newRange.end.isEqual(t.splitPosition)&&i.abRelation.wasInRightElement?e.newRange.end=te._createAt(t.moveTargetPosition):e.newRange.end.isEqual(t.splitPosition)&&i.abRelation.wasEndBeforeMergedElement?e.newRange.end=te._createAt(t.insertionPosition):e.newRange.end=r.end,[e]}e.newRange=e.newRange._getTransformedBySplitOperation(t)}return[e]}),iS(ip,im,(e,t)=>(e.sourcePosition.hasSameParentAs(t.position)&&(e.howMany+=t.howMany),e.sourcePosition=e.sourcePosition._getTransformedByInsertOperation(t),e.targetPosition=e.targetPosition._getTransformedByInsertOperation(t),[e])),iS(ip,ip,(e,t,i)=>{if(e.sourcePosition.isEqual(t.sourcePosition)&&e.targetPosition.isEqual(t.targetPosition)){if(!i.bWasUndone)return[new ib(0)];{let i=t.graveyardPosition.path.slice();return i.push(0),e.sourcePosition=new te(t.graveyardPosition.root,i),e.howMany=0,[e]}}if(e.sourcePosition.isEqual(t.sourcePosition)&&!e.targetPosition.isEqual(t.targetPosition)&&!i.bWasUndone&&"splitAtSource"!=i.abRelation){let r="$graveyard"==e.targetPosition.root.rootName,n="$graveyard"==t.targetPosition.root.rootName;if(!(n&&!r||!(r&&!n)&&i.aIsStrong))return[new ib(0)];{let i=t.targetPosition._getTransformedByMergeOperation(t),r=e.targetPosition._getTransformedByMergeOperation(t);return[new ic(i,e.howMany,r,0)]}}return e.sourcePosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.sourcePosition=e.sourcePosition._getTransformedByMergeOperation(t),e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),e.graveyardPosition.isEqual(t.graveyardPosition)&&i.aIsStrong||(e.graveyardPosition=e.graveyardPosition._getTransformedByMergeOperation(t)),[e]}),iS(ip,ic,(e,t,i)=>{let r=to._createFromPositionAndShift(t.sourcePosition,t.howMany);return"remove"==t.type&&!i.bWasUndone&&e.deletionPosition.hasSameParentAs(t.sourcePosition)&&r.containsPosition(e.sourcePosition)?[new ib(0)]:(t.sourcePosition.getShiftedBy(t.howMany).isEqual(e.sourcePosition)?e.sourcePosition.stickiness="toNone":t.targetPosition.isEqual(e.sourcePosition)&&"mergeSourceAffected"==i.abRelation?e.sourcePosition.stickiness="toNext":t.sourcePosition.isEqual(e.targetPosition)?(e.targetPosition.stickiness="toNone",e.howMany-=t.howMany):t.targetPosition.isEqual(e.targetPosition)&&"mergeTargetWasBefore"==i.abRelation?(e.targetPosition.stickiness="toPrevious",e.howMany+=t.howMany):(e.sourcePosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.sourcePosition.hasSameParentAs(t.sourcePosition)&&(e.howMany-=t.howMany)),e.sourcePosition=e.sourcePosition._getTransformedByMoveOperation(t),e.targetPosition=e.targetPosition._getTransformedByMoveOperation(t),e.sourcePosition.stickiness="toPrevious",e.targetPosition.stickiness="toNext",e.graveyardPosition.isEqual(t.targetPosition)||(e.graveyardPosition=e.graveyardPosition._getTransformedByMoveOperation(t)),[e])}),iS(ip,ig,(e,t,i)=>{if(t.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedByDeletion(t.graveyardPosition,1),e.deletionPosition.isEqual(t.graveyardPosition)&&(e.howMany=t.howMany)),e.targetPosition.isEqual(t.splitPosition)&&(t.graveyardPosition&&e.deletionPosition.isEqual(t.graveyardPosition)||"mergeTargetNotMoved"==i.abRelation))return e.sourcePosition=e.sourcePosition._getTransformedBySplitOperation(t),[e];if(e.sourcePosition.isEqual(t.splitPosition)){if("mergeSourceNotMoved"==i.abRelation)return e.howMany=0,e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e];if("mergeSameElement"==i.abRelation||e.sourcePosition.offset>0)return e.sourcePosition=t.moveTargetPosition.clone(),e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e]}return e.sourcePosition.hasSameParentAs(t.splitPosition)&&(e.howMany=t.splitPosition.offset),e.sourcePosition=e.sourcePosition._getTransformedBySplitOperation(t),e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e]}),iS(ic,im,(e,t)=>{let i=to._createFromPositionAndShift(e.sourcePosition,e.howMany)._getTransformedByInsertOperation(t,!1)[0];return e.sourcePosition=i.start,e.howMany=i.end.offset-i.start.offset,e.targetPosition.isEqual(t.position)||(e.targetPosition=e.targetPosition._getTransformedByInsertOperation(t)),[e]}),iS(ic,ic,(e,t,i)=>{let n;let s=to._createFromPositionAndShift(e.sourcePosition,e.howMany),o=to._createFromPositionAndShift(t.sourcePosition,t.howMany),a=i.aIsStrong,l=!i.aIsStrong;if("insertBefore"==i.abRelation||"insertAfter"==i.baRelation?l=!0:("insertAfter"==i.abRelation||"insertBefore"==i.baRelation)&&(l=!1),n=e.targetPosition.isEqual(t.targetPosition)&&l?e.targetPosition._getTransformedByDeletion(t.sourcePosition,t.howMany):e.targetPosition._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),iF(e,t)&&iF(t,e))return[t.getReversed()];if(s.containsPosition(t.targetPosition)&&s.containsRange(o,!0))return s.start=s.start._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),s.end=s.end._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),iI([s],n);if(o.containsPosition(e.targetPosition)&&o.containsRange(s,!0))return s.start=s.start._getCombined(t.sourcePosition,t.getMovedRangeStart()),s.end=s.end._getCombined(t.sourcePosition,t.getMovedRangeStart()),iI([s],n);let h=(0,r.Rt)(e.sourcePosition.getParentPath(),t.sourcePosition.getParentPath());if("prefix"==h||"extension"==h)return s.start=s.start._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),s.end=s.end._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),iI([s],n);"remove"!=e.type||"remove"==t.type||i.aWasUndone||i.forceWeakRemove?"remove"==e.type||"remove"!=t.type||i.bWasUndone||i.forceWeakRemove||(a=!1):a=!0;let u=[];for(let e of s.getDifference(o)){e.start=e.start._getTransformedByDeletion(t.sourcePosition,t.howMany),e.end=e.end._getTransformedByDeletion(t.sourcePosition,t.howMany);let i="same"==(0,r.Rt)(e.start.getParentPath(),t.getMovedRangeStart().getParentPath()),n=e._getTransformedByInsertion(t.getMovedRangeStart(),t.howMany,i);u.push(...n)}let d=s.getIntersection(o);return(null!==d&&a&&(d.start=d.start._getCombined(t.sourcePosition,t.getMovedRangeStart()),d.end=d.end._getCombined(t.sourcePosition,t.getMovedRangeStart()),0===u.length?u.push(d):1==u.length?o.start.isBefore(s.start)||o.start.isEqual(s.start)?u.unshift(d):u.push(d):u.splice(1,0,d)),0===u.length)?[new ib(e.baseVersion)]:iI(u,n)}),iS(ic,ig,(e,t,i)=>{let r=e.targetPosition.clone();e.targetPosition.isEqual(t.insertionPosition)&&t.graveyardPosition&&"moveTargetAfter"!=i.abRelation||(r=e.targetPosition._getTransformedBySplitOperation(t));let n=to._createFromPositionAndShift(e.sourcePosition,e.howMany);if(n.end.isEqual(t.insertionPosition))return!t.graveyardPosition&&e.howMany++,e.targetPosition=r,[e];if(n.start.hasSameParentAs(t.splitPosition)&&n.containsPosition(t.splitPosition)){let e=new to(t.splitPosition,n.end);return e=e._getTransformedBySplitOperation(t),iI([new to(n.start,t.splitPosition),e],r)}e.targetPosition.isEqual(t.splitPosition)&&"insertAtSource"==i.abRelation&&(r=t.moveTargetPosition),e.targetPosition.isEqual(t.insertionPosition)&&"insertBetween"==i.abRelation&&(r=e.targetPosition);let s=[n._getTransformedBySplitOperation(t)];if(t.graveyardPosition){let r=n.start.isEqual(t.graveyardPosition)||n.containsPosition(t.graveyardPosition);e.howMany>1&&r&&!i.aWasUndone&&s.push(to._createFromPositionAndShift(t.insertionPosition,1))}return iI(s,r)}),iS(ic,ip,(e,t,i)=>{let r=to._createFromPositionAndShift(e.sourcePosition,e.howMany);if(t.deletionPosition.hasSameParentAs(e.sourcePosition)&&r.containsPosition(t.sourcePosition)){if("remove"!=e.type||i.forceWeakRemove){if(1==e.howMany)return i.bWasUndone?(e.sourcePosition=t.graveyardPosition.clone(),e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),[e]):[new ib(0)]}else if(!i.aWasUndone){let i=[],r=t.graveyardPosition.clone(),n=t.targetPosition._getTransformedByMergeOperation(t),s=e.targetPosition.getTransformedByOperation(t);e.howMany>1&&(i.push(new ic(e.sourcePosition,e.howMany-1,s,0)),r=r._getTransformedByMove(e.sourcePosition,s,e.howMany-1),n=n._getTransformedByMove(e.sourcePosition,s,e.howMany-1));let o=t.deletionPosition._getCombined(e.sourcePosition,s),a=new ic(r,1,o,0),l=a.getMovedRangeStart().path.slice();l.push(0);let h=new te(a.targetPosition.root,l),u=new ic(n=n._getTransformedByMove(r,o,1),t.howMany,h,0);return i.push(a),i.push(u),i}}let n=to._createFromPositionAndShift(e.sourcePosition,e.howMany)._getTransformedByMergeOperation(t);return e.sourcePosition=n.start,e.howMany=n.end.offset-n.start.offset,e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),[e]}),iS(iy,im,(e,t)=>(e.position=e.position._getTransformedByInsertOperation(t),[e])),iS(iy,ip,(e,t)=>(e.position.isEqual(t.deletionPosition)?(e.position=t.graveyardPosition.clone(),e.position.stickiness="toNext"):e.position=e.position._getTransformedByMergeOperation(t),[e])),iS(iy,ic,(e,t)=>(e.position=e.position._getTransformedByMoveOperation(t),[e])),iS(iy,iy,(e,t,i)=>{if(e.position.isEqual(t.position)){if(!i.aIsStrong)return[new ib(0)];e.oldName=t.newName}return[e]}),iS(iy,ig,(e,t)=>{let i=e.position.path,n=t.splitPosition.getParentPath();if("same"==(0,r.Rt)(i,n)&&!t.graveyardPosition){let t=new iy(e.position.getShiftedBy(1),e.oldName,e.newName,0);return[e,t]}return e.position=e.position._getTransformedBySplitOperation(t),[e]}),iS(iv,iv,(e,t,i)=>{if(e.root===t.root&&e.key===t.key){if(!i.aIsStrong||e.newValue===t.newValue)return[new ib(0)];e.oldValue=t.newValue}return[e]}),iS(iP,iP,(e,t)=>e.rootName===t.rootName&&e.isAdd===t.isAdd?[new ib(0)]:[e]),iS(ig,im,(e,t)=>(e.splitPosition.hasSameParentAs(t.position)&&e.splitPosition.offset<t.position.offset&&(e.howMany+=t.howMany),e.splitPosition=e.splitPosition._getTransformedByInsertOperation(t),e.insertionPosition=e.insertionPosition._getTransformedByInsertOperation(t),[e])),iS(ig,ip,(e,t,i)=>{if(!e.graveyardPosition&&!i.bWasUndone&&e.splitPosition.hasSameParentAs(t.sourcePosition)){let i=t.graveyardPosition.path.slice();i.push(0);let r=new te(t.graveyardPosition.root,i),n=ig.getInsertionPosition(new te(t.graveyardPosition.root,i)),s=new ig(r,0,n,null,0);return e.splitPosition=e.splitPosition._getTransformedByMergeOperation(t),e.insertionPosition=ig.getInsertionPosition(e.splitPosition),e.graveyardPosition=s.insertionPosition.clone(),e.graveyardPosition.stickiness="toNext",[s,e]}return e.splitPosition.hasSameParentAs(t.deletionPosition)&&!e.splitPosition.isAfter(t.deletionPosition)&&e.howMany--,e.splitPosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.splitPosition=e.splitPosition._getTransformedByMergeOperation(t),e.insertionPosition=ig.getInsertionPosition(e.splitPosition),e.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedByMergeOperation(t)),[e]}),iS(ig,ic,(e,t,i)=>{let r=to._createFromPositionAndShift(t.sourcePosition,t.howMany);if(e.graveyardPosition){let n=r.start.isEqual(e.graveyardPosition)||r.containsPosition(e.graveyardPosition);if(!i.bWasUndone&&n){let i=e.splitPosition._getTransformedByMoveOperation(t),r=e.graveyardPosition._getTransformedByMoveOperation(t),n=r.path.slice();n.push(0);let s=new te(r.root,n);return[new ic(i,e.howMany,s,0)]}e.graveyardPosition=e.graveyardPosition._getTransformedByMoveOperation(t)}let n=e.splitPosition.isEqual(t.targetPosition);if(n&&("insertAtSource"==i.baRelation||"splitBefore"==i.abRelation))return e.howMany+=t.howMany,e.splitPosition=e.splitPosition._getTransformedByDeletion(t.sourcePosition,t.howMany),e.insertionPosition=ig.getInsertionPosition(e.splitPosition),[e];if(n&&i.abRelation&&i.abRelation.howMany){let{howMany:t,offset:r}=i.abRelation;return e.howMany+=t,e.splitPosition=e.splitPosition.getShiftedBy(r),[e]}if(e.splitPosition.hasSameParentAs(t.sourcePosition)&&r.containsPosition(e.splitPosition)){let i=t.howMany-(e.splitPosition.offset-t.sourcePosition.offset);return e.howMany-=i,e.splitPosition.hasSameParentAs(t.targetPosition)&&e.splitPosition.offset<t.targetPosition.offset&&(e.howMany+=t.howMany),e.splitPosition=t.sourcePosition.clone(),e.insertionPosition=ig.getInsertionPosition(e.splitPosition),[e]}return!t.sourcePosition.isEqual(t.targetPosition)&&(e.splitPosition.hasSameParentAs(t.sourcePosition)&&e.splitPosition.offset<=t.sourcePosition.offset&&(e.howMany-=t.howMany),e.splitPosition.hasSameParentAs(t.targetPosition)&&e.splitPosition.offset<t.targetPosition.offset&&(e.howMany+=t.howMany)),e.splitPosition.stickiness="toNone",e.splitPosition=e.splitPosition._getTransformedByMoveOperation(t),e.splitPosition.stickiness="toNext",e.graveyardPosition?e.insertionPosition=e.insertionPosition._getTransformedByMoveOperation(t):e.insertionPosition=ig.getInsertionPosition(e.splitPosition),[e]}),iS(ig,ig,(e,t,i)=>{if(e.splitPosition.isEqual(t.splitPosition)){if(!e.graveyardPosition&&!t.graveyardPosition||e.graveyardPosition&&t.graveyardPosition&&e.graveyardPosition.isEqual(t.graveyardPosition))return[new ib(0)];if("splitBefore"==i.abRelation)return e.howMany=0,e.graveyardPosition=e.graveyardPosition._getTransformedBySplitOperation(t),[e]}if(e.graveyardPosition&&t.graveyardPosition&&e.graveyardPosition.isEqual(t.graveyardPosition)){let r="$graveyard"==e.splitPosition.root.rootName,n="$graveyard"==t.splitPosition.root.rootName;if(!(n&&!r||!(r&&!n)&&i.aIsStrong))return[new ib(0)];{let i=[];return t.howMany&&i.push(new ic(t.moveTargetPosition,t.howMany,t.splitPosition,0)),e.howMany&&i.push(new ic(e.splitPosition,e.howMany,e.moveTargetPosition,0)),i}}if(e.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedBySplitOperation(t)),e.splitPosition.isEqual(t.insertionPosition)&&"splitBefore"==i.abRelation)return e.howMany++,[e];if(t.splitPosition.isEqual(e.insertionPosition)&&"splitBefore"==i.baRelation){let i=t.insertionPosition.path.slice();i.push(0);let r=new te(t.insertionPosition.root,i),n=new ic(e.insertionPosition,1,r,0);return[e,n]}return e.splitPosition.hasSameParentAs(t.splitPosition)&&e.splitPosition.offset<t.splitPosition.offset&&(e.howMany-=t.howMany),e.splitPosition=e.splitPosition._getTransformedBySplitOperation(t),e.insertionPosition=ig.getInsertionPosition(e.splitPosition),[e]});class iD extends(0,r.ln)(te){constructor(e,t,i="toNone"){if(super(e,t,i),!this.root.is("rootElement"))throw new r.Bb("model-liveposition-root-not-rootelement",e);iV.call(this)}detach(){this.stopListening()}toPosition(){return new te(this.root,this.path.slice(),this.stickiness)}static fromPosition(e,t){return new this(e.root,e.path.slice(),t||e.stickiness)}}function iV(){this.listenTo(this.root.document.model,"applyOperation",(e,t)=>{let i=t[0];i.isDocumentOperation&&i$.call(this,i)},{priority:"low"})}function i$(e){let t=this.getTransformedByOperation(e);if(!this.isEqual(t)){let e=this.toPosition();this.path=t.path,this.root=t.root,this.fire("change",e)}}iD.prototype.is=function(e){return"livePosition"===e||"model:livePosition"===e||"position"==e||"model:position"===e};class iq{operations;isUndoable;isLocal;isUndo;isTyping;constructor(e={}){"string"==typeof e&&(e="transparent"===e?{isUndoable:!1}:{},(0,r.KE)("batch-constructor-deprecated-string-type"));let{isUndoable:t=!0,isLocal:i=!0,isUndo:n=!1,isTyping:s=!1}=e;this.operations=[],this.isUndoable=t,this.isLocal=i,this.isUndo=n,this.isTyping=s}get type(){return(0,r.KE)("batch-type-deprecated"),"default"}get baseVersion(){for(let e of this.operations)if(null!==e.baseVersion)return e.baseVersion;return null}addOperation(e){return e.batch=this,this.operations.push(e),e}}class iL{static _statesPriority=[void 0,"refresh","rename","move"];_markerCollection;_changesInElement=new Map;_elementsSnapshots=new Map;_elementChildrenSnapshots=new Map;_elementState=new Map;_changedMarkers=new Map;_changedRoots=new Map;_changeCount=0;_cachedChanges=null;_cachedChangesWithGraveyard=null;_refreshedItems=new Set;constructor(e){this._markerCollection=e}get isEmpty(){return 0==this._changesInElement.size&&0==this._changedMarkers.size&&0==this._changedRoots.size}bufferOperation(e){switch(e.type){case"insert":if(this._isInInsertedElement(e.position.parent))return;this._markInsert(e.position.parent,e.position.offset,e.nodes.maxOffset);break;case"addAttribute":case"removeAttribute":case"changeAttribute":for(let t of e.range.getItems({shallow:!0}))this._isInInsertedElement(t.parent)||this._markAttribute(t);break;case"remove":case"move":case"reinsert":{if(e.sourcePosition.isEqual(e.targetPosition)||e.sourcePosition.getShiftedBy(e.howMany).isEqual(e.targetPosition))return;let t=this._isInInsertedElement(e.sourcePosition.parent),i=this._isInInsertedElement(e.targetPosition.parent);for(let r of(t||this._markRemove(e.sourcePosition.parent,e.sourcePosition.offset,e.howMany),i||this._markInsert(e.targetPosition.parent,e.getMovedRangeStart().offset,e.howMany),to._createFromPositionAndShift(e.sourcePosition,e.howMany).getItems({shallow:!0})))this._setElementState(r,"move");break}case"rename":{if(this._isInInsertedElement(e.position.parent))return;this._markRemove(e.position.parent,e.position.offset,1),this._markInsert(e.position.parent,e.position.offset,1);let t=to._createFromPositionAndShift(e.position,1);for(let e of this._markerCollection.getMarkersIntersectingRange(t)){let t=e.getData();this.bufferMarkerChange(e.name,t,t)}this._setElementState(e.position.nodeAfter,"rename");break}case"split":{let t=e.splitPosition.parent;if(!this._isInInsertedElement(t))for(let i of(this._markRemove(t,e.splitPosition.offset,e.howMany),to._createFromPositionAndShift(e.splitPosition,e.howMany).getItems({shallow:!0})))this._setElementState(i,"move");this._isInInsertedElement(e.insertionPosition.parent)||this._markInsert(e.insertionPosition.parent,e.insertionPosition.offset,1),e.graveyardPosition&&(this._markRemove(e.graveyardPosition.parent,e.graveyardPosition.offset,1),this._setElementState(e.graveyardPosition.nodeAfter,"move"));break}case"merge":{let t=e.sourcePosition.parent;this._isInInsertedElement(t.parent)||this._markRemove(t.parent,t.startOffset,1);let i=e.graveyardPosition.parent;this._markInsert(i,e.graveyardPosition.offset,1),this._setElementState(t,"move");let r=e.targetPosition.parent;if(!this._isInInsertedElement(r))for(let i of(this._markInsert(r,e.targetPosition.offset,t.maxOffset),to._createFromPositionAndShift(e.sourcePosition,e.howMany).getItems({shallow:!0})))this._setElementState(i,"move");break}case"detachRoot":case"addRoot":{let t=e.affectedSelectable;if(!t._isLoaded||t.isAttached()==e.isAdd)return;this._bufferRootStateChange(e.rootName,e.isAdd);break}case"addRootAttribute":case"removeRootAttribute":case"changeRootAttribute":{if(!e.root._isLoaded)return;let t=e.root.rootName;this._bufferRootAttributeChange(t,e.key,e.oldValue,e.newValue)}}this._cachedChanges=null}bufferMarkerChange(e,t,i){t.range&&t.range.root.is("rootElement")&&!t.range.root._isLoaded&&(t.range=null),i.range&&i.range.root.is("rootElement")&&!i.range.root._isLoaded&&(i.range=null);let r=this._changedMarkers.get(e);r?r.newMarkerData=i:(r={newMarkerData:i,oldMarkerData:t},this._changedMarkers.set(e,r)),null==r.oldMarkerData.range&&null==i.range&&this._changedMarkers.delete(e)}getMarkersToRemove(){let e=[];for(let[t,i]of this._changedMarkers)null!=i.oldMarkerData.range&&e.push({name:t,range:i.oldMarkerData.range});return e}getMarkersToAdd(){let e=[];for(let[t,i]of this._changedMarkers)null!=i.newMarkerData.range&&e.push({name:t,range:i.newMarkerData.range});return e}getChangedMarkers(){return Array.from(this._changedMarkers).map(([e,t])=>({name:e,data:{oldRange:t.oldMarkerData.range,newRange:t.newMarkerData.range}}))}hasDataChanges(){if(this.getChanges().length||this._changedRoots.size>0)return!0;for(let{newMarkerData:e,oldMarkerData:t}of this._changedMarkers.values()){if(e.affectsData!==t.affectsData)return!0;if(e.affectsData){let i=e.range&&!t.range,r=!e.range&&t.range,n=e.range&&t.range&&!e.range.isEqual(t.range);if(i||r||n)return!0}}return!1}getChanges(e={}){if(this._cachedChanges)return e.includeChangesInGraveyard?this._cachedChangesWithGraveyard.slice():this._cachedChanges.slice();let t=[];for(let e of this._changesInElement.keys()){let i=this._changesInElement.get(e).sort((e,t)=>e.offset===t.offset?e.type!=t.type?"remove"==e.type?-1:1:0:e.offset<t.offset?-1:1),r=this._elementChildrenSnapshots.get(e),n=ij(e.getChildren()),s=function(e,t){let i=[],r=0,n=0;for(let e of t){if(e.offset>r){for(let t=0;t<e.offset-r;t++)i.push("e");n+=e.offset-r}if("insert"==e.type){for(let t=0;t<e.howMany;t++)i.push("i");r=e.offset+e.howMany}else if("remove"==e.type){for(let t=0;t<e.howMany;t++)i.push("r");r=e.offset,n+=e.howMany}else{if(e.howMany>1500)for(let t=0;t<e.howMany;t++)i.push("a");else i.push(..."a".repeat(e.howMany).split(""));r=e.offset+e.howMany,n+=e.howMany}}if(n<e)for(let t=0;t<e-n-r;t++)i.push("e");return i}(r.length,i),o=0,a=0;for(let i of s)if("i"===i){let i=this._getDiffActionForNode(n[o].node,"insert"),r=this._elementsSnapshots.get(n[o].node),s=this._getInsertDiff(e,o,i,n[o],r);t.push(s),o++}else if("r"===i){let i=this._getDiffActionForNode(r[a].node,"remove"),n=this._getRemoveDiff(e,o,i,r[a]);t.push(n),a++}else if("a"===i){let i;let s=r[a].attributes,l=n[o].attributes;if("$text"==n[o].name)i=new to(te._createAt(e,o),te._createAt(e,o+1));else{let t=e.offsetToIndex(o);i=new to(te._createAt(e,o),te._createAt(e.getChild(t),0))}let h=this._getAttributesDiff(i,s,l);t.push(...h),o++,a++}else o++,a++}t.sort((e,t)=>e.position.root!=t.position.root?e.position.root.rootName<t.position.root.rootName?-1:1:e.position.isEqual(t.position)?e.changeCount-t.changeCount:e.position.isBefore(t.position)?-1:1);for(let e=1,i=0;e<t.length;e++){let r=t[i],n=t[e],s="remove"==r.type&&"remove"==n.type&&"$text"==r.name&&"$text"==n.name&&r.position.isEqual(n.position),o="insert"==r.type&&"insert"==n.type&&"$text"==r.name&&"$text"==n.name&&r.position.parent==n.position.parent&&r.position.offset+r.length==n.position.offset,a="attribute"==r.type&&"attribute"==n.type&&r.position.parent==n.position.parent&&r.range.isFlat&&n.range.isFlat&&r.position.offset+r.length==n.position.offset&&r.attributeKey==n.attributeKey&&r.attributeOldValue==n.attributeOldValue&&r.attributeNewValue==n.attributeNewValue;s||o||a?(r.length++,a&&(r.range.end=r.range.end.getShiftedBy(1)),t[e]=null):i=e}for(let e of t=t.filter(e=>e))delete e.changeCount,"attribute"==e.type&&(delete e.position,delete e.length);return(this._changeCount=0,this._cachedChangesWithGraveyard=t,this._cachedChanges=t.filter(iU),e.includeChangesInGraveyard)?this._cachedChangesWithGraveyard.slice():this._cachedChanges.slice()}getChangedRoots(){return Array.from(this._changedRoots.values()).map(e=>{let t={...e};return void 0!==t.state&&delete t.attributes,t})}getRefreshedItems(){return new Set(this._refreshedItems)}reset(){this._changesInElement.clear(),this._elementChildrenSnapshots.clear(),this._elementsSnapshots.clear(),this._elementState.clear(),this._changedMarkers.clear(),this._changedRoots.clear(),this._refreshedItems.clear(),this._cachedChanges=null}_refreshItem(e){if(this._isInInsertedElement(e.parent))return;this._markRemove(e.parent,e.startOffset,e.offsetSize),this._markInsert(e.parent,e.startOffset,e.offsetSize),this._refreshedItems.add(e),this._setElementState(e,"refresh");let t=to._createOn(e);for(let e of this._markerCollection.getMarkersIntersectingRange(t)){let t=e.getData();this.bufferMarkerChange(e.name,t,t)}this._cachedChanges=null}_bufferRootLoad(e){if(e.isAttached()){for(let t of(this._bufferRootStateChange(e.rootName,!0),this._markInsert(e,0,e.maxOffset),e.getAttributeKeys()))this._bufferRootAttributeChange(e.rootName,t,null,e.getAttribute(t));for(let t of this._markerCollection)if(t.getRange().root==e){let e=t.getData();this.bufferMarkerChange(t.name,{...e,range:null},e)}}}_bufferRootStateChange(e,t){if(!this._changedRoots.has(e)){this._changedRoots.set(e,{name:e,state:t?"attached":"detached"});return}let i=this._changedRoots.get(e);void 0!==i.state?(delete i.state,void 0===i.attributes&&this._changedRoots.delete(e)):i.state=t?"attached":"detached"}_bufferRootAttributeChange(e,t,i,r){let n=this._changedRoots.get(e)||{name:e},s=n.attributes||{};if(s[t]){let e=s[t];r===e.oldValue?delete s[t]:e.newValue=r}else s[t]={oldValue:i,newValue:r};0===Object.entries(s).length?(delete n.attributes,void 0===n.state&&this._changedRoots.delete(e)):(n.attributes=s,this._changedRoots.set(e,n))}_markInsert(e,t,i){if(e.root.is("rootElement")&&!e.root._isLoaded)return;let r={type:"insert",offset:t,howMany:i,count:this._changeCount++};this._markChange(e,r)}_markRemove(e,t,i){if(e.root.is("rootElement")&&!e.root._isLoaded)return;let r={type:"remove",offset:t,howMany:i,count:this._changeCount++};this._markChange(e,r),this._removeAllNestedChanges(e,t,i)}_markAttribute(e){if(e.root.is("rootElement")&&!e.root._isLoaded)return;let t={type:"attribute",offset:e.startOffset,howMany:e.offsetSize,count:this._changeCount++};this._markChange(e.parent,t)}_markChange(e,t){this._makeSnapshots(e);let i=this._getChangesForElement(e);this._handleChange(t,i),i.push(t);for(let e=0;e<i.length;e++)i[e].howMany<1&&(i.splice(e,1),e--)}_setElementState(e,t){if(!e.is("element"))return;let i=iL._statesPriority.indexOf(this._elementState.get(e));iL._statesPriority.indexOf(t)>i&&this._elementState.set(e,t)}_getDiffActionForNode(e,t){if(!e.is("element")||!this._elementsSnapshots.has(e))return t;let i=this._elementState.get(e);return i&&"move"!=i?i:t}_getChangesForElement(e){let t;return this._changesInElement.has(e)?t=this._changesInElement.get(e):(t=[],this._changesInElement.set(e,t)),t}_makeSnapshots(e){if(this._elementChildrenSnapshots.has(e))return;let t=ij(e.getChildren());for(let i of(this._elementChildrenSnapshots.set(e,t),t))this._elementsSnapshots.set(i.node,i)}_handleChange(e,t){for(let i of(e.nodesToHandle=e.howMany,t)){let r=e.offset+e.howMany,n=i.offset+i.howMany;if("insert"==e.type&&("insert"==i.type&&(e.offset<=i.offset?i.offset+=e.howMany:e.offset<n&&(i.howMany+=e.nodesToHandle,e.nodesToHandle=0)),"remove"==i.type&&e.offset<i.offset&&(i.offset+=e.howMany),"attribute"==i.type)){if(e.offset<=i.offset)i.offset+=e.howMany;else if(e.offset<n){let n=i.howMany;i.howMany=e.offset-i.offset,t.unshift({type:"attribute",offset:r,howMany:n-i.howMany,count:this._changeCount++})}}if("remove"==e.type){if("insert"==i.type){if(r<=i.offset)i.offset-=e.howMany;else if(r<=n){if(e.offset<i.offset){let t=r-i.offset;i.offset=e.offset,i.howMany-=t,e.nodesToHandle-=t}else i.howMany-=e.nodesToHandle,e.nodesToHandle=0}else if(e.offset<=i.offset)e.nodesToHandle-=i.howMany,i.howMany=0;else if(e.offset<n){let t=n-e.offset;i.howMany-=t,e.nodesToHandle-=t}}if("remove"==i.type&&(r<=i.offset?i.offset-=e.howMany:e.offset<i.offset&&(e.nodesToHandle+=i.howMany,i.howMany=0)),"attribute"==i.type){if(r<=i.offset)i.offset-=e.howMany;else if(e.offset<i.offset){let t=r-i.offset;i.offset=e.offset,i.howMany-=t}else if(e.offset<n){if(r<=n){let r=i.howMany;i.howMany=e.offset-i.offset;let n=r-i.howMany-e.nodesToHandle;t.unshift({type:"attribute",offset:e.offset,howMany:n,count:this._changeCount++})}else i.howMany-=n-e.offset}}}if("attribute"==e.type){if("insert"==i.type){if(e.offset<i.offset&&r>i.offset){if(r>n){let e={type:"attribute",offset:n,howMany:r-n,count:this._changeCount++};this._handleChange(e,t),t.push(e)}e.nodesToHandle=i.offset-e.offset,e.howMany=e.nodesToHandle}else e.offset>=i.offset&&e.offset<n&&(r>n?(e.nodesToHandle=r-n,e.offset=n):e.nodesToHandle=0)}if("remove"==i.type&&e.offset<i.offset&&r>i.offset){let n={type:"attribute",offset:i.offset,howMany:r-i.offset,count:this._changeCount++};this._handleChange(n,t),t.push(n),e.nodesToHandle=i.offset-e.offset,e.howMany=e.nodesToHandle}"attribute"==i.type&&(e.offset>=i.offset&&r<=n?(e.nodesToHandle=0,e.howMany=0,e.offset=0):e.offset<=i.offset&&r>=n&&(i.howMany=0))}}e.howMany=e.nodesToHandle,delete e.nodesToHandle}_getInsertDiff(e,t,i,r,n){let s={type:"insert",position:te._createAt(e,t),name:r.name,attributes:new Map(r.attributes),length:1,changeCount:this._changeCount++,action:i};return"insert"!=i&&n&&(s.before={name:n.name,attributes:new Map(n.attributes)}),s}_getRemoveDiff(e,t,i,r){return{type:"remove",action:i,position:te._createAt(e,t),name:r.name,attributes:new Map(r.attributes),length:1,changeCount:this._changeCount++}}_getAttributesDiff(e,t,i){let r=[];for(let[n,s]of(i=new Map(i),t)){let t=i.has(n)?i.get(n):null;t!==s&&r.push({type:"attribute",position:e.start,range:e.clone(),length:1,attributeKey:n,attributeOldValue:s,attributeNewValue:t,changeCount:this._changeCount++}),i.delete(n)}for(let[t,n]of i)r.push({type:"attribute",position:e.start,range:e.clone(),length:1,attributeKey:t,attributeOldValue:null,attributeNewValue:n,changeCount:this._changeCount++});return r}_isInInsertedElement(e){let t=e.parent;if(!t)return!1;let i=this._changesInElement.get(t),r=e.startOffset;if(i){for(let e of i)if("insert"==e.type&&r>=e.offset&&r<e.offset+e.howMany)return!0}return this._isInInsertedElement(t)}_removeAllNestedChanges(e,t,i){for(let r of new to(te._createAt(e,t),te._createAt(e,t+i)).getItems({shallow:!0}))r.is("element")&&(this._changesInElement.delete(r),this._removeAllNestedChanges(r,0,r.maxOffset))}}function iW(e){return{node:e,name:e.is("$text")?"$text":e.name,attributes:new Map(e.getAttributes())}}function ij(e){let t=[];for(let i of e)if(i.is("$text"))for(let e=0;e<i.data.length;++e)t.push(iW(i));else t.push(iW(i));return t}function iU(e){let t="position"in e&&"$graveyard"==e.position.root.rootName,i="range"in e&&"$graveyard"==e.range.root.rootName;return!t&&!i}class iJ{_operations=[];_undoPairs=new Map;_undoneOperations=new Set;_baseVersionToOperationIndex=new Map;_version=0;_gaps=new Map;get version(){return this._version}set version(e){this._operations.length&&e>this._version+1&&this._gaps.set(this._version,e),this._version=e}get lastOperation(){return this._operations[this._operations.length-1]}addOperation(e){if(e.baseVersion!==this.version)throw new r.Bb("model-document-history-addoperation-incorrect-version",this,{operation:e,historyVersion:this.version});this._operations.push(e),this._version++,this._baseVersionToOperationIndex.set(e.baseVersion,this._operations.length-1)}getOperations(e,t=this.version){if(!this._operations.length)return[];let i=this._operations[0];void 0===e&&(e=i.baseVersion);let r=t-1;for(let[t,i]of this._gaps)e>t&&e<i&&(e=i),r>t&&r<i&&(r=t-1);if(r<i.baseVersion||e>this.lastOperation.baseVersion)return[];let n=this._baseVersionToOperationIndex.get(e);void 0===n&&(n=0);let s=this._baseVersionToOperationIndex.get(r);return void 0===s&&(s=this._operations.length-1),this._operations.slice(n,s+1)}getOperation(e){let t=this._baseVersionToOperationIndex.get(e);if(void 0!==t)return this._operations[t]}setOperationAsUndone(e,t){this._undoPairs.set(t,e),this._undoneOperations.add(e)}isUndoingOperation(e){return this._undoPairs.has(e)}isUndoneOperation(e){return this._undoneOperations.has(e)}getUndoneOperation(e){return this._undoPairs.get(e)}reset(){this._version=0,this._undoPairs=new Map,this._operations=[],this._undoneOperations=new Set,this._gaps=new Map,this._baseVersionToOperationIndex=new Map}}class iK extends e4{rootName;_document;_isAttached=!0;_isLoaded=!0;constructor(e,t,i="main"){super(t),this._document=e,this.rootName=i}get document(){return this._document}isAttached(){return this._isAttached}toJSON(){return this.rootName}}iK.prototype.is=function(e,t){return t?t===this.name&&("rootElement"===e||"model:rootElement"===e||"element"===e||"model:element"===e):"rootElement"===e||"model:rootElement"===e||"element"===e||"model:element"===e||"node"===e||"model:node"===e};let iG="$graveyard";class iz extends(0,r.ln)(){model;history;selection;roots;differ;isReadOnly;_postFixers;_hasSelectionChangedFromTheLastChangeBlock;constructor(e){super(),this.model=e,this.history=new iJ,this.selection=new ty(this),this.roots=new r.FE({idProperty:"rootName"}),this.differ=new iL(e.markers),this.isReadOnly=!1,this._postFixers=new Set,this._hasSelectionChangedFromTheLastChangeBlock=!1,this.createRoot("$root",iG),this.listenTo(e,"applyOperation",(e,t)=>{let i=t[0];i.isDocumentOperation&&this.differ.bufferOperation(i)},{priority:"high"}),this.listenTo(e,"applyOperation",(e,t)=>{let i=t[0];i.isDocumentOperation&&this.history.addOperation(i)},{priority:"low"}),this.listenTo(this.selection,"change",()=>{this._hasSelectionChangedFromTheLastChangeBlock=!0}),this.listenTo(e.markers,"update",(e,t,i,r,n)=>{let s={...t.getData(),range:r};this.differ.bufferMarkerChange(t.name,n,s),null===i&&t.on("change",(e,i)=>{let r=t.getData();this.differ.bufferMarkerChange(t.name,{...r,range:i},r)})}),this.registerPostFixer(e=>{let t=!1;for(let i of this.roots)i.isAttached()||i.isEmpty||(e.remove(e.createRangeIn(i)),t=!0);for(let i of this.model.markers)i.getRange().root.isAttached()||(e.removeMarker(i),t=!0);return t})}get version(){return this.history.version}set version(e){this.history.version=e}get graveyard(){return this.getRoot(iG)}createRoot(e="$root",t="main"){if(this.roots.get(t))throw new r.Bb("model-document-createroot-name-exists",this,{name:t});let i=new iK(this,e,t);return this.roots.add(i),i}destroy(){this.selection.destroy(),this.stopListening()}getRoot(e="main"){return this.roots.get(e)}getRootNames(e=!1){return this.getRoots(e).map(e=>e.rootName)}getRoots(e=!1){return this.roots.filter(t=>t!=this.graveyard&&(e||t.isAttached())&&t._isLoaded)}registerPostFixer(e){this._postFixers.add(e)}toJSON(){let e=(0,n.Z)(this);return e.selection="[engine.model.DocumentSelection]",e.model="[engine.model.Model]",e}_handleChangeBlock(e){this._hasDocumentChangedFromTheLastChangeBlock()&&(this._callPostFixers(e),this.selection.refresh(),this.differ.hasDataChanges()?this.fire("change:data",e.batch):this.fire("change",e.batch),this.selection.refresh(),this.differ.reset()),this._hasSelectionChangedFromTheLastChangeBlock=!1}_hasDocumentChangedFromTheLastChangeBlock(){return!this.differ.isEmpty||this._hasSelectionChangedFromTheLastChangeBlock}_getDefaultRoot(){let e=this.getRoots();return e.length?e[0]:this.graveyard}_getDefaultRange(){let e=this._getDefaultRoot(),t=this.model,i=t.schema,r=t.createPositionFromPath(e,[0]);return i.getNearestSelectionRange(r)||t.createRange(r)}_validateSelectionRange(e){return e.start.isValid()&&e.end.isValid()&&iH(e.start)&&iH(e.end)}_callPostFixers(e){let t=!1;do for(let i of this._postFixers)if(this.selection.refresh(),t=i(e))break;while(t)}}function iH(e){let t=e.textNode;if(t){let i=t.data,n=e.offset-t.startOffset;return!(0,r.to)(i,n)&&!(0,r.pp)(i,n)}return!0}class iZ extends(0,r.ln)(){_markers=new Map;[Symbol.iterator](){return this._markers.values()}has(e){let t=e instanceof iY?e.name:e;return this._markers.has(t)}get(e){return this._markers.get(e)||null}_set(e,t,i=!1,n=!1){let s=e instanceof iY?e.name:e;if(s.includes(","))throw new r.Bb("markercollection-incorrect-marker-name",this);let o=this._markers.get(s);if(o){let e=o.getData(),r=o.getRange(),a=!1;return r.isEqual(t)||(o._attachLiveRange(tp.fromRange(t)),a=!0),i!=o.managedUsingOperations&&(o._managedUsingOperations=i,a=!0),"boolean"==typeof n&&n!=o.affectsData&&(o._affectsData=n,a=!0),a&&this.fire(`update:${s}`,o,r,t,e),o}let a=new iY(s,tp.fromRange(t),i,n);return this._markers.set(s,a),this.fire(`update:${s}`,a,null,t,{...a.getData(),range:null}),a}_remove(e){let t=e instanceof iY?e.name:e,i=this._markers.get(t);return!!i&&(this._markers.delete(t),this.fire(`update:${t}`,i,i.getRange(),null,i.getData()),this._destroyMarker(i),!0)}_refresh(e){let t=e instanceof iY?e.name:e,i=this._markers.get(t);if(!i)throw new r.Bb("markercollection-refresh-marker-not-exists",this);let n=i.getRange();this.fire(`update:${t}`,i,n,n,i.getData())}*getMarkersAtPosition(e){for(let t of this)t.getRange().containsPosition(e)&&(yield t)}*getMarkersIntersectingRange(e){for(let t of this)null!==t.getRange().getIntersection(e)&&(yield t)}destroy(){for(let e of this._markers.values())this._destroyMarker(e);this._markers=null,this.stopListening()}*getMarkersGroup(e){for(let t of this._markers.values())t.name.startsWith(e+":")&&(yield t)}_destroyMarker(e){e.stopListening(),e._detachLiveRange()}}class iY extends(0,r.ln)(e3){name;_managedUsingOperations;_affectsData;_liveRange;constructor(e,t,i,r){super(),this.name=e,this._liveRange=this._attachLiveRange(t),this._managedUsingOperations=i,this._affectsData=r}get managedUsingOperations(){if(!this._liveRange)throw new r.Bb("marker-destroyed",this);return this._managedUsingOperations}get affectsData(){if(!this._liveRange)throw new r.Bb("marker-destroyed",this);return this._affectsData}getData(){return{range:this.getRange(),affectsData:this.affectsData,managedUsingOperations:this.managedUsingOperations}}getStart(){if(!this._liveRange)throw new r.Bb("marker-destroyed",this);return this._liveRange.start.clone()}getEnd(){if(!this._liveRange)throw new r.Bb("marker-destroyed",this);return this._liveRange.end.clone()}getRange(){if(!this._liveRange)throw new r.Bb("marker-destroyed",this);return this._liveRange.toRange()}_attachLiveRange(e){return this._liveRange&&this._detachLiveRange(),e.delegate("change:range").to(this),e.delegate("change:content").to(this),this._liveRange=e,e}_detachLiveRange(){this._liveRange.stopDelegating("change:range",this),this._liveRange.stopDelegating("change:content",this),this._liveRange.detach(),this._liveRange=null}}iY.prototype.is=function(e){return"marker"===e||"model:marker"===e};class iQ extends ir{sourcePosition;howMany;constructor(e,t){super(null),this.sourcePosition=e.clone(),this.howMany=t}get type(){return"detach"}get affectedSelectable(){return null}toJSON(){let e=super.toJSON();return e.sourcePosition=this.sourcePosition.toJSON(),e}_validate(){if(this.sourcePosition.root.document)throw new r.Bb("detach-operation-on-document-node",this)}_execute(){io(to._createFromPositionAndShift(this.sourcePosition,this.howMany))}static get className(){return"DetachOperation"}}class iX extends e3{markers=new Map;_children=new e2;constructor(e){super(),e&&this._insertChild(0,e)}[Symbol.iterator](){return this.getChildren()}get childCount(){return this._children.length}get maxOffset(){return this._children.maxOffset}get isEmpty(){return 0===this.childCount}get nextSibling(){return null}get previousSibling(){return null}get root(){return this}get parent(){return null}get document(){return null}isAttached(){return!1}getAncestors(){return[]}getChild(e){return this._children.getNode(e)}getChildAtOffset(e){return this._children.getNodeAtOffset(e)}getChildren(){return this._children[Symbol.iterator]()}getChildIndex(e){return this._children.getNodeIndex(e)}getChildStartOffset(e){return this._children.getNodeStartOffset(e)}getPath(){return[]}getNodeByPath(e){let t=this;for(let i of e)t=t.getChildAtOffset(i);return t}offsetToIndex(e){return this._children.offsetToIndex(e)}toJSON(){let e=[];for(let t of this._children)e.push(t.toJSON());return e}static fromJSON(e){let t=[];for(let i of e)i.name?t.push(e4.fromJSON(i)):t.push(e7.fromJSON(i));return new iX(t)}_appendChild(e){this._insertChild(this.childCount,e)}_insertChild(e,t){var i;let n="string"==typeof(i=t)?[new e7(i)]:((0,r.TW)(i)||(i=[i]),Array.from(i).map(e=>"string"==typeof e?new e7(e):e instanceof e6?new e7(e.data,e.getAttributes()):e));for(let e of n)null!==e.parent&&e._remove(),e.parent=this;this._children._insertNodes(e,n)}_removeChildren(e,t=1){let i=this._children._removeNodes(e,t);for(let e of i)e.parent=null;return i}}iX.prototype.is=function(e){return"documentFragment"===e||"model:documentFragment"===e};class i0{model;batch;constructor(e,t){this.model=e,this.batch=t}createText(e,t){return new e7(e,t)}createElement(e,t){return new e4(e,t)}createDocumentFragment(){return new iX}cloneElement(e,t=!0){return e._clone(t)}insert(e,t,i=0){if(this._assertWriterUsedCorrectly(),e instanceof e7&&""==e.data)return;let n=te._createAt(t,i);if(e.parent){if(i2(e.root,n.root)){this.move(to._createOn(e),n);return}if(e.root.document)throw new r.Bb("model-writer-insert-forbidden-move",this);this.remove(e)}let s=n.root.document?n.root.document.version:null,o=new im(n,e,s);if(e instanceof e7&&(o.shouldReceiveAttributes=!0),this.batch.addOperation(o),this.model.applyOperation(o),e instanceof iX)for(let[t,i]of e.markers){let e=te._createAt(i.root,0),r={range:new to(i.start._getCombined(e,n),i.end._getCombined(e,n)),usingOperation:!0,affectsData:!0};this.model.markers.has(t)?this.updateMarker(t,r):this.addMarker(t,r)}}insertText(e,t,i,r){t instanceof iX||t instanceof e4||t instanceof te?this.insert(this.createText(e),t,i):this.insert(this.createText(e,t),i,r)}insertElement(e,t,i,r){t instanceof iX||t instanceof e4||t instanceof te?this.insert(this.createElement(e),t,i):this.insert(this.createElement(e,t),i,r)}append(e,t){this.insert(e,t,"end")}appendText(e,t,i){t instanceof iX||t instanceof e4?this.insert(this.createText(e),t,"end"):this.insert(this.createText(e,t),i,"end")}appendElement(e,t,i){t instanceof iX||t instanceof e4?this.insert(this.createElement(e),t,"end"):this.insert(this.createElement(e,t),i,"end")}setAttribute(e,t,i){if(this._assertWriterUsedCorrectly(),i instanceof to)for(let r of i.getMinimalFlatRanges())i1(this,e,t,r);else i3(this,e,t,i)}setAttributes(e,t){for(let[i,n]of(0,r.qL)(e))this.setAttribute(i,n,t)}removeAttribute(e,t){if(this._assertWriterUsedCorrectly(),t instanceof to)for(let i of t.getMinimalFlatRanges())i1(this,e,null,i);else i3(this,e,null,t)}clearAttributes(e){this._assertWriterUsedCorrectly();let t=e=>{for(let t of e.getAttributeKeys())this.removeAttribute(t,e)};if(e instanceof to)for(let i of e.getItems())t(i);else t(e)}move(e,t,i){if(this._assertWriterUsedCorrectly(),!(e instanceof to))throw new r.Bb("writer-move-invalid-range",this);if(!e.isFlat)throw new r.Bb("writer-move-range-not-flat",this);let n=te._createAt(t,i);if(n.isEqual(e.start))return;if(this._addOperationForAffectedMarkers("move",e),!i2(e.root,n.root))throw new r.Bb("writer-move-different-document",this);let s=e.root.document?e.root.document.version:null,o=new ic(e.start,e.end.offset-e.start.offset,n,s);this.batch.addOperation(o),this.model.applyOperation(o)}remove(e){for(let t of(this._assertWriterUsedCorrectly(),(e instanceof to?e:to._createOn(e)).getMinimalFlatRanges().reverse()))this._addOperationForAffectedMarkers("move",t),function(e,t,i,r){let n;if(e.root.document){let i=r.document;n=new ic(e,t,new te(i.graveyard,[0]),i.version)}else n=new iQ(e,t);i.addOperation(n),r.applyOperation(n)}(t.start,t.end.offset-t.start.offset,this.batch,this.model)}merge(e){this._assertWriterUsedCorrectly();let t=e.nodeBefore,i=e.nodeAfter;if(this._addOperationForAffectedMarkers("merge",e),!(t instanceof e4))throw new r.Bb("writer-merge-no-element-before",this);if(!(i instanceof e4))throw new r.Bb("writer-merge-no-element-after",this);e.root.document?this._merge(e):this._mergeDetached(e)}createPositionFromPath(e,t,i){return this.model.createPositionFromPath(e,t,i)}createPositionAt(e,t){return this.model.createPositionAt(e,t)}createPositionAfter(e){return this.model.createPositionAfter(e)}createPositionBefore(e){return this.model.createPositionBefore(e)}createRange(e,t){return this.model.createRange(e,t)}createRangeIn(e){return this.model.createRangeIn(e)}createRangeOn(e){return this.model.createRangeOn(e)}createSelection(...e){return this.model.createSelection(...e)}_mergeDetached(e){let t=e.nodeBefore,i=e.nodeAfter;this.move(to._createIn(i),te._createAt(t,"end")),this.remove(i)}_merge(e){let t=te._createAt(e.nodeBefore,"end"),i=te._createAt(e.nodeAfter,0),r=new te(e.root.document.graveyard,[0]),n=e.root.document.version,s=new ip(i,e.nodeAfter.maxOffset,t,r,n);this.batch.addOperation(s),this.model.applyOperation(s)}rename(e,t){if(this._assertWriterUsedCorrectly(),!(e instanceof e4))throw new r.Bb("writer-rename-not-element-instance",this);let i=e.root.document?e.root.document.version:null,n=new iy(te._createBefore(e),e.name,t,i);this.batch.addOperation(n),this.model.applyOperation(n)}split(e,t){let i,n;this._assertWriterUsedCorrectly();let s=e.parent;if(!s.parent)throw new r.Bb("writer-split-element-no-parent",this);if(t||(t=s.parent),!e.parent.getAncestors({includeSelf:!0}).includes(t))throw new r.Bb("writer-split-invalid-limit-element",this);do{let t=s.root.document?s.root.document.version:null,r=s.maxOffset-e.offset,o=ig.getInsertionPosition(e),a=new ig(e,r,o,null,t);this.batch.addOperation(a),this.model.applyOperation(a),i||n||(i=s,n=e.parent.nextSibling),s=(e=this.createPositionAfter(e.parent)).parent}while(s!==t);return{position:e,range:new to(te._createAt(i,"end"),te._createAt(n,0))}}wrap(e,t){if(this._assertWriterUsedCorrectly(),!e.isFlat)throw new r.Bb("writer-wrap-range-not-flat",this);let i=t instanceof e4?t:new e4(t);if(i.childCount>0)throw new r.Bb("writer-wrap-element-not-empty",this);if(null!==i.parent)throw new r.Bb("writer-wrap-element-attached",this);this.insert(i,e.start);let n=new to(e.start.getShiftedBy(1),e.end.getShiftedBy(1));this.move(n,te._createAt(i,0))}unwrap(e){if(this._assertWriterUsedCorrectly(),null===e.parent)throw new r.Bb("writer-unwrap-element-no-parent",this);this.move(to._createIn(e),this.createPositionAfter(e)),this.remove(e)}addMarker(e,t){if(this._assertWriterUsedCorrectly(),!t||"boolean"!=typeof t.usingOperation)throw new r.Bb("writer-addmarker-no-usingoperation",this);let i=t.usingOperation,n=t.range,s=void 0!==t.affectsData&&t.affectsData;if(this.model.markers.has(e))throw new r.Bb("writer-addmarker-marker-exists",this);if(!n)throw new r.Bb("writer-addmarker-no-range",this);return i?(i9(this,e,null,n,s),this.model.markers.get(e)):this.model.markers._set(e,n,i,s)}updateMarker(e,t){this._assertWriterUsedCorrectly();let i="string"==typeof e?e:e.name,n=this.model.markers.get(i);if(!n)throw new r.Bb("writer-updatemarker-marker-not-exists",this);if(!t){(0,r.KE)("writer-updatemarker-reconvert-using-editingcontroller",{markerName:i}),this.model.markers._refresh(n);return}let s="boolean"==typeof t.usingOperation,o="boolean"==typeof t.affectsData,a=o?t.affectsData:n.affectsData;if(!s&&!t.range&&!o)throw new r.Bb("writer-updatemarker-wrong-options",this);let l=n.getRange(),h=t.range?t.range:l;if(s&&t.usingOperation!==n.managedUsingOperations){t.usingOperation?i9(this,i,null,h,a):(i9(this,i,l,null,a),this.model.markers._set(i,h,void 0,a));return}n.managedUsingOperations?i9(this,i,l,h,a):this.model.markers._set(i,h,void 0,a)}removeMarker(e){this._assertWriterUsedCorrectly();let t="string"==typeof e?e:e.name;if(!this.model.markers.has(t))throw new r.Bb("writer-removemarker-no-marker",this);let i=this.model.markers.get(t);if(!i.managedUsingOperations){this.model.markers._remove(t);return}i9(this,t,i.getRange(),null,i.affectsData)}addRoot(e,t="$root"){this._assertWriterUsedCorrectly();let i=this.model.document.getRoot(e);if(i&&i.isAttached())throw new r.Bb("writer-addroot-root-exists",this);let n=this.model.document,s=new iP(e,t,!0,n,n.version);return this.batch.addOperation(s),this.model.applyOperation(s),this.model.document.getRoot(e)}detachRoot(e){this._assertWriterUsedCorrectly();let t="string"==typeof e?this.model.document.getRoot(e):e;if(!t||!t.isAttached())throw new r.Bb("writer-detachroot-no-root",this);for(let e of this.model.markers)e.getRange().root===t&&this.removeMarker(e);for(let e of t.getAttributeKeys())this.removeAttribute(e,t);this.remove(this.createRangeIn(t));let i=this.model.document,n=new iP(t.rootName,t.name,!1,i,i.version);this.batch.addOperation(n),this.model.applyOperation(n)}setSelection(...e){this._assertWriterUsedCorrectly(),this.model.document.selection._setTo(...e)}setSelectionFocus(e,t){this._assertWriterUsedCorrectly(),this.model.document.selection._setFocus(e,t)}setSelectionAttribute(e,t){if(this._assertWriterUsedCorrectly(),"string"==typeof e)this._setSelectionAttribute(e,t);else for(let[t,i]of(0,r.qL)(e))this._setSelectionAttribute(t,i)}removeSelectionAttribute(e){if(this._assertWriterUsedCorrectly(),"string"==typeof e)this._removeSelectionAttribute(e);else for(let t of e)this._removeSelectionAttribute(t)}overrideSelectionGravity(){return this.model.document.selection._overrideGravity()}restoreSelectionGravity(e){this.model.document.selection._restoreGravity(e)}_setSelectionAttribute(e,t){let i=this.model.document.selection;if(i.isCollapsed&&i.anchor.parent.isEmpty){let r=ty._getStoreAttributeKey(e);this.setAttribute(r,t,i.anchor.parent)}i._setAttribute(e,t)}_removeSelectionAttribute(e){let t=this.model.document.selection;if(t.isCollapsed&&t.anchor.parent.isEmpty){let i=ty._getStoreAttributeKey(e);this.removeAttribute(i,t.anchor.parent)}t._removeAttribute(e)}_assertWriterUsedCorrectly(){if(this.model._currentWriter!==this)throw new r.Bb("writer-incorrect-use",this)}_addOperationForAffectedMarkers(e,t){for(let i of this.model.markers){if(!i.managedUsingOperations)continue;let r=i.getRange(),n=!1;if("move"===e)n=t.containsPosition(r.start)||t.start.isEqual(r.start)||t.containsPosition(r.end)||t.end.isEqual(r.end);else{let e=t.nodeBefore,i=t.nodeAfter,s=r.start.parent==e&&r.start.isAtEnd,o=r.end.parent==i&&0==r.end.offset,a=r.end.nodeAfter==i,l=r.start.nodeAfter==i;n=s||o||a||l}n&&this.updateMarker(i.name,{range:r})}}}function i1(e,t,i,r){let n,s,o;let a=e.model,l=a.document,h=r.start;for(let e of r.getWalker({shallow:!0}))o=e.item.getAttribute(t),n&&s!=o&&(s!=i&&u(),h=n),n=e.nextPosition,s=o;function u(){let r=new to(h,n),o=r.root.document?l.version:null,u=new iw(r,t,s,i,o);e.batch.addOperation(u),a.applyOperation(u)}n instanceof te&&n!=h&&s!=i&&u()}function i3(e,t,i,r){let n,s;let o=e.model,a=o.document,l=r.getAttribute(t);if(l!=i){if(r.root===r){let e=r.document?a.version:null;s=new iv(r,t,l,i,e)}else{let o=(n=new to(te._createBefore(r),e.createPositionAfter(r))).root.document?a.version:null;s=new iw(n,t,l,i,o)}e.batch.addOperation(s),o.applyOperation(s)}}function i9(e,t,i,r,n){let s=e.model,o=s.document,a=new i_(t,i,r,s.markers,!!n,o.version);e.batch.addOperation(a),s.applyOperation(a)}function i2(e,t){return e===t||e instanceof iK&&t instanceof iK}function i7(e,t,i){let r=t.parent,n=i.parent;return!(r==n||e.isLimit(r)||e.isLimit(n))&&function(e,t,i){for(let r of new to(e,t).getWalker())if(i.isLimit(r.item))return!1;return!0}(t,i,e)}function i6(e,t,i,r={}){let n=e.createElement("paragraph");e.model.schema.setAllowedAttributes(n,r,e),e.insert(n,t),i4(e,i,e.createPositionAt(n,0))}function i4(e,t,i){t instanceof ty?e.setSelection(i):t.setTo(i)}function i5(e,t){let i=[];Array.from(e.getItems({direction:"backward"})).map(e=>t.createRangeOn(e)).filter(t=>(t.start.isAfter(e.start)||t.start.isEqual(e.start))&&(t.end.isBefore(e.end)||t.end.isEqual(e.end))).forEach(e=>{i.push(e.start.parent),t.remove(e)}),i.forEach(e=>{let i=e;for(;i.parent&&i.isEmpty;){let e=t.createRangeOn(i);i=i.parent,t.remove(e)}})}class i8{model;writer;position;canMergeWith;schema;_documentFragment;_documentFragmentPosition;_firstNode=null;_lastNode=null;_lastAutoParagraph=null;_filterAttributesOf=[];_affectedStart=null;_affectedEnd=null;_nodeToSelect=null;constructor(e,t,i){this.model=e,this.writer=t,this.position=i,this.canMergeWith=new Set([this.position.parent]),this.schema=e.schema,this._documentFragment=t.createDocumentFragment(),this._documentFragmentPosition=t.createPositionAt(this._documentFragment,0)}handleNodes(e){for(let t of Array.from(e))this._handleNode(t);this._insertPartialFragment(),this._lastAutoParagraph&&this._updateLastNodeFromAutoParagraph(this._lastAutoParagraph),this._mergeOnRight(),this.schema.removeDisallowedAttributes(this._filterAttributesOf,this.writer),this._filterAttributesOf=[]}_updateLastNodeFromAutoParagraph(e){let t=this.writer.createPositionAfter(this._lastNode),i=this.writer.createPositionAfter(e);if(i.isAfter(t)){if(this._lastNode=e,this.position.parent!=e||!this.position.isAtEnd)throw new r.Bb("insertcontent-invalid-insertion-position",this);this.position=i,this._setAffectedBoundaries(this.position)}}getSelectionRange(){return this._nodeToSelect?to._createOn(this._nodeToSelect):this.model.schema.getNearestSelectionRange(this.position)}getAffectedRange(){return this._affectedStart?new to(this._affectedStart,this._affectedEnd):null}destroy(){this._affectedStart&&this._affectedStart.detach(),this._affectedEnd&&this._affectedEnd.detach()}_handleNode(e){if(!this._checkAndSplitToAllowedPosition(e)){this.schema.isObject(e)||this._handleDisallowedNode(e);return}this._appendToFragment(e),this._firstNode||(this._firstNode=e),this._lastNode=e}_insertPartialFragment(){if(this._documentFragment.isEmpty)return;let e=iD.fromPosition(this.position,"toNext");this._setAffectedBoundaries(this.position),this._documentFragment.getChild(0)==this._firstNode&&(this.writer.insert(this._firstNode,this.position),this._mergeOnLeft(),this.position=e.toPosition()),this._documentFragment.isEmpty||this.writer.insert(this._documentFragment,this.position),this._documentFragmentPosition=this.writer.createPositionAt(this._documentFragment,0),this.position=e.toPosition(),e.detach()}_handleDisallowedNode(e){e.is("element")&&this.handleNodes(e.getChildren())}_appendToFragment(e){if(!this.schema.checkChild(this.position,e))throw new r.Bb("insertcontent-wrong-position",this,{node:e,position:this.position});this.writer.insert(e,this._documentFragmentPosition),this._documentFragmentPosition=this._documentFragmentPosition.getShiftedBy(e.offsetSize),this.schema.isObject(e)&&!this.schema.checkChild(this.position,"$text")?this._nodeToSelect=e:this._nodeToSelect=null,this._filterAttributesOf.push(e)}_setAffectedBoundaries(e){this._affectedStart||(this._affectedStart=iD.fromPosition(e,"toPrevious")),(!this._affectedEnd||this._affectedEnd.isBefore(e))&&(this._affectedEnd&&this._affectedEnd.detach(),this._affectedEnd=iD.fromPosition(e,"toNext"))}_mergeOnLeft(){let e=this._firstNode;if(!(e instanceof e4)||!this._canMergeLeft(e))return;let t=iD._createBefore(e);t.stickiness="toNext";let i=iD.fromPosition(this.position,"toNext");this._affectedStart.isEqual(t)&&(this._affectedStart.detach(),this._affectedStart=iD._createAt(t.nodeBefore,"end","toPrevious")),this._firstNode===this._lastNode&&(this._firstNode=t.nodeBefore,this._lastNode=t.nodeBefore),this.writer.merge(t),t.isEqual(this._affectedEnd)&&this._firstNode===this._lastNode&&(this._affectedEnd.detach(),this._affectedEnd=iD._createAt(t.nodeBefore,"end","toNext")),this.position=i.toPosition(),i.detach(),this._filterAttributesOf.push(this.position.parent),t.detach()}_mergeOnRight(){let e=this._lastNode;if(!(e instanceof e4)||!this._canMergeRight(e))return;let t=iD._createAfter(e);if(t.stickiness="toNext",!this.position.isEqual(t))throw new r.Bb("insertcontent-invalid-insertion-position",this);this.position=te._createAt(t.nodeBefore,"end");let i=iD.fromPosition(this.position,"toPrevious");this._affectedEnd.isEqual(t)&&(this._affectedEnd.detach(),this._affectedEnd=iD._createAt(t.nodeBefore,"end","toNext")),this._firstNode===this._lastNode&&(this._firstNode=t.nodeBefore,this._lastNode=t.nodeBefore),this.writer.merge(t),t.getShiftedBy(-1).isEqual(this._affectedStart)&&this._firstNode===this._lastNode&&(this._affectedStart.detach(),this._affectedStart=iD._createAt(t.nodeBefore,0,"toPrevious")),this.position=i.toPosition(),i.detach(),this._filterAttributesOf.push(this.position.parent),t.detach()}_canMergeLeft(e){let t=e.previousSibling;return t instanceof e4&&this.canMergeWith.has(t)&&this.model.schema.checkMerge(t,e)}_canMergeRight(e){let t=e.nextSibling;return t instanceof e4&&this.canMergeWith.has(t)&&this.model.schema.checkMerge(e,t)}_insertAutoParagraph(){this._insertPartialFragment();let e=this.writer.createElement("paragraph");this.writer.insert(e,this.position),this._setAffectedBoundaries(this.position),this._lastAutoParagraph=e,this.position=this.writer.createPositionAt(e,0)}_checkAndSplitToAllowedPosition(e){let t=this._getAllowedIn(this.position.parent,e);if(!t)return!1;for(t!=this.position.parent&&this._insertPartialFragment();t!=this.position.parent;)if(this.position.isAtStart){let e=this.position.parent;this.position=this.writer.createPositionBefore(e),e.isEmpty&&e.parent===t&&this.writer.remove(e)}else if(this.position.isAtEnd)this.position=this.writer.createPositionAfter(this.position.parent);else{let e=this.writer.createPositionAfter(this.position.parent);this._setAffectedBoundaries(this.position),this.writer.split(this.position),this.position=e,this.canMergeWith.add(this.position.nodeAfter)}return this.schema.checkChild(this.position.parent,e)||this._insertAutoParagraph(),!0}_getAllowedIn(e,t){return this.schema.checkChild(e,t)||this.schema.checkChild(e,"paragraph")&&this.schema.checkChild("paragraph",t)?e:this.schema.isLimit(e)?null:this._getAllowedIn(e.parent,t)}}class re extends(0,r.Re)(){markers;document;schema;_pendingChanges;_currentWriter;constructor(){super(),this.markers=new iZ,this.document=new iz(this),this.schema=new t1,this._pendingChanges=[],this._currentWriter=null,["deleteContent","modifySelection","getSelectedContent","applyOperation"].forEach(e=>this.decorate(e)),this.on("applyOperation",(e,t)=>{t[0]._validate()},{priority:"highest"}),this.schema.register("$root",{isLimit:!0}),this.schema.register("$container",{allowIn:["$root","$container"]}),this.schema.register("$block",{allowIn:["$root","$container"],isBlock:!0}),this.schema.register("$blockObject",{allowWhere:"$block",isBlock:!0,isObject:!0}),this.schema.register("$inlineObject",{allowWhere:"$text",allowAttributesOf:"$text",isInline:!0,isObject:!0}),this.schema.register("$text",{allowIn:"$block",isInline:!0,isContent:!0}),this.schema.register("$clipboardHolder",{allowContentOf:"$root",allowChildren:"$text",isLimit:!0}),this.schema.register("$documentFragment",{allowContentOf:"$root",allowChildren:"$text",isLimit:!0}),this.schema.register("$marker"),this.schema.addChildCheck(()=>!0,"$marker"),function(e){e.document.registerPostFixer(t=>(function(e,t){let i=t.document.selection,r=t.schema,n=[],s=!1;for(let e of i.getRanges()){let t=tz(e,r);t&&!t.isEqual(e)?(n.push(t),s=!0):n.push(e)}return s&&e.setSelection(function(e){let t=[...e],i=new Set,r=1;for(;r<t.length;){let e=t[r];for(let[n,s]of t.slice(0,r).entries())if(!i.has(n)){if(e.isEqual(s))i.add(n);else if(e.isIntersecting(s)){i.add(n),i.add(r);let o=e.getJoined(s);t.push(o)}}r++}return t.filter((e,t)=>!i.has(t))}(n),{backward:i.isBackward}),!1})(t,e))}(this),this.document.registerPostFixer(tD),this.on("insertContent",(e,[t,i])=>{var r;e.return=(r=this,r.change(e=>{let n;let s=i||r.document.selection;s.isCollapsed||r.deleteContent(s,{doNotAutoparagraph:!0});let o=new i8(r,e,s.anchor),a=[];if(t.is("documentFragment")){if(t.markers.size){let i=[];for(let[e,r]of t.markers){let{start:t,end:n}=r,s=t.isEqual(n);i.push({position:t,name:e,isCollapsed:s},{position:n,name:e,isCollapsed:s})}for(let{position:r,name:n,isCollapsed:s}of(i.sort(({position:e},{position:t})=>e.isBefore(t)?1:-1),i)){let i=null,o=null,l=r.parent===t&&r.isAtStart,h=r.parent===t&&r.isAtEnd;l||h?s&&(o=l?"start":"end"):(i=e.createElement("$marker"),e.insert(i,r)),a.push({name:n,element:i,collapsed:o})}}n=t.getChildren()}else n=[t];o.handleNodes(n);let l=o.getSelectionRange();if(t.is("documentFragment")&&a.length){let t=l?tp.fromRange(l):null,i={};for(let t=a.length-1;t>=0;t--){let{name:r,element:n,collapsed:s}=a[t],l=!i[r];if(l&&(i[r]=[]),n){let t=e.createPositionAt(n,"before");i[r].push(t),e.remove(n)}else{let e=o.getAffectedRange();if(!e){s&&i[r].push(o.position);continue}s?i[r].push(e[s]):i[r].push(l?e.start:e.end)}}for(let[t,[r,n]]of Object.entries(i))r&&n&&r.root===n.root&&r.root.document&&!e.model.markers.has(t)&&e.addMarker(t,{usingOperation:!0,affectsData:!0,range:new to(r,n)});t&&(l=t.toRange(),t.detach())}l&&(s instanceof ty?e.setSelection(l):s.setTo(l));let h=o.getAffectedRange()||r.createRange(s.anchor);return o.destroy(),h}))}),this.on("insertObject",(e,[t,i,n])=>{e.return=function(e,t,i,n={}){if(!e.schema.isObject(t))throw new r.Bb("insertobject-element-not-an-object",e,{object:t});let s=i||e.document.selection,o=s;n.findOptimalPosition&&e.schema.isBlock(t)&&(o=e.createSelection(e.schema.findOptimalInsertionRange(s,n.findOptimalPosition)));let a=(0,r.Ps)(s.getSelectedBlocks()),l={};return a&&Object.assign(l,e.schema.getAttributesWithProperty(a,"copyOnReplace",!0)),e.change(i=>{o.isCollapsed||e.deleteContent(o,{doNotAutoparagraph:!0});let s=t,a=o.anchor.parent;!e.schema.checkChild(a,t)&&e.schema.checkChild(a,"paragraph")&&e.schema.checkChild("paragraph",t)&&(s=i.createElement("paragraph"),i.insert(t,s)),e.schema.setAllowedAttributes(s,l,i);let h=e.insertContent(s,o);return h.isCollapsed||n.setSelection&&function(e,t,i,n){let s=e.model;if("on"==i){e.setSelection(t,"on");return}if("after"!=i)throw new r.Bb("insertobject-invalid-place-parameter-value",s);let o=t.nextSibling;if(s.schema.isInline(t)){e.setSelection(t,"after");return}!(o&&s.schema.checkChild(o,"$text"))&&s.schema.checkChild(t.parent,"paragraph")&&(o=e.createElement("paragraph"),s.schema.setAllowedAttributes(o,n,e),s.insertContent(o,e.createPositionAfter(t))),o&&e.setSelection(o,0)}(i,t,n.setSelection,l),h})}(this,t,i,n)}),this.on("canEditAt",e=>{let t=!this.document.isReadOnly;e.return=t,t||e.stop()})}change(e){try{if(0===this._pendingChanges.length)return this._pendingChanges.push({batch:new iq,callback:e}),this._runPendingChanges()[0];return e(this._currentWriter)}catch(e){r.Bb.rethrowUnexpectedError(e,this)}}enqueueChange(e,t){try{e?"function"==typeof e?(t=e,e=new iq):e instanceof iq||(e=new iq(e)):e=new iq,this._pendingChanges.push({batch:e,callback:t}),1==this._pendingChanges.length&&this._runPendingChanges()}catch(e){r.Bb.rethrowUnexpectedError(e,this)}}applyOperation(e){e._execute()}insertContent(e,t,i,...r){let n=rt(t,i);return this.fire("insertContent",[e,n,i,...r])}insertObject(e,t,i,r,...n){let s=rt(t,i);return this.fire("insertObject",[e,s,r,r,...n])}deleteContent(e,t){!function(e,t,i={}){if(t.isCollapsed)return;let r=t.getFirstRange();if("$graveyard"==r.root.rootName)return;let n=e.schema;e.change(e=>{if(!i.doNotResetEntireContent&&function(e,t){let i=e.getLimitElement(t);if(!t.containsEntireContent(i))return!1;let r=t.getFirstRange();return r.start.parent!=r.end.parent&&e.checkChild(i,"paragraph")}(n,t)){!function(e,t){let i=e.model.schema.getLimitElement(t);e.remove(e.createRangeIn(i)),i6(e,e.createPositionAt(i,0),t)}(e,t);return}let s={};if(!i.doNotAutoparagraph){let e=t.getSelectedElement();e&&Object.assign(s,n.getAttributesWithProperty(e,"copyOnReplace",!0))}let[o,a]=function(e){let t=e.root.document.model,i=e.start,r=e.end;if(t.hasContent(e,{ignoreMarkers:!0})){let i=function(e){let t=e.parent,i=t.root.document.model.schema;for(let e of t.getAncestors({parentFirst:!0,includeSelf:!0})){if(i.isLimit(e))return null;if(i.isBlock(e))return e}}(r);if(i&&r.isTouching(t.createPositionAt(i,0))){let i=t.createSelection(e);t.modifySelection(i,{direction:"backward"});let n=i.getLastPosition(),s=t.createRange(n,r);t.hasContent(s,{ignoreMarkers:!0})||(r=n)}}return[iD.fromPosition(i,"toPrevious"),iD.fromPosition(r,"toNext")]}(r);o.isTouching(a)||e.remove(e.createRange(o,a)),i.leaveUnmerged||(function(e,t,i){let r=e.model;if(!i7(e.model.schema,t,i))return;let[n,s]=function(e,t){let i=e.getAncestors(),r=t.getAncestors(),n=0;for(;i[n]&&i[n]==r[n];)n++;return[i[n],r[n]]}(t,i);n&&s&&(!r.hasContent(n,{ignoreMarkers:!0})&&r.hasContent(s,{ignoreMarkers:!0})?function e(t,i,r,n){let s=i.parent,o=r.parent;if(s!=n&&o!=n){for(i=t.createPositionAfter(s),(r=t.createPositionBefore(o)).isEqual(i)||t.insert(s,r);i.parent.isEmpty;){let e=i.parent;i=t.createPositionBefore(e),t.remove(e)}r=t.createPositionBefore(o),function(e,t){let i=t.nodeBefore,r=t.nodeAfter;i.name!=r.name&&e.rename(i,r.name),e.clearAttributes(i),e.setAttributes(Object.fromEntries(r.getAttributes()),i),e.merge(t)}(t,r),i7(t.model.schema,i,r)&&e(t,i,r,n)}}(e,t,i,n.parent):function e(t,i,r,n){let s=i.parent,o=r.parent;if(s!=n&&o!=n){for(i=t.createPositionAfter(s),(r=t.createPositionBefore(o)).isEqual(i)||t.insert(o,i),t.merge(i);r.parent.isEmpty;){let e=r.parent;r=t.createPositionBefore(e),t.remove(e)}i7(t.model.schema,i,r)&&e(t,i,r,n)}}(e,t,i,n.parent))}(e,o,a),n.removeDisallowedAttributes(o.parent.getChildren(),e)),i4(e,t,o),!i.doNotAutoparagraph&&function(e,t){let i=e.checkChild(t,"$text"),r=e.checkChild(t,"paragraph");return!i&&r}(n,o)&&i6(e,o,t,s),o.detach(),a.detach()})}(this,e,t)}modifySelection(e,t){!function(e,t,i={}){let n;let s=e.schema,o="backward"!=i.direction,a=i.unit?i.unit:"character",l=!!i.treatEmojiAsSingleUnit,h=new e5({boundaries:function(e,t){let i=e.root,r=te._createAt(i,t?"end":0);return t?new to(e,r):new to(r,e)}(t.focus,o),singleCharacters:!0,direction:o?"forward":"backward"}),u={walker:h,schema:s,isForward:o,unit:a,treatEmojiAsSingleUnit:l};for(;n=h.next();){if(n.done)return;let i=function(e,t){let{isForward:i,walker:n,unit:s,schema:o,treatEmojiAsSingleUnit:a}=e,{type:l,item:h,nextPosition:u}=t;if("text"==l)return"word"===e.unit?function(e,t){let i=e.position.textNode;for(i||(i=t?e.position.nodeAfter:e.position.nodeBefore);i&&i.is("$text");){var r,n;let s=e.position.offset-i.startOffset;if(r=i,s===(t?r.offsetSize:0))i=t?e.position.nodeAfter:e.position.nodeBefore;else{if(n=i.data,' ,.?!:;"-()'.includes(n.charAt(s+(t?0:-1))))break;e.next()}}return e.position}(n,i):function(e,t,i){let n=e.position.textNode;if(n){let s=n.data,o=e.position.offset-n.startOffset;for(;(0,r.to)(s,o)||"character"==t&&(0,r.pp)(s,o)||i&&(0,r.YK)(s,o);)e.next(),o=e.position.offset-n.startOffset}return e.position}(n,s,a);if(l==(i?"elementStart":"elementEnd")){if(o.isSelectable(h))return te._createAt(h,i?"after":"before");if(o.checkChild(u,"$text"))return u}else{if(o.isLimit(h)){n.skip(()=>!0);return}if(o.checkChild(u,"$text"))return u}}(u,n.value);if(i){t instanceof ty?e.change(e=>{e.setSelectionFocus(i)}):t.setFocus(i);return}}}(this,e,t)}getSelectedContent(e){return this.change(t=>{let i;let r=t.createDocumentFragment(),n=e.getFirstRange();if(!n||n.isCollapsed)return r;let s=n.start.root,o=n.start.getCommonPath(n.end),a=s.getNodeByPath(o),l=(i=n.start.parent==n.end.parent?n:t.createRange(t.createPositionAt(a,n.start.path[o.length]),t.createPositionAt(a,n.end.path[o.length]+1))).end.offset-i.start.offset;for(let e of i.getItems({shallow:!0}))e.is("$textProxy")?t.appendText(e.data,e.getAttributes(),r):t.append(t.cloneElement(e,!0),r);if(i!=n){let e=n._getTransformedByMove(i.start,t.createPositionAt(r,0),l)[0],s=t.createRange(t.createPositionAt(r,0),e.start);i5(t.createRange(e.end,t.createPositionAt(r,"end")),t),i5(s,t)}return r})}hasContent(e,t={}){let i=e instanceof to?e:to._createIn(e);if(i.isCollapsed)return!1;let{ignoreWhitespaces:r=!1,ignoreMarkers:n=!1}=t;if(!n){for(let e of this.markers.getMarkersIntersectingRange(i))if(e.affectsData)return!0}for(let e of i.getItems())if(this.schema.isContent(e)&&(!e.is("$textProxy")||!r||-1!==e.data.search(/\S/)))return!0;return!1}canEditAt(e){let t=rt(e);return this.fire("canEditAt",[t])}createPositionFromPath(e,t,i){return new te(e,t,i)}createPositionAt(e,t){return te._createAt(e,t)}createPositionAfter(e){return te._createAfter(e)}createPositionBefore(e){return te._createBefore(e)}createRange(e,t){return new to(e,t)}createRangeIn(e){return to._createIn(e)}createRangeOn(e){return to._createOn(e)}createSelection(...e){return new tc(...e)}createBatch(e){return new iq(e)}createOperationFromJSON(e){return iC.fromJSON(e,this.document)}destroy(){this.document.destroy(),this.stopListening()}_runPendingChanges(){let e=[];this.fire("_beforeChanges");try{for(;this._pendingChanges.length;){let t=this._pendingChanges[0].batch;this._currentWriter=new i0(this,t);let i=this._pendingChanges[0].callback(this._currentWriter);e.push(i),this.document._handleChangeBlock(this._currentWriter),this._pendingChanges.shift(),this._currentWriter=null}}finally{this._pendingChanges.length=0,this._currentWriter=null,this.fire("_afterChanges")}return e}}function rt(e,t){if(e)return e instanceof tc||e instanceof ty?e:e instanceof e9?t||0===t?new tc(e,t):e.is("rootElement")?new tc(e,"in"):new tc(e,"on"):new tc(e)}class ri extends eW{domEventType="click";onDomEvent(e){this.fire(e.type,e)}}class rr extends eW{domEventType=["mousedown","mouseup","mouseover","mouseout"];onDomEvent(e){this.fire(e.type,e)}}class rn{document;constructor(e){this.document=e}createDocumentFragment(e){return new el(this.document,e)}createElement(e,t,i){return new M(this.document,e,t,i)}createText(e){return new A(this.document,e)}clone(e,t=!1){return e._clone(t)}appendChild(e,t){return t._appendChild(e)}insertChild(e,t,i){return i._insertChild(e,t)}removeChildren(e,t,i){return i._removeChildren(e,t)}remove(e){let t=e.parent;return t?this.removeChildren(t.getChildIndex(e),1,t):[]}replace(e,t){let i=e.parent;if(i){let r=i.getChildIndex(e);return this.removeChildren(r,1,i),this.insertChild(r,t,i),!0}return!1}unwrapElement(e){let t=e.parent;if(t){let i=t.getChildIndex(e);this.remove(e),this.insertChild(i,e.getChildren(),t)}}rename(e,t){let i=new M(this.document,e,t.getAttributes(),t.getChildren());return this.replace(t,i)?i:null}setAttribute(e,t,i){i._setAttribute(e,t)}removeAttribute(e,t){t._removeAttribute(e)}addClass(e,t){t._addClass(e)}removeClass(e,t){t._removeClass(e)}setStyle(e,t,i){(0,s.Z)(e)&&void 0===i?t._setStyle(e):i._setStyle(e,t)}removeStyle(e,t){t._removeStyle(e)}setCustomProperty(e,t,i){i._setCustomProperty(e,t)}removeCustomProperty(e,t){return t._removeCustomProperty(e)}createPositionAt(e,t){return q._createAt(e,t)}createPositionAfter(e){return q._createAfter(e)}createPositionBefore(e){return q._createBefore(e)}createRange(e,t){return new L(e,t)}createRangeOn(e){return L._createOn(e)}createRangeIn(e){return L._createIn(e)}createSelection(...e){return new j(...e)}}let rs=/^#([0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/i,ro=/^rgb\([ ]?([0-9]{1,3}[ %]?,[ ]?){2,3}[0-9]{1,3}[ %]?\)$/i,ra=/^rgba\([ ]?([0-9]{1,3}[ %]?,[ ]?){3}(1|[0-9]+%|[0]?\.?[0-9]+)\)$/i,rl=/^hsl\([ ]?([0-9]{1,3}[ %]?[,]?[ ]*){3}(1|[0-9]+%|[0]?\.?[0-9]+)?\)$/i,rh=/^hsla\([ ]?([0-9]{1,3}[ %]?,[ ]?){2,3}(1|[0-9]+%|[0]?\.?[0-9]+)\)$/i,ru=/\w+\((?:[^()]|\([^()]*\))*\)|\S+/gi,rd=new Set(["black","silver","gray","white","maroon","red","purple","fuchsia","green","lime","olive","yellow","navy","blue","teal","aqua","orange","aliceblue","antiquewhite","aquamarine","azure","beige","bisque","blanchedalmond","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkgrey","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dimgrey","dodgerblue","firebrick","floralwhite","forestgreen","gainsboro","ghostwhite","gold","goldenrod","greenyellow","grey","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgray","lightgreen","lightgrey","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightslategrey","lightsteelblue","lightyellow","limegreen","linen","magenta","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","oldlace","olivedrab","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","skyblue","slateblue","slategray","slategrey","snow","springgreen","steelblue","tan","thistle","tomato","turquoise","violet","wheat","whitesmoke","yellowgreen","activeborder","activecaption","appworkspace","background","buttonface","buttonhighlight","buttonshadow","buttontext","captiontext","graytext","highlight","highlighttext","inactiveborder","inactivecaption","inactivecaptiontext","infobackground","infotext","menu","menutext","scrollbar","threeddarkshadow","threedface","threedhighlight","threedlightshadow","threedshadow","window","windowframe","windowtext","rebeccapurple","currentcolor","transparent"]);function rc(e){return e.startsWith("#")?rs.test(e):e.startsWith("rgb")?ro.test(e)||ra.test(e):e.startsWith("hsl")?rl.test(e)||rh.test(e):rd.has(e.toLowerCase())}let rf=/^([+-]?[0-9]*([.][0-9]+)?(px|cm|mm|in|pc|pt|ch|em|ex|rem|vh|vw|vmin|vmax)|0)$/;function rm(e){return rf.test(e)}let rg=/^[+-]?[0-9]*([.][0-9]+)?%$/;function rp(e){return rg.test(e)}let r_=["repeat-x","repeat-y","repeat","space","round","no-repeat"],rw=["center","top","bottom","left","right"],rb=["fixed","scroll","local"],ry=/^url\(/;function rv(e){return Array.from(e.trim().slice(0,1500).matchAll(ru)).map(e=>e[0])}function rP(e){e.setNormalizer("background",e=>{let t={};for(let i of rv(e))r_.includes(i)?(t.repeat=t.repeat||[],t.repeat.push(i)):rw.includes(i)?(t.position=t.position||[],t.position.push(i)):rb.includes(i)?t.attachment=i:rc(i)?t.color=i:ry.test(i)&&(t.image=i);return{path:"background",value:t}}),e.setNormalizer("background-color",e=>({path:"background.color",value:e})),e.setReducer("background",e=>{let t=[];return t.push(["background-color",e.color]),t}),e.setStyleRelation("background",["background-color"])}function rA(e){var t;e.setNormalizer("margin",e=>({path:"margin",value:function(e=""){if(""===e)return{top:void 0,right:void 0,bottom:void 0,left:void 0};let t=rv(e),i=t[0],r=t[2]||i,n=t[1]||i,s=t[3]||n;return{top:i,bottom:r,right:n,left:s}}(e)})),e.setNormalizer("margin-top",e=>({path:"margin.top",value:e})),e.setNormalizer("margin-right",e=>({path:"margin.right",value:e})),e.setNormalizer("margin-bottom",e=>({path:"margin.bottom",value:e})),e.setNormalizer("margin-left",e=>({path:"margin.left",value:e})),e.setReducer("margin",(t="margin",e=>{let{top:i,right:r,bottom:n,left:s}=e,o=[];return[i,r,s,n].every(e=>!!e)?o.push([t,function({top:e,right:t,bottom:i,left:r}){let n=[];return r!==t?n.push(e,t,i,r):i!==e?n.push(e,t,i):t!==e?n.push(e,t):n.push(e),n.join(" ")}(e)]):(i&&o.push([t+"-top",i]),r&&o.push([t+"-right",r]),n&&o.push([t+"-bottom",n]),s&&o.push([t+"-left",s])),o})),e.setStyleRelation("margin",["margin-top","margin-right","margin-bottom","margin-left"])}let rC={container:B,attribute:X,empty:ei,ui:en,raw:eo},rk={setContentOf:(e,t)=>{e.innerHTML=t}}}}]);